<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Pol√≠ticas de Seguridad -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; 
                 script-src 'self' 'unsafe-inline'; 
                 style-src 'self' 'unsafe-inline'; 
                 img-src 'self' data: https:; 
                 font-src 'self' data:; 
                 connect-src 'self'; 
                 object-src 'none'; 
                 base-uri 'self'; 
                 form-action 'self'; 
                 frame-ancestors 'none'; 
                 upgrade-insecure-requests;">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="no-referrer">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="./icon.svg">
    <title>Horarios</title>
    <style>
        :root {
            /* --- Variables de Color (Tema Claro) --- */
            --bg-body: #ffffff;
            --bg-card: #f0f4f9;
            --bg-header: #ffffff;
            --text-main: #1f1f1f;
            --text-muted: #444746 --text-inv: #ffffff;
            --border: #dde3ea;
            --input-bg: #dde3ea;
            --input-focus: #dde3ea;
            --c-blue: rgba(76, 114, 172, 0.8);
            --c-green: rgba(76, 172, 140, 0.8);
            --c-red: rgba(172, 90, 76, 0.8);
            --c-purple: rgba(129, 76, 172, 0.8);
            --c-gold: rgba(172, 155, 76, 0.8);
            --c-gray-btn: #dde3ea;
            --c-white: #ffffff;
            --hover: #989ca0;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --radius: 20px;
        }

        body.dark-mode {
            /* --- Variables de Color (Tema Oscuro) --- */
            --bg-body: #131314;
            --bg-card: #1e1f20;
            --bg-header: #131314f6;
            --text-main: #e3e3e3;
            --text-muted: #b4b4b4;
            --border: #313333;
            --input-bg: #313333;
            --input-focus: #313333;
            --c-gray-btn: #313333;
            --hover: #696e6d;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        body.modal-open {
            overflow: hidden !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            scrollbar-gutter: stable;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            overflow-anchor: none;
            transition: background 0.3s, color 0.3s;
            overflow-y: auto;
        }

        /* --- Layout & Contenedores --- */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0.5rem;
        }

        .header {
            background: var(--bg-header);
            backdrop-filter: blur(10px);
            padding: 0.6rem;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 90;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.25rem;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
            margin-right: auto;
            margin-left: 1rem;
        }

        .card,
        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 1.5rem 0.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            color: var(--text-main);
        }

        .card h2,
        .modal h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-main);
        }

        .modal h3 .version-text {
            margin-left: auto;
        }

        .card h2.no-margin {
            margin-bottom: 0;
        }

        /* --- Scrollbar Reutilizable (Clase Utilitaria) --- */
        .custom-scroll {
            overflow-y: auto;
            overflow-x: hidden;
        }

        .custom-scroll::-webkit-scrollbar,
        .perfil-list-container::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scroll::-webkit-scrollbar-track,
        .perfil-list-container::-webkit-scrollbar-track {
            background: var(--bg-body);
            border-radius: var(--radius);
        }

        .custom-scroll::-webkit-scrollbar-thumb,
        .perfil-list-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: var(--radius);
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover,
        .perfil-list-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* --- Iconos --- */
        .icon {
            width: 1.2em;
            height: 1.2em;
            vertical-align: text-bottom;
            fill: currentColor;
            stroke: currentColor;
            stroke-width: 0;
        }

        .icon-line {
            stroke-width: 2;
            fill: none;
        }

        /* --- Formularios --- */
        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-muted);
            margin: 0 0 0.25rem 0.5rem;
            transition: opacity 0.3s ease, transform 0.3s ease, color 0.3s ease;
            min-height: 1.2em;
            line-height: 1.2;
            will-change: transform, opacity;
        }

        input,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            background: var(--input-bg);
            color: var(--text-main);
            height: 48px;
            transition: border-color 0.2s, transform 0.3s, background 0.3s;
        }

        input:disabled,
        select:disabled {
            background-color: var(--bg-card);
            color: var(--text-muted);
            opacity: 1;
            -webkit-text-fill-color: var(--text-muted);
            /* Correcci√≥n para Safari/iOS */
            cursor: not-allowed;
        }

        input:focus,
        select:focus {
            outline: none;
        }

        input.error {
            border-color: var(--c-red);
        }

        .input-error {
            color: var(--c-red);
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }

        .input-with-btn,
        .input-number-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .contenedor-fechas {
            display: block;
            flex-direction: column;
        }

        .input-number-group input {
            text-align: center;
        }

        .contenedor-fechas .form-group {
            flex-grow: 1;
        }

        /* --- Botones --- */
        button {
            width: 100%;
            padding: 0.875rem;
            border: 1px solid transparent;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--text-main);
            background: var(--c-gray-btn);
        }

        button:active {
            transform: scale(1);
        }

        button:disabled {
            background: transparent;
            cursor: not-allowed;
            transform: none;
            color: #6b7280;
        }

        #btn-timer-main {
            border: none;
        }

        #btn-timer-main:disabled {
            display: none;
        }

        /* Variantes de botones */

        .btn-register {
            width: auto;
            padding: 17px;
            margin: -17px;
            background: transparent;
            color: var(--text-main);
        }

        .btn-register .icon {
            animation: llamarAtencion 5s ease-in-out 1.2s 2;
            transform-origin: bottom;
        }

        .icon-btn,
        .time-btn,
        .btn-increment,
        .filter-btn {
            width: auto;
            padding: 0.5rem;
            min-width: 44px;
            height: 44px;
            color: var(--text-main);
            touch-action: manipulation;
        }

        .icon-btn,
        .filter-btn {
            background: transparent;
        }

        .filter-btn.filtro-activo {
            color: var(--c-red);
            border-color: var(--c-red);
        }

        .header-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            align-items: center;
        }

        .config-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* --- Stats & Progreso --- */
        .stats-card {
            cursor: pointer;
            transition: transform 0.15s ease-out, opacity 0.15s ease-out, box-shadow 0.3s !important;
            border: 1px solid transparent;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }

        #stats-card.timer-running {
            border-left-color: var(--c-red) !important;
        }

        .stats-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        /* Animaci√≥n de contenido interno de stats-card */
        .stats-card-content {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .stats-card-content.fade-out {
            opacity: 0;
            transform: translateY(-10px);
        }

        /* Estados del borde lateral */
        .stats-card.border-blue {
            border-left-color: var(--c-blue) !important;
        }

        .stats-card.border-green {
            border-left-color: var(--c-green) !important;
        }

        .stats-card.border-red {
            border-left-color: var(--c-red) !important;
        }

        .stats-card.border-purple {
            border-left-color: var(--c-purple) !important;
        }

        .stats-card.border-transparent {
            border-left-color: transparent !important;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: transparent;
            border-radius: var(--radius);
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--bg-card);
            transition: width 0.5s;
        }

        .progress-fill.blue {
            background: var(--c-blue) !important;
        }

        .progress-fill.green {
            background: var(--c-green) !important;
        }

        .progress-fill.red {
            background: var(--c-red) !important;
        }

        .progress-fill.purple {
            background: var(--c-purple) !important;
        }

        .progress-fill.gold {
            background: var(--c-gold) !important;
        }

        /* --- Lista de Registros --- */
        .registro-item {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: start;
            cursor: pointer;
            background: var(--input-bg);
            content-visibility: auto;
            contain-intrinsic-size: 85px;
        }

        .registro-item.hoy::before {
            content: "HOY";
            position: absolute;
            bottom: 8px;
            right: 8px;
            border: 2px solid var(--text-main);
            color: var(--text-main);
            font-size: 0.75rem;
            font-weight: 700;
            padding: 0.1rem 1rem 0.1rem 1rem;
            border-radius: var(--radius);
            letter-spacing: 0.5px;
        }

        .registro-info {
            flex: 1;
        }

        .registro-fecha {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-main);
        }

        .registro-horas {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .registro-total {
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.25rem;
            color: var(--c-white);
            display: inline-block;
            border-radius: var(--radius);
            padding: .1rem 1rem .1rem 1rem;
        }

        .registro-total.green-text {
            background: var(--c-green);
        }

        .registro-total.red-text {
            background: var(--c-red);
        }

        .registro-total.purple-text {
            background: var(--c-purple);
        }

        .registro-total.yellow-text {
            background: var(--c-gold);
        }

        .registro-total.blue-text {
            background: var(--c-blue);
        }

        /* --- Modal & Utilidades --- */
        .modal {
            display: flex;
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }

        .modal.show {
            visibility: visible;
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            max-width: 450px;
            width: 100%;
        }

        .modal-title-block {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toast {
            position: fixed;
            top: 5rem;
            right: 2rem;
            background: #1f2937;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.3s;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            white-space: pre-line;
            pointer-events: none;
            backdrop-filter: blur(3px);
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .toast.success {
            background: var(--c-green);
        }

        .toast.info {
            background: var(--c-blue);
        }

        .toast.error,
        .toast.warning {
            background: var(--c-red);
        }

        /* --- Animaciones y Textos --- */
        @keyframes slideDownFade {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes llamarAtencion {
            0% {
                transform: scale(1, 1);
            }

            5% {
                transform: scale(1.25, 0.75);
            }

            /* Se aplasta */
            10% {
                transform: scale(0.75, 1.25);
            }

            /* Se estira */
            15% {
                transform: scale(1.15, 0.85);
            }

            /* Rebote suave */
            20% {
                transform: scale(1, 1);
            }

            /* Normal */

            100% {
                transform: scale(1, 1);
            }
        }

        @keyframes fade-blur {
            from {
                opacity: 0;
                filter: blur(5px);
                background-color: var(--c-green)
            }

            to {
                opacity: 1;
                filter: blur(0);
            }
        }

        @keyframes fade-blur-out {
            from {
                opacity: 1;
                filter: blur(0);
                transform: scale(1);
                background-color: var(--c-red)
            }

            to {
                opacity: 0;
                filter: blur(10px);
                transform: scale(0.8);
            }
        }

        /* Animaci√≥n de pulso espec√≠fica para la tarjeta (m√°s suave) */
        @keyframes pulse-card {
            0% {
                box-shadow: 0 0 0 0 rgba(192, 93, 118, 0.4);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(192, 93, 118, 0);
                /* Expansi√≥n de la sombra */
            }

            100% {
                box-shadow: 0 0 0 0 rgba(192, 93, 118, 0);
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(192, 93, 118, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(192, 93, 118, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(192, 93, 118, 0);
            }
        }

        .animated-card {
            animation: slideDownFade 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) backwards;
        }

        .toggle-hint,
        .config-hint-text,
        .version-text {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: right;
            display: block;
            margin-top: 0.25rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }

        /* --- Estad√≠sticas Grid --- */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        /* --- Colapso de formulario --- */
        .form-collapsible {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
        }

        .form-collapsible.expanded {
            max-height: 1000px;
            opacity: 1;
            transition: all 0.3s;
        }

        .collapse-toggle {
            cursor: pointer;
            transition: transform 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .collapse-toggle.rotated {
            transform: rotate(180deg);
        }

        /* Animaci√≥n al crear y eliminar registro */

        .nuevo-registro-animacion {
            animation: fade-blur 0.5s ease-out forwards;
            transform-origin: center;
            z-index: 10;
            position: relative;
        }

        /* Animaci√≥n del boton tiempo fuera*/

        .timer-btn.running {
            color: var(--c-red);
            border-color: var(--c-red);
            animation: pulse 2s infinite;
        }

        /* Estilos para cabeceras colapsables */
        .card-header-clickable {
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            position: relative;
            transition: transform 0.3s;
        }

        .chevron {
            transition: transform 0.3s ease;
            position: absolute;
            right: 0;
        }

        .chevron.rotated {
            transform: rotate(180deg);
        }

        /* Estilos para meses colapsables */
        .registro-mes-container {
            margin: 0;
            scroll-margin-top: 5rem;
        }

        .registro-mes-header {
            margin: 1rem 0rem;
            color: var(--text-muted);
            font-size: 18px;
            transition: color 0.2s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .registro-mes-header:hover {
            color: var(--text-main);
        }

        .registro-mes-detalle {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }

        .registro-mes-detalle.expanded {
            max-height: 3500px;
            opacity: 1;
        }

        .chevron-mes {
            width: 1em;
            height: 1em;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }

        /* Bot√≥n de perfil en el Header */
        .header-profile-btn {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.25rem 0.75rem;
            color: var(--text-main);
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            width: auto;
            max-width: 160px;
        }



        .header-profile-btn span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

        /* Lista de perfiles en el modal */
        .perfil-list-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 5px;
        }

        .btn-perfil-select {
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 1rem;
            text-align: left;
            border-radius: var(--radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn-perfil-select.activo {
            border-color: var(--c-green);
            background: rgba(96, 172, 148, 0.1);
            font-weight: bold;
        }

        .btn-perfil-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            pointer-events: none;
        }

        .btn-perfil-nombre {
            font-size: 1rem;
            font-weight: 600;
        }

        .btn-perfil-badge {
            font-size: 0.8rem;
            color: var(--c-green);
        }

        .btn-perfil-edit {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 0.5rem;
            min-width: 40px;
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .btn-perfil-edit .icon {
            width: 1em;
            height: 1em;
            font-size: 18px;
        }

        /* Transici√≥n suave entre modos */
        #modo-normal,
        #modo-lote {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Transici√≥n suave entre meses en estad√≠sticas */
        #form-stats {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, transform 0.3s ease;
        }

        #modo-normal.fade-out,
        #modo-lote.fade-out,
        #form-stats.fade-out {
            opacity: 0;
            transform: translateY(-10px);
        }

        .separador-semana {
            height: 0;
            background: transparent;
            margin: 1.5rem auto;
            border: none;
            width: 100%;
        }

        /* --- Selector de D√≠as Semanales --- */
        .week-selector {
            display: flex;
            justify-content: space-between;
            gap: 5px;
            margin-bottom: 0.5rem;
        }

        .day-checkbox {
            position: relative;
            cursor: pointer;
        }

        .day-checkbox input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .day-checkbox span {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .day-checkbox input:checked~span {
            background: rgba(96, 172, 148, 0.1);
            color: var(--c-green);
            border: 1px solid var(--c-green);
            font-weight: bold;
            transform: scale(1.1);
        }

        /* Estado colapsado de botones hist√≥rico */
        #botones-historico {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s ease-out, margin 0.3s ease-out;
            padding-top: 0;
            margin-bottom: 0;
        }

        #botones-historico.expanded {
            max-height: 100px;
            opacity: 1;
            padding-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        /* Hist√≥rico necesita m√°s altura que las otras tarjetas */
        #contenido-historico.expanded {
            max-height: 5000px;
        }

        /* Animaci√≥n de feedback en inputs de registro */
        .input-agregado-animacion {
            animation: fade-blur 0.5s ease-out forwards;
        }

        /* moviles */
        @media (min-width: 500px) {
            .header-profile-btn {
                max-width: 300px;
            }
        }

        /* --- Hovers de botones --- */
        @media (hover: hover) and (pointer: fine) {

            .icon-btn:hover:not(:disabled),
            .time-btn:hover:not(:disabled),
            .btn-increment:hover:not(:disabled),
            .filter-btn:hover:not(:disabled),
            .btn-delete:hover:not(:disabled),
            .btn-cancel:hover:not(:disabled),
            .btn-export:hover:not(:disabled),
            .btn-backup:hover:not(:disabled),
            .btn-edit:hover:not(:disabled),
            .registro-item:hover,
            .header-profile-btn:hover,
            .btn-perfil-select:hover,
            .day-checkbox:hover span,
            .btn-perfil-edit:hover {
                border: 1px solid var(--hover);
            }
        }

        @media (min-width: 1024px) {
            .container {
                display: grid;
                grid-template-columns: minmax(350px, 1fr) minmax(400px, 1fr);
                gap: 1.5rem;
                align-items: start;
                padding: 1.5rem;
            }

            .left-column {
                display: flex;
                flex-direction: column;
            }

            .right-column {
                position: sticky;
                top: 4.5rem;
            }

            #lista-registros {
                max-height: 1100px;
                overflow-y: auto;
                padding-right: 0.5rem;
                scrollbar-gutter: stable;
            }

            .card,
            .modal-content {
                padding: 1.5rem 1rem 1.5rem 1rem;
            }
        }
    </style>
</head>

<body>
    <script>
        (function () { //Evitar parpadeo al actualizar, (modo oscuro)
            try {
                var stored = localStorage.getItem('temaOscuro');
                if (stored === 'true' || stored === null) {
                    document.body.classList.add('dark-mode');
                }
            } catch (e) { }
        })();
    </script>
    <svg style="display: none;">
        <symbol id="icon-moon" viewBox="0 0 24 24">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" class="icon-line" stroke-width="2"
                stroke="currentColor" fill="none"></path>
        </symbol>
        <symbol id="icon-sun" viewBox="0 0 24 24">
            <g class="icon-line" stroke-width="2" stroke="currentColor">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </g>
        </symbol>
        <symbol id="icon-combine" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 6h4l4 6h8" class="icon-line"></path>
            <path d="M4 18h4l4-6" class="icon-line"></path>
        </symbol>
        <symbol id="icon-replace-swap" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="17 4 21 8 17 12"></polyline>
            <line x1="3" y1="8" x2="21" y2="8"></line>
            <polyline points="7 20 3 16 7 12"></polyline>
            <line x1="21" y1="16" x2="3" y2="16"></line>
        </symbol>
        <symbol id="icon-replace-overwrite" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <rect x="4" y="8" width="16" height="8" rx="2"></rect>
            <line x1="12" y1="2" x2="12" y2="8"></line>
            <polyline points="9 5 12 8 15 5"></polyline>
            <line x1="12" y1="16" x2="12" y2="22"></line>
            <polyline points="9 19 12 22 15 19"></polyline>
        </symbol>
        <symbol id="icon-replace-cycle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 10c0-4.4 3.6-8 8-8s8 3.6 8 8"></path>
            <polyline points="4 6 4 10 8 10"></polyline>
            <path d="M20 14c0 4.4-3.6 8-8 8s-8-3.6-8-8"></path>
            <polyline points="20 18 20 14 16 14"></polyline>
        </symbol>
        <symbol id="icon-settings" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path
                d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z">
            </path>
        </symbol>
        <symbol id="icon-clock" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" class="icon-line" stroke="currentColor"></circle>
            <polyline points="12 6 12 12 16 14" class="icon-line" stroke="currentColor"></polyline>
        </symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24">
            <polyline points="3 6 5 6 21 6" class="icon-line" stroke="currentColor"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" class="icon-line"
                stroke="currentColor"></path>
        </symbol>
        <symbol id="icon-save" viewBox="0 0 24 24">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" class="icon-line"
                stroke="currentColor"></path>
            <polyline points="17 21 17 13 7 13 7 21" class="icon-line" stroke="currentColor"></polyline>
            <polyline points="7 3 7 8 15 8" class="icon-line" stroke="currentColor"></polyline>
        </symbol>
        <symbol id="icon-broom" viewBox="0 0 24 24">
            <path class="icon-line"
                d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14zM8 11v6M12 11v6M16 11v6M10 3L9 6h6l-1-3" />
        </symbol>
        <symbol id="icon-download" viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" class="icon-line" stroke="currentColor"></path>
            <polyline points="7 10 12 15 17 10" class="icon-line" stroke="currentColor"></polyline>
            <line x1="12" y1="15" x2="12" y2="3" class="icon-line" stroke="currentColor"></line>
        </symbol>
        <symbol id="icon-upload" viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" class="icon-line" stroke="currentColor"></path>
            <polyline points="17 8 12 3 7 8" class="icon-line" stroke="currentColor"></polyline>
            <line x1="12" y1="3" x2="12" y2="15" class="icon-line" stroke="currentColor"></line>
        </symbol>
        <symbol id="icon-edit" viewBox="0 0 24 24">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" class="icon-line"
                stroke="currentColor"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" class="icon-line" stroke="currentColor">
            </path>
        </symbol>
        <symbol id="icon-list" viewBox="0 0 24 24">
            <line x1="8" y1="6" x2="21" y2="6" class="icon-line" stroke="currentColor"></line>
            <line x1="8" y1="12" x2="21" y2="12" class="icon-line" stroke="currentColor"></line>
            <line x1="8" y1="18" x2="21" y2="18" class="icon-line" stroke="currentColor"></line>
            <line x1="3" y1="6" x2="3.01" y2="6" class="icon-line" stroke="currentColor"></line>
            <line x1="3" y1="12" x2="3.01" y2="12" class="icon-line" stroke="currentColor"></line>
            <line x1="3" y1="18" x2="3.01" y2="18" class="icon-line" stroke="currentColor"></line>
        </symbol>
        <symbol id="icon-cancelar" viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18" class="icon-line" stroke="currentColor"></line>
            <line x1="6" y1="6" x2="18" y2="18" class="icon-line" stroke="currentColor"></line>
        </symbol>
        <symbol id="icon-undo" viewBox="0 0 24 24">
            <path d="M3 7v6h6" class="icon-line" stroke="currentColor"></path>
            <path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13" class="icon-line" stroke="currentColor"></path>
        </symbol>
        <symbol id="icon-redo" viewBox="0 0 24 24">
            <path d="M21 7v6h-6" class="icon-line" stroke="currentColor"></path>
            <path d="M3 17a9 9 0 019-9 9 9 0 016 2.3L21 13" class="icon-line" stroke="currentColor"></path>
        </symbol>
        <symbol id="icon-calendar-simple" viewBox="0 0 24 24">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" class="icon-line" stroke="currentColor"></rect>
            <line x1="16" y1="2" x2="16" y2="6" class="icon-line" stroke="currentColor"></line>
            <line x1="8" y1="2" x2="8" y2="6" class="icon-line" stroke="currentColor"></line>
            <line x1="3" y1="10" x2="21" y2="10" class="icon-line" stroke="currentColor"></line>
        </symbol>
        <symbol id="icon-filter" viewBox="0 0 24 24">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" class="icon-line" stroke="currentColor">
            </polygon>
        </symbol>
        <symbol id="icon-help" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" class="icon-line" stroke="currentColor"></circle>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" class="icon-line" stroke="currentColor"></path>
            <line x1="12" y1="17" x2="12.01" y2="17" class="icon-line" stroke-width="3" stroke="currentColor"></line>
        </symbol>
        <symbol id="icon-install" viewBox="0 0 24 24">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" class="icon-line" stroke="currentColor"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4" class="icon-line" stroke="currentColor"></path>
            <line x1="12" y1="16" x2="12" y2="16.01" class="icon-line" stroke-width="3" stroke="currentColor"></line>
        </symbol>
        <symbol id="icon-stats" viewBox="0 0 24 24">
            <line x1="18" y1="20" x2="18" y2="10" class="icon-line" stroke="currentColor"></line>
            <line x1="12" y1="20" x2="12" y2="4" class="icon-line" stroke="currentColor"></line>
            <line x1="6" y1="20" x2="6" y2="14" class="icon-line" stroke="currentColor"></line>
        </symbol>
        <symbol id="icon-plus" viewBox="0 0 24 24">
            <line x1="12" y1="5" x2="12" y2="19" class="icon-line" stroke="currentColor"></line>
            <line x1="5" y1="12" x2="19" y2="12" class="icon-line" stroke="currentColor"></line>
        </symbol>
        <symbol id="icon-chevron-down" viewBox="0 0 24 24">
            <polyline points="6 9 12 15 18 9" class="icon-line" stroke="currentColor" stroke-width="2" fill="none">
            </polyline>
        </symbol>
        <symbol id="icon-lock" viewBox="0 0 24 24">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" class="icon-line" stroke="currentColor"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4" class="icon-line" stroke="currentColor"></path>
        </symbol>
        <symbol id="icon-lock-open" viewBox="0 0 24 24">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" class="icon-line" stroke="currentColor"></rect>
            <path d="M7 11V7a5 5 0 0 1 9.9-1" class="icon-line" stroke="currentColor"></path>
        </symbol>
        <symbol id="icon-briefcase" viewBox="0 0 24 24">
            <rect x="2" y="7" width="20" height="14" rx="2" ry="2" class="icon-line" stroke="currentColor"></rect>
            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" class="icon-line" stroke="currentColor"></path>
        </symbol>
        <symbol id="icon-logo-bolt" viewBox="0 0 24 24">
            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" class="icon-line" stroke="currentColor" stroke-width="2"
                stroke-linejoin="round" fill="none"></path>
        </symbol>
        <symbol id="icon-gift" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 12 20 22 4 22 4 12"></polyline>
            <rect x="2" y="7" width="20" height="5"></rect>
            <line x1="12" y1="22" x2="12" y2="7"></line>
            <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path>
            <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>
        </symbol>
        <symbol id="icon-exit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
        </symbol>
    </svg>
    <div class="header">
        <h1>Horarios</h1>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <button class="icon-btn" id="btn-install" style="display: none;" onclick="PWAInstaller.instalarApp()"
                title="Instalar aplicaci√≥n">
                <svg class="icon">
                    <use href="#icon-install" />
                </svg>
            </button>
            <button class="header-profile-btn" onclick="UILogic.abrirSelectorPerfiles()">
                <svg class="icon">
                    <use href="#icon-briefcase" />
                </svg>
                <span id="nombre-perfil-header">Cargando...</span>
                <svg class="icon" style="font-size: 0.8em; margin-left: 2px;">
                    <use href="#icon-chevron-down" />
                </svg>
            </button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <div class="container">

        <div class="left-column">
            <div class="card stats-card animated-card" id="stats-card" onclick="UILogic.alternarVista()"
                style="animation-delay: 0s;">
                <div class="stats-card-content" id="stats-card-content">
                    <h2 id="stats-titulo">Hoy</h2>
                    <div class="stats-number" id="stats-semana">
                        <div>0 horas 0 minutos</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-bar" style="width: 0%"></div>
                    </div>
                    <div id="stats-mensaje">Faltan 0 horas 0 minutos</div>
                    <div id="stats-buffer" style="font-size: 0.85rem; margin-top: 0.5rem; min-height: 1.2rem;"></div>
                    <span class="toggle-hint" id="toggle-hint">Toca para ver la Semana</span>
                </div>
            </div>
            <div class="card animated-card" style="animation-delay: 0.1s;">
                <h2 class="no-margin"
                    style="display: flex; justify-content: center; align-items: center; position: relative;">
                    <button class="filter-btn timer-btn" id="btn-timer-main" onclick="UILogic.toggleTimerBreakMain()"
                        style="padding: 0.5rem; position: absolute; left: 0px">
                        <svg class="icon">
                            <use href="#icon-exit" />
                        </svg>
                    </button>
                    <button onclick="UILogic.ejecutarAccionRegistro()" id="btn-agregar" class="btn-register">
                        <svg class="icon">
                            <use href="#icon-save" />
                        </svg> <span id="btn-registrar-texto">Registrar</span>
                    </button>
                    <svg class="icon chevron" id="icon-indicator-form" onclick="UILogic.toggleFormulario()"
                        style="position: absolute; right: 0; cursor: pointer;">
                        <use href="#icon-chevron-down" />
                    </svg>
                </h2>
                <div class="form-collapsible" id="form-registro">

                    <!-- MODO NORMAL -->
                    <div id="modo-normal" style="display: block;">
                        <div class="form-group" style="padding-top: 1rem;">
                            <label>Fecha</label>
                            <div class="input-with-btn">
                                <input type="date" id="fecha" />
                                <button class="time-btn" onclick="UILogic.toggleModoLote()"
                                    title="Ir al modo lote/especial" style="flex-shrink: 0;">
                                    <svg class="icon">
                                        <use href="#icon-calendar-simple" />
                                    </svg>
                                </button>
                            </div>
                            <span class="input-error" id="error-fecha">Fecha inv√°lida</span>
                        </div>
                        <div class="form-group">
                            <label>Entrada</label>
                            <div class="input-with-btn">
                                <input type="text" id="entrada" inputmode="numeric" placeholder="Hora" maxlength="5" />
                                <button class="time-btn" onclick="UILogic.pegarHoraActual('entrada')">
                                    <svg class="icon">
                                        <use href="#icon-clock" />
                                    </svg>
                                </button>
                            </div>
                            <span class="input-error" id="error-entrada">Formato inv√°lido (HH:MM)</span>
                        </div>
                        <div class="form-group">
                            <label>Salida</label>
                            <div class="input-with-btn">
                                <input type="text" id="salida" inputmode="numeric" placeholder="hora" maxlength="5" />
                                <button class="time-btn" onclick="UILogic.pegarHoraActual('salida')">
                                    <svg class="icon">
                                        <use href="#icon-clock" />
                                    </svg>
                                </button>
                            </div>
                            <span class="input-error" id="error-salida">Formato inv√°lido (HH:MM)</span>
                        </div>
                    </div>

                    <!-- MODO LOTE -->
                    <div id="modo-lote" class="fade-out" style="display: none;">
                        <div class="form-group" style="padding-top: 1rem;">
                            <label>Tipo de registro</label>
                            <div class="input-with-btn">
                                <select id="lote-tipo" onchange="UILogic.actualizarBotonLote()">
                                    <option value="feriado">ü•≥ Feriado (00:00)</option>
                                    <option value="ausencia">üè† Licencia (11:11)</option>
                                    <option value="vacaciones">üèñÔ∏è Vacaciones (12:12)</option>
                                    <option value="asueto">üéÅ Asueto (13:13)</option>
                                    <option value="enfermedad">üè• Enfermedad (14:14)</option>
                                    <option value="paro">üì¢ Paro (15:15)</option>
                                    <option value="remoto">üíª Remoto (16:16)</option>
                                    <option value="capacitacion">üìö Capacitaci√≥n (17:17)</option>
                                    <option value="normal">üïí Normales (borrar)</option>
                                </select>
                                <button class="time-btn" onclick="UILogic.toggleModoLote()" title="Ir al modo normal"
                                    style="flex-shrink: 0;">
                                    <svg class="icon">
                                        <use href="#icon-undo" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="contenedor-fechas">
                            <div class="form-group">
                                <label>Desde</label>
                                <div class="input-with-btn">
                                    <input type="date" id="lote-fecha-desde" />
                                    <button class="time-btn" onclick="UILogic.alternarFechaActual('lote-fecha-desde')"
                                        title="Pegar hoy / Limpiar">
                                        <svg class="icon">
                                            <use href="#icon-calendar-simple" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Hasta</label>
                                <div class="input-with-btn">
                                    <input type="date" id="lote-fecha-hasta" />
                                    <button class="time-btn" onclick="UILogic.alternarFechaActual('lote-fecha-hasta')"
                                        title="Pegar hoy / Limpiar">
                                        <svg class="icon">
                                            <use href="#icon-calendar-simple" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card animated-card" style="animation-delay: 0.2s;">
                <h2 class="no-margin card-header-clickable" onclick="UILogic.toggleStats()">
                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                        <svg class="icon">
                            <use href="#icon-stats" />
                        </svg> Estad√≠sticas
                    </span>
                    <svg class="icon chevron" id="icon-indicator-stats">
                        <use href="#icon-chevron-down" />
                    </svg>
                </h2>
                <div class="form-collapsible" id="form-stats">
                    <div style="padding-top: 1rem;">
                        <div class="form-group">
                            <label>Per√≠odo</label>
                            <select id="select-mes-stats" onchange="UILogic.cambiarMesStats()"></select>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-label">Jornadas</div>
                                <div class="stat-value" id="stat-dias-trabajados">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Feriados</div>
                                <div class="stat-value" id="stat-feriados">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Licencias</div>
                                <div class="stat-value" id="stat-ausencias">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Vacaciones</div>
                                <div class="stat-value" id="stat-vacaciones">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Enfermedades</div>
                                <div class="stat-value" id="stat-enfermedades">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Asuetos</div>
                                <div class="stat-value" id="stat-asuetos-dia">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Paros</div>
                                <div class="stat-value" id="stat-paros">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Remotos</div>
                                <div class="stat-value" id="stat-remotos">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Capacitaciones</div>
                                <div class="stat-value" id="stat-capacitaciones">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Salidas Temprano</div>
                                <div class="stat-value" id="stat-compensaciones">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Tiempo Fuera</div>
                                <div class="stat-value" id="stat-tiempo-fuera-total">0h 0m</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Entrada Promedio</div>
                                <div class="stat-value" id="stat-entrada-promedio">--:--</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Salida Promedio</div>
                                <div class="stat-value" id="stat-salida-promedio">--:--</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Promedio Diario</div>
                                <div class="stat-value" id="stat-promedio-diario">0h 0m</div>
                            </div>
                            <div style="grid-column: 1 / -1; height: 1px; background: var(--border); margin: 0.5rem 0;">
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Semana Pasada</div>
                                <div class="stat-value" id="stat-semana-pasada">0h 0m</div>
                            </div>
                        </div>

                        <div class="btn-group" style="margin-top: 1rem;">
                            <button class="btn-agregar" onclick="UILogic.generarReporte()">
                                <svg class="icon">
                                    <use href="#icon-download" />
                                </svg>
                                Reporte
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card animated-card" style="animation-delay: 0.3s;">
            <h2 class="no-margin card-header-clickable" onclick="UILogic.toggleHistorico()">
                <span style="display: flex; align-items: center; gap: 0.5rem;">
                    <svg class="icon">
                        <use href="#icon-list" />
                    </svg> Hist√≥rico
                </span>
                <svg class="icon chevron" id="icon-indicator-historico">
                    <use href="#icon-chevron-down" />
                </svg>
            </h2>

            <div class="form-collapsible" id="contenido-historico">
                <div id="botones-historico" style="padding-top: 0.5rem; margin-bottom: 0.5rem;">
                    <div
                        style="display: flex; justify-content: space-between; gap: 0.5rem; padding: 0 0.5rem; margin-top: 0.5rem">
                        <button class="filter-btn" id="btn-filtro" onclick="UILogic.mostrarFiltros()" title="Filtrar">
                            <svg class="icon">
                                <use href="#icon-filter" />
                            </svg>
                        </button>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="filter-btn" id="btn-undo" onclick="HistoryManager.undo()" title="Deshacer">
                                <svg class="icon">
                                    <use href="#icon-undo" />
                                </svg>
                            </button>
                            <button class="filter-btn" id="btn-redo" onclick="HistoryManager.redo()" title="Rehacer">
                                <svg class="icon">
                                    <use href="#icon-redo" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="lista-registros" class="custom-scroll"></div>
            </div>
        </div>
    </div>
    <div class="modal" id="modal-config">
        <div class="modal-content">
            <h3>
                <span class="modal-title-block">
                    <svg class="icon">
                        <use href="#icon-settings" />
                    </svg>
                    Ajustes
                </span>
                <span class="version-text">LUSHIBOSCA-7.34</span>
            </h3>
            <div class="form-group">
                <label>Horas Diarias</label>
                <div class="input-number-group">
                    <input type="number" id="config-horas-diarias" min="0" max="24" step="0.5" readonly />
                    <button class="btn-increment" onmousedown="UILogic.iniciarCambioHoras(0.5)"
                        onmouseup="UILogic.detenerCambio()" onmouseleave="UILogic.detenerCambio()"
                        ontouchstart="event.preventDefault(); UILogic.iniciarCambioHoras(0.5)"
                        ontouchend="event.preventDefault(); UILogic.detenerCambio()">+</button>
                    <button class="btn-increment" onmousedown="UILogic.iniciarCambioHoras(-0.5)"
                        onmouseup="UILogic.detenerCambio()" onmouseleave="UILogic.detenerCambio()"
                        ontouchstart="event.preventDefault(); UILogic.iniciarCambioHoras(-0.5)"
                        ontouchend="event.preventDefault(); UILogic.detenerCambio()">‚àí</button>
                </div>
            </div>
            <div class="form-group">
                <label>D√≠as Laborales</label>
                <div class="week-selector">
                    <label class="day-checkbox">
                        <input type="checkbox" name="dia-habil" value="1">
                        <span>Lu</span>
                    </label>
                    <label class="day-checkbox">
                        <input type="checkbox" name="dia-habil" value="2">
                        <span>Ma</span>
                    </label>
                    <label class="day-checkbox">
                        <input type="checkbox" name="dia-habil" value="3">
                        <span>Mi</span>
                    </label>
                    <label class="day-checkbox">
                        <input type="checkbox" name="dia-habil" value="4">
                        <span>Ju</span>
                    </label>
                    <label class="day-checkbox">
                        <input type="checkbox" name="dia-habil" value="5">
                        <span>Vi</span>
                    </label>
                    <label class="day-checkbox">
                        <input type="checkbox" name="dia-habil" value="6">
                        <span>Sa</span>
                    </label>
                    <label class="day-checkbox">
                        <input type="checkbox" name="dia-habil" value="0"> <span>Do</span>
                    </label>
                </div>
                <div id="config-total-feedback" class="config-hint-text">(Total semanal: --hs)</div>
            </div>
            <div class="config-actions">
                <label>Registros</label>
                <button class="btn-backup" onclick="UILogic.mostrarImportar()">
                    <svg class="icon">
                        <use href="#icon-upload" />
                    </svg>
                    Restaurar
                </button>
                <button class="btn-export" onclick="UILogic.mostrarExportar()">
                    <svg class="icon">
                        <use href="#icon-download" />
                    </svg>
                    Respaldar
                </button>
                <button class="btn-delete" onclick="DataManagement.borrarTodoHistorial()">
                    <svg class="icon">
                        <use href="#icon-trash" />
                    </svg>
                    Borrar Todo
                </button>
            </div>
            <div class="btn-group" style="margin-top: 1.5rem;">
                <button class="btn-edit" onclick="DataManagement.guardarConfig()">
                    <svg class="icon">
                        <use href="#icon-save" />
                    </svg> Guardar
                </button>

                <button class="btn-delete" onclick="UILogic.cerrarConfig()">
                    <svg class="icon">
                        <use href="#icon-undo" />
                    </svg> Volver
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-editar">
        <div class="modal-content">
            <h3>
                <span class="modal-title-block">
                    <svg class="icon">
                        <use href="#icon-edit" />
                    </svg>Editar Registro
                </span>
            </h3>
            <div class="form-group">
                <label>Fecha</label>
                <div class="input-with-btn">
                    <input type="date" id="edit-fecha" />
                    <button class="time-btn" id="btn-lock-toggle" onclick="UILogic.toggleBloqueoEdicion()"
                        title="Desbloquear edici√≥n">
                        <svg class="icon">
                            <use href="#icon-lock" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label>Entrada</label>
                <div class="input-with-btn">
                    <input type="text" id="edit-entrada" inputmode="numeric" maxlength="5" />
                    <button class="time-btn" onclick="UILogic.pegarHoraActual('edit-entrada')"><svg class="icon">
                            <use href="#icon-clock" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label>Salida</label>
                <div class="input-with-btn">
                    <input type="text" id="edit-salida" inputmode="numeric" maxlength="5" />
                    <button class="time-btn" onclick="UILogic.pegarHoraActual('edit-salida')"><svg class="icon">
                            <use href="#icon-clock" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label>Tiempo Fuera</label>
                <div class="input-with-btn">
                    <input type="text" id="edit-tiempo-fuera" inputmode="numeric" maxlength="5" />
                    <button class="time-btn" onclick="UILogic.limpiarCampo('edit-tiempo-fuera')" title="Limpiar">
                        <svg class="icon">
                            <use href="#icon-broom" />
                        </svg>
                    </button>
                    <button id="btn-toggle-credito" class="time-btn" onclick="UILogic.toggleCredito()"
                        style="margin-left: 5px;" title="(Compensaci√≥n/Asueto)">
                        <svg class="icon">
                            <use href="#icon-exit" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn-edit" onclick="DataManagement.guardarEdicion()"><svg class="icon">
                        <use href="#icon-save" />
                    </svg> Guardar</button>
                <button class="btn-delete" onclick="DataManagement.eliminarRegistroActual()"><svg class="icon">
                        <use href="#icon-trash" />
                    </svg> Eliminar</button>
            </div>
            <div class="btn-group">
                <button class="btn-cancel" onclick="UILogic.cerrarEdicion()"><svg class="icon">
                        <use href="#icon-cancelar" />
                    </svg> Cancelar</button>
            </div>
        </div>
    </div>
    <div class="modal" id="modal-importar">
        <div class="modal-content">
            <h3><svg class="icon">
                    <use href="#icon-upload" />
                </svg> Restaurar Registros</h3>
            <div class="form-group">
                <input type="file" id="file-import" accept=".json" style="display: none;" />
                <button type="button" class="btn-backup" onclick="document.getElementById('file-import').click()">
                    <svg class="icon">
                        <use href="#icon-upload" />
                    </svg>
                    Seleccionar archivo
                </button>
                <div id="nombre-archivo-seleccionado" class="config-hint-text"
                    style="text-align: center; margin-top: 0.5rem; color: var(--c-green); display: none;">
                    <!-- Aqu√≠ aparecer√° el nombre del archivo -->
                </div>
                <hr style="border: 0; border-top: 1px solid var(--border); margin: 1rem 0 1rem 0;">
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1rem;">
                <button class="btn-backup" id="btn-combinar" onclick="DataManagement.importarDatos('merge')" disabled>
                    <svg class="icon">
                        <use href="#icon-combine" />
                    </svg>
                    Combinar
                </button>
                <button class="btn-delete" id="btn-reemplazar" onclick="DataManagement.importarDatos('replace')"
                    disabled>
                    <svg class="icon">
                        <use href="#icon-replace-swap" />
                    </svg>
                    Sobrescribir
                </button>
                <button class="btn-cancel" onclick="UILogic.cerrarImportar()">
                    <svg class="icon">
                        <use href="#icon-undo" />
                    </svg>
                    Volver
                </button>
            </div>
        </div>
    </div>
    <div class="modal" id="modal-exportar">
        <div class="modal-content">
            <h3>
                <span class="modal-title-block">
                    <svg class="icon">
                        <use href="#icon-download" />
                    </svg>
                    Respaldar Registros
                </span>
            </h3>
            <div class="form-group">
                <select id="tipo-exportacion">
                    <option value="todo">üì¶ Todo el perfil</option>
                    <option value="mes-actual">üìÖ Mes actual</option>
                    <option value="rango">üìä Rango personalizado</option>
                </select>
            </div>

            <!-- Campos de rango (ocultos por defecto) -->
            <div id="campos-rango-exportar" style="display: none;">
                <div class="form-group">
                    <label>Desde</label>
                    <input type="date" id="export-fecha-desde" />
                </div>
                <div class="form-group">
                    <label>Hasta</label>
                    <input type="date" id="export-fecha-hasta" />
                </div>
            </div>

            <div class="btn-group">
                <button class="btn-export" onclick="UILogic.ejecutarExportacion()">
                    <svg class="icon">
                        <use href="#icon-download" />
                    </svg>
                    Descargar
                </button>
                <button class="btn-cancel" onclick="UILogic.cerrarExportar()">
                    <svg class="icon">
                        <use href="#icon-undo" />
                    </svg>
                    Volver
                </button>
            </div>
        </div>
    </div>
    <div class="modal" id="modal-filtros">
        <div class="modal-content">
            <h3>
                <span class="modal-title-block">
                    <svg class="icon">
                        <use href="#icon-filter" />
                    </svg>
                    Filtrar Hist√≥rico
                </span>
            </h3>
            <div class="form-group">
                <label>Desde</label>
                <input type="date" id="filtro-fecha-desde" />
            </div>
            <div class="form-group">
                <label>Hasta</label>
                <input type="date" id="filtro-fecha-hasta" />
            </div>
            <div class="form-group">
                <label>Tipo de registro</label>
                <select id="filtro-tipo">
                    <option value="">Todos</option>
                    <option value="normal">üïí Normales</option>
                    <option value="feriado">ü•≥ Feriados</option>
                    <option value="ausencia">üè† Licencias</option>
                    <option value="vacaciones">üèñÔ∏è Vacaciones</option>
                    <option value="enfermedad">üè• Enfermedades</option>
                    <option value="asueto">üéÅ Asuetos</option>
                    <option value="paro">üì¢ Paros</option>
                    <option value="remoto">üíª Remotos</option>
                    <option value="capacitacion">üìö Capacitaciones</option>
                </select>
            </div>
            <div class="btn-group">
                <button class="btn-edit" onclick="DataManagement.aplicarFiltros()">
                    <svg class="icon">
                        <use href="#icon-filter" />
                    </svg> Aplicar
                </button>
                <button class="btn-cancel" onclick="UILogic.cerrarFiltros()">
                    <svg class="icon">
                        <use href="#icon-cancelar" />
                    </svg> Cerrar
                </button>
            </div>
        </div>
    </div>
    <div class="modal" id="modal-selector-perfiles">
        <div class="modal-content">
            <h3>
                <span class="modal-title-block">
                    <svg class="icon">
                        <use href="#icon-briefcase" />
                    </svg>
                    Perfiles
                </span>
            </h3>
            <div id="lista-perfiles-botones" class="perfil-list-container">
            </div>
            <div class="form-group" style="margin-top: 1.5rem; border-top: 1px solid var(--border); padding-top: 1rem;">
                <label>Agregar Nuevo Perfil</label>
                <div class="input-with-btn">
                    <input type="text" id="nombre-nuevo-perfil-selector" placeholder="Nombre del perfil..."
                        maxlength="30" />
                    <button class="time-btn" onclick="UILogic.crearPerfilDesdeSelector()" title="Crear perfil">
                        <svg class="icon">
                            <use href="#icon-plus" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn-edit" onclick="UILogic.mostrarconfig()" style="flex: 1;">
                    <svg class="icon">
                        <use href="#icon-settings" />
                    </svg>
                    Ajustes
                </button>
                <button class="time-btn" id="theme-toggle-modal" onclick="UILogic.alternarTema()" title="Cambiar Tema">
                    <svg class="icon">
                        <use href="#icon-moon" />
                    </svg>
                </button>
            </div>
            <div class="btn-group">
                <button class="btn-cancel" onclick="UILogic.cerrarSelectorPerfiles()">
                    <svg class="icon">
                        <use href="#icon-cancelar" />
                    </svg>Cerrar
                </button>
            </div>
        </div>
    </div>
    <div class="modal" id="modal-editar-perfil">
        <div class="modal-content">
            <h3>
                <span class="modal-title-block">
                    <svg class="icon">
                        <use href="#icon-edit" />
                    </svg>
                    Editar Perfil
                </span>
            </h3>

            <div class="form-group">
                <label>Nombre del Perfil</label>
                <input type="text" id="nombre-perfil-editar" placeholder="Nombre del perfil..." maxlength="30" />
            </div>

            <input type="hidden" id="id-perfil-editar" />

            <div class="btn-group">
                <button class="btn-edit" onclick="UILogic.guardarEdicionPerfil()">
                    <svg class="icon">
                        <use href="#icon-save" />
                    </svg>
                    Guardar
                </button>
                <button class="btn-delete" onclick="UILogic.eliminarPerfilDesdeEditor()"
                    id="btn-eliminar-perfil-editor">
                    <svg class="icon">
                        <use href="#icon-trash" />
                    </svg>
                    Eliminar
                </button>
            </div>

            <div class="btn-group">
                <button class="btn-cancel" onclick="UILogic.cerrarEditorPerfil()">
                    <svg class="icon">
                        <use href="#icon-cancelar" />
                    </svg>
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-editar-grupo">
        <div class="modal-content">
            <h3>
                <span class="modal-title-block">
                    <svg class="icon">
                        <use href="#icon-edit" />
                    </svg>Editar Grupo
                </span>
            </h3>
            <div class="form-group">
                <label>Tipo de registro</label>
                <div class="input-with-btn">
                    <select id="edit-grupo-tipo">
                        <option value="feriado">ü•≥ Feriado</option>
                        <option value="ausencia">üè† Licencia</option>
                        <option value="vacaciones">üèñÔ∏è Vacaciones</option>
                        <option value="asueto">üéÅ Asueto</option>
                        <option value="enfermedad">üè• Enfermedad</option>
                        <option value="paro">üì¢ Paro</option>
                        <option value="remoto">üíª Remoto</option>
                        <option value="capacitacion">üìö Capacitaci√≥n</option>
                    </select>
                    <button class="time-btn" id="btn-lock-grupo-toggle" onclick="UILogic.toggleBloqueoEdicionGrupo()"
                        title="Desbloquear edici√≥n">
                        <svg class="icon">
                            <use href="#icon-lock" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label>Desde</label>
                <div class="input-with-btn">
                    <input type="date" id="edit-grupo-desde" />
                    <button class="time-btn" onclick="UILogic.alternarFechaActual('edit-grupo-desde')"
                        title="Pegar hoy / Limpiar">
                        <svg class="icon">
                            <use href="#icon-calendar-simple" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label>Hasta</label>
                <div class="input-with-btn">
                    <input type="date" id="edit-grupo-hasta" />
                    <button class="time-btn" onclick="UILogic.alternarFechaActual('edit-grupo-hasta')"
                        title="Pegar hoy / Limpiar">
                        <svg class="icon">
                            <use href="#icon-calendar-simple" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn-edit" onclick="DataManagement.guardarEdicionGrupo()">
                    <svg class="icon">
                        <use href="#icon-save" />
                    </svg> Guardar
                </button>
                <button class="btn-delete" onclick="DataManagement.eliminarGrupoActual()">
                    <svg class="icon">
                        <use href="#icon-trash" />
                    </svg> Eliminar
                </button>
            </div>
            <div class="btn-group">
                <button class="btn-cancel" onclick="UILogic.cerrarEdicionGrupo()">
                    <svg class="icon">
                        <use href="#icon-cancelar" />
                    </svg> Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            'use strict';

            const $ = id => document.getElementById(id);

            // ====================================================================
            // PWA INSTALLER MODULE
            // ====================================================================
            const PWAInstaller = (function () {
                let deferredPrompt = null;
                const btnInstall = document.getElementById('btn-install');

                function init() {
                    // Detectar si ya est√° instalada
                    if (window.matchMedia('(display-mode: standalone)').matches ||
                        window.navigator.standalone === true) {
                        // Ya est√° instalada, no mostrar bot√≥n
                        if (btnInstall) btnInstall.style.display = 'none';
                        return;
                    }

                    // Capturar el evento beforeinstallprompt
                    window.addEventListener('beforeinstallprompt', (e) => {
                        // Prevenir el prompt autom√°tico
                        e.preventDefault();
                        // Guardar el evento para usarlo despu√©s
                        deferredPrompt = e;
                        // Mostrar el bot√≥n de instalaci√≥n
                        if (btnInstall) {
                            btnInstall.style.display = 'flex';
                        }
                    });

                    // Detectar cuando se instala la app
                    window.addEventListener('appinstalled', () => {
                        // Ocultar el bot√≥n
                        if (btnInstall) btnInstall.style.display = 'none';
                        deferredPrompt = null;

                        // Mostrar notificaci√≥n de √©xito
                        if (window.UILogic) {
                            UILogic.mostrarToast('¬°App instalada con √©xito!', 'success');
                        }
                    });
                }

                async function instalarApp() {
                    if (!deferredPrompt) {
                        console.log('No hay prompt de instalaci√≥n disponible');
                        return;
                    }

                    // Mostrar el prompt de instalaci√≥n
                    deferredPrompt.prompt();

                    // Esperar a que el usuario responda
                    const { outcome } = await deferredPrompt.userChoice;

                    if (outcome === 'accepted') {
                        console.log('Usuario acept√≥ la instalaci√≥n');
                    } else {
                        console.log('Usuario rechaz√≥ la instalaci√≥n');
                    }

                    // Limpiar el prompt
                    deferredPrompt = null;
                }

                return {
                    init,
                    instalarApp
                };
            })();

            // ====================================================================
            // SECURITY AND UTILS MODULE
            // ====================================================================
            const SecurityAndUtils = (function () {
                const SECURITY_LIMITS = {
                    MAX_REGISTROS: 1000,
                    MAX_STRING_LENGTH: 100,
                    MAX_JSON_SIZE: 4 * 1024 * 1024,
                    SCHEMA_VERSION: 3,
                    MAX_OPERATIONS_PER_MINUTE: 30
                };

                const REGEX_PATTERNS = {
                    FECHA: /^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])$/,
                    HORA: /^([01]\d|2[0-3]):([0-5]\d)$/,
                    ID: /^[a-zA-Z0-9-_]{10,100}$/
                };

                class RateLimiter {
                    constructor(maxOps, windowMs) {
                        this.maxOps = maxOps;
                        this.windowMs = windowMs;
                        this.operations = [];
                    }
                    canProceed() {
                        const now = Date.now();
                        this.operations = this.operations.filter(time => now - time < this.windowMs);
                        if (this.operations.length >= this.maxOps) return false;
                        this.operations.push(now);
                        return true;
                    }
                }

                const saveLimiter = new RateLimiter(SECURITY_LIMITS.MAX_OPERATIONS_PER_MINUTE, 60000);

                function sanitizeString(str, maxLength = SECURITY_LIMITS.MAX_STRING_LENGTH) {
                    if (typeof str !== 'string') return '';

                    return str
                        .replace(/[<>"'`]/g, '')
                        .replace(/javascript:/gi, '')
                        .replace(/data:/gi, '')
                        .replace(/vbscript:/gi, '')
                        .replace(/on\w+\s*=/gi, '')
                        .replace(/[\x00-\x1F\x7F]/g, '')
                        .replace(/&lt;/gi, '')
                        .replace(/&gt;/gi, '')
                        .replace(/&#/g, '')
                        .trim()
                        .substring(0, maxLength);
                }

                function validarFechaSegura(f) {
                    if (!f || !REGEX_PATTERNS.FECHA.test(f)) return false;

                    try {
                        const [y, m, d] = f.split('-').map(Number);
                        const fecha = new Date(y, m - 1, d);
                        if (fecha.getFullYear() !== y ||
                            fecha.getMonth() !== m - 1 ||
                            fecha.getDate() !== d) {
                            return false;
                        }

                        const ahora = new Date();
                        const hace20Anos = new Date(ahora.getFullYear() - 20, 0, 1);
                        const en2Anos = new Date(ahora.getFullYear() + 2, 11, 31);

                        return fecha >= hace20Anos && fecha <= en2Anos && !isNaN(fecha.getTime());
                    } catch (e) {
                        return false;
                    }
                }

                function validarHoraSegura(h) {
                    return h && REGEX_PATTERNS.HORA.test(h);
                }

                function generarIDSeguro() {
                    if (window.crypto && window.crypto.getRandomValues) {
                        const array = new Uint32Array(4);
                        crypto.getRandomValues(array);
                        return Array.from(array, num => num.toString(36)).join('');
                    }
                    const timestamp = Date.now().toString(36);
                    const random1 = Math.random().toString(36).substring(2, 11);
                    const random2 = Math.random().toString(36).substring(2, 11);
                    return `${timestamp}-${random1}${random2}`;
                }

                async function calcularHashSHA256(data) {
                    const encoder = new TextEncoder();
                    const dataBuffer = encoder.encode(JSON.stringify(data));
                    const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                }

                function constantTimeCompare(a, b) {
                    // Convertir a strings si no lo son
                    const strA = String(a);
                    const strB = String(b);

                    const maxLength = Math.max(strA.length, strB.length);
                    let result = strA.length === strB.length ? 0 : 1;

                    for (let i = 0; i < maxLength; i++) {
                        const charA = i < strA.length ? strA.charCodeAt(i) : 0;
                        const charB = i < strB.length ? strB.charCodeAt(i) : 0;
                        result |= charA ^ charB;
                    }

                    return result === 0;
                }

                function validarRegistroSeguro(r) {
                    if (!r || typeof r !== 'object') return false;
                    if (Array.isArray(r) || r instanceof Date) return false;
                    if (typeof r.id !== 'string' || !REGEX_PATTERNS.ID.test(r.id)) return false;
                    if (typeof r.fecha !== 'string' || !REGEX_PATTERNS.FECHA.test(r.fecha)) return false;
                    if (!validarFechaSegura(r.fecha)) return false;
                    if (r.entrada !== null) {
                        if (typeof r.entrada !== 'string' || !REGEX_PATTERNS.HORA.test(r.entrada)) return false;
                    }
                    if (r.salida !== null) {
                        if (typeof r.salida !== 'string' || !REGEX_PATTERNS.HORA.test(r.salida)) return false;
                    }

                    if (r.tiempoFuera !== null && r.tiempoFuera !== '') {
                        if (typeof r.tiempoFuera !== 'string' || !REGEX_PATTERNS.HORA.test(r.tiempoFuera)) return false;
                    }

                    if (r.credito !== null && r.credito !== undefined && r.credito !== '') {
                        if (typeof r.credito !== 'string' || !REGEX_PATTERNS.HORA.test(r.credito)) return false;
                    }

                    if (!Number.isFinite(r.horas) || r.horas < 0 || r.horas > 24) return false;
                    if (!Number.isFinite(r.minutos) || r.minutos < 0 || r.minutos > 59) return false;
                    if (!Number.isFinite(r.total) || r.total < 0 || r.total > 24) return false;

                    const propiedadesPermitidas = ['id', 'fecha', 'entrada', 'salida', 'tiempoFuera', 'horas', 'minutos', 'total', 'credito']; const propiedadesActuales = Object.keys(r);
                    const tienePropiedadesSospechosas = propiedadesActuales.some(prop => !propiedadesPermitidas.includes(prop));
                    if (tienePropiedadesSospechosas) return false;

                    return true;
                }
                return {
                    SECURITY_LIMITS,
                    REGEX_PATTERNS,
                    saveLimiter,
                    sanitizeString,
                    validarFechaSegura,
                    validarHoraSegura,
                    generarIDSeguro,
                    calcularHashSHA256,
                    constantTimeCompare,
                    validarRegistroSeguro
                };
            })();

            // ====================================================================
            // PERFIL MANAGER MODULE
            // ====================================================================
            const PerfilManager = (function (S) {
                const MAX_PERFILES = 7; // cantidad maxima de perfiles permitida (1 de 3)
                let perfilActual = 'default';
                let perfiles = {};

                function inicializar() {
                    cargarPerfiles();
                    actualizarSelector();
                    actualizarNombrePerfil();
                }

                function cargarPerfiles() {
                    try {
                        const storedPerfiles = localStorage.getItem('perfiles');
                        const storedLegacyRegistros = localStorage.getItem('registros');

                        perfiles = storedPerfiles ? JSON.parse(storedPerfiles) : {};

                        // 1. Verificar bandera de migraci√≥n para no repetir el proceso
                        const yaMigrado = localStorage.getItem('migracion-v6-completada');

                        // Verificamos si el perfil default est√° vac√≠o o corrupto
                        const esPerfilVacio = !perfiles['default'] ||
                            !perfiles['default'].registros ||
                            perfiles['default'].registros.length === 0;

                        // 2. Ejecutar migraci√≥n SOLO si es necesario y seguro
                        if (!yaMigrado && storedLegacyRegistros && esPerfilVacio) {
                            console.log("üîÑ Iniciando migraci√≥n segura desde v6.25...");

                            let registrosViejos = [];
                            try {
                                const parsed = JSON.parse(storedLegacyRegistros);
                                // Soporte para estructura {registros: []} o array directo []
                                if (parsed.registros && Array.isArray(parsed.registros)) {
                                    registrosViejos = parsed.registros;
                                } else if (Array.isArray(parsed)) {
                                    registrosViejos = parsed;
                                }
                            } catch (e) {
                                console.error("Error cr√≠tico leyendo datos antiguos:", e);
                                // No retornamos, dejamos que se cree un perfil vac√≠o por seguridad
                            }

                            if (registrosViejos.length > 0) {
                                // 3. Crear Backup de Seguridad
                                try {
                                    localStorage.setItem('backup-pre-migracion', storedLegacyRegistros);
                                    localStorage.setItem('backup-fecha', new Date().toISOString());
                                } catch (e) {
                                    console.warn("Espacio insuficiente para backup, continuando con precauci√≥n...");
                                }

                                // 4. Filtrado y Validaci√≥n (Sanitizaci√≥n)
                                // Usamos 'S' porque as√≠ se llama el m√≥dulo dentro de PerfilManager
                                const registrosValidos = registrosViejos.filter(r => {
                                    try {
                                        return S.validarRegistroSeguro(r);
                                    } catch (e) {
                                        return false;
                                    }
                                });

                                // Recuperar configuraci√≥n antigua si existe
                                const diasViejos = parseFloat(localStorage.getItem('diasHabiles')) || 5;
                                const horasViejas = parseFloat(localStorage.getItem('horasDiarias')) || 7;

                                perfiles['default'] = {
                                    nombre: 'Principal (Recuperado)',
                                    registros: registrosValidos,
                                    diasHabiles: diasViejos,
                                    horasDiarias: horasViejas
                                };

                                perfilActual = 'default';
                                guardarPerfiles();

                                // 5. Marcar migraci√≥n como completada
                                localStorage.setItem('migracion-v6-completada', 'true');
                                localStorage.setItem('migracion-fecha', new Date().toISOString());

                                // 6. Feedback detallado
                                const descartados = registrosViejos.length - registrosValidos.length;
                                let mensaje = `‚úÖ Se migraron ${registrosValidos.length} registros exitosamente.`;

                                if (descartados > 0) {
                                    mensaje += `\nüóëÔ∏è Se descartaron ${descartados} registros corruptos.`;
                                }

                                if (window.UILogic) {
                                    // Usamos un timeout peque√±o para asegurar que UILogic est√© listo
                                    setTimeout(() => window.UILogic.mostrarToast(mensaje, 'success'), 500);
                                }

                                console.log(`Reporte Migraci√≥n: V√°lidos ${registrosValidos.length} | Descartados ${descartados}`);
                            }
                        }

                        // 7. Fallback
                        if (!perfiles['default']) {
                            perfiles['default'] = {
                                nombre: 'Principal',
                                registros: [],
                                diasHabiles: [1, 2, 3, 4, 5], // <---  Array
                                horasDiarias: 7
                            };
                        }

                        // 8. Determinar perfil activo
                        perfilActual = localStorage.getItem('perfilActivo') || 'default';
                        if (!perfiles[perfilActual]) {
                            const availableIds = Object.keys(perfiles);
                            perfilActual = availableIds.length > 0 ? availableIds[0] : 'default';
                        }

                    } catch (e) {
                        console.error('Error fatal cargando perfiles, reiniciando a estado seguro:', e);
                        perfiles = {
                            'default': {
                                nombre: 'Principal',
                                registros: [],
                                diasHabiles: 5,
                                horasDiarias: 7
                            }
                        };
                        perfilActual = 'default';
                    }
                }

                function guardarPerfiles() {
                    try {
                        localStorage.setItem('perfiles', JSON.stringify(perfiles));
                        localStorage.setItem('perfilActivo', perfilActual);
                        return true;
                    } catch (e) { return false; }
                }

                function actualizarNombrePerfil() {
                    const nombreInput = document.getElementById('nombre-perfil-actual');
                    if (nombreInput && perfiles[perfilActual]) nombreInput.value = perfiles[perfilActual].nombre;
                    const btnEliminar = document.getElementById('btn-eliminar-perfil-modal');
                    if (btnEliminar) {
                        btnEliminar.disabled = (perfilActual === 'default');
                        btnEliminar.style.opacity = (perfilActual === 'default') ? '0.5' : '1';
                    }
                }

                function guardarDatosPerfilActual() {
                    if (!window.DataManagement) return;
                    perfiles[perfilActual] = {
                        nombre: perfiles[perfilActual].nombre,
                        registros: [...window.DataManagement.registros()],
                        diasHabiles: window.DataManagement.diasHabiles(),
                        horasDiarias: window.DataManagement.horasDiarias()
                    };
                    guardarPerfiles();
                }

                function cargarDatosPerfilActual() { return perfiles[perfilActual]; }

                function actualizarSelector() {
                    // Actualiza el TEXTO del bot√≥n del header en lugar del select
                    const btnTexto = document.getElementById('nombre-perfil-header');
                    if (btnTexto && perfiles[perfilActual]) {
                        btnTexto.textContent = perfiles[perfilActual].nombre;
                    }
                }

                function obtenerListaPerfiles() {
                    return Object.entries(perfiles).map(([id, perfil]) => ({
                        id: id,
                        nombre: perfil.nombre,
                        esActual: id === perfilActual
                    })).sort((a, b) => {
                        if (a.id === 'default') return -1;
                        if (b.id === 'default') return 1;
                        return a.nombre.localeCompare(b.nombre);
                    });
                }

                function cambiarPerfil(nuevoId) {
                    if (!nuevoId) return; // Si viene del select antiguo (ya no existe)
                    if (nuevoId === perfilActual) return;

                    guardarDatosPerfilActual();
                    perfilActual = nuevoId;
                    localStorage.setItem('perfilActivo', perfilActual);
                    location.reload();
                }

                function obtenerPerfilActual() { return perfilActual; }

                function obtenerDatosPerfil() { return perfiles[perfilActual]; }

                return {
                    inicializar, cambiarPerfil, guardarDatosPerfilActual, cargarDatosPerfilActual,
                    obtenerPerfilActual, obtenerDatosPerfil, obtenerListaPerfiles
                };

            })(SecurityAndUtils);

            // ====================================================================
            // MODAL MANAGER MODULE
            // ====================================================================
            const ModalManager = (function () {

                // Funci√≥n para manejar clics fuera del modal
                function handleOutsideClick(event) {
                    // Verificar si el clic fue en el overlay (fondo del modal)
                    if (event.target.classList.contains('modal') && event.target.classList.contains('show')) {
                        const modalId = event.target.id;

                        // Solo los modales con estado cr√≠tico usan su funci√≥n espec√≠fica
                        if (modalId === 'modal-editar') {
                            if (window.UILogic) UILogic.cerrarEdicion();
                        } else if (modalId === 'modal-editar-grupo') {
                            if (window.UILogic) UILogic.cerrarEdicionGrupo();
                        } else {
                            // El resto se cierra directamente
                            cerrar(modalId);
                        }
                    }
                }

                function abrir(modalId, callback = null) {
                    const modal = document.getElementById(modalId);
                    if (!modal) {
                        console.warn(`Modal ${modalId} no encontrado`);
                        return;
                    }

                    modal.classList.add('show');
                    document.body.classList.add('modal-open');

                    // Agregar listener para clics fuera del modal
                    setTimeout(() => {
                        modal.addEventListener('click', handleOutsideClick);
                    }, 100);

                    if (callback) callback();
                }

                function cerrar(modalId, callback = null) {
                    const modal = document.getElementById(modalId);
                    if (!modal) {
                        console.warn(`Modal ${modalId} no encontrado`);
                        return;
                    }

                    modal.classList.remove('show');
                    document.body.classList.remove('modal-open');

                    // Remover listener cuando se cierra
                    modal.removeEventListener('click', handleOutsideClick);

                    if (callback) callback();
                }

                function alternar(modalIdCerrar, modalIdAbrir, callbackCerrar = null, callbackAbrir = null) {
                    cerrar(modalIdCerrar, callbackCerrar);
                    abrir(modalIdAbrir, callbackAbrir);
                }

                return { abrir, cerrar, alternar };
            })();

            // ====================================================================
            // HISTORY MANAGER MODULE
            // ====================================================================
            const HistoryManager = (function () {
                let history = [];
                let currentIndex = -1;
                const MAX_HISTORY = 50;

                function deepClone(obj) {
                    if (obj === null || obj === undefined) return obj;

                    try {
                        return structuredClone(obj);

                    } catch (e) {
                        console.warn('Fallo en structuredClone. Usando fallback JSON.stringify.', e);
                        return JSON.parse(JSON.stringify(obj));
                    }
                }

                function saveState(registros) {
                    // CR√çTICO: Hacer copia profunda INMEDIATAMENTE
                    const copiaSegura = deepClone(registros);

                    // Si estamos en medio del historial (despu√©s de un undo),
                    // eliminar todos los estados "futuros"
                    if (currentIndex < history.length - 1) {
                        history.splice(currentIndex + 1);
                    }

                    // Guardar la copia profunda
                    history.push(copiaSegura);

                    // Limitar tama√±o del historial
                    if (history.length > MAX_HISTORY) {
                        history.shift();
                        currentIndex = MAX_HISTORY - 1;
                    } else {
                        currentIndex = history.length - 1;
                    }

                    updateButtons();
                    // Guardar en localStorage
                    saveToLocalStorage();
                }

                function undo() {
                    if (currentIndex > 0) {
                        currentIndex--;
                        updateButtons();
                        saveToLocalStorage();
                        const estado = deepClone(history[currentIndex]);
                        return estado;
                    }
                    return null;
                }

                function redo() {
                    if (currentIndex < history.length - 1) {
                        currentIndex++;
                        updateButtons();
                        saveToLocalStorage();
                        const estado = deepClone(history[currentIndex]);
                        return estado;
                    }
                    return null;
                }

                function canUndo() {
                    return currentIndex > 0;
                }

                function canRedo() {
                    return currentIndex < history.length - 1;
                }

                function updateButtons() {
                    const undoBtn = document.getElementById('btn-undo');
                    const redoBtn = document.getElementById('btn-redo');

                    if (undoBtn) undoBtn.disabled = !canUndo();
                    if (redoBtn) redoBtn.disabled = !canRedo();
                }

                function saveToLocalStorage() {
                    try {
                        const perfilActual = window.PerfilManager ? PerfilManager.obtenerPerfilActual() : 'default';
                        const storageKey = `history_${perfilActual}`;

                        const historyData = {
                            history: history,
                            currentIndex: currentIndex,
                            timestamp: Date.now()
                        };

                        localStorage.setItem(storageKey, JSON.stringify(historyData));
                    } catch (error) {
                        console.error('Error guardando historial:', error);
                    }
                }

                function loadFromLocalStorage() {
                    try {
                        const perfilActual = window.PerfilManager ? PerfilManager.obtenerPerfilActual() : 'default';
                        const storageKey = `history_${perfilActual}`;
                        const stored = localStorage.getItem(storageKey);

                        if (stored) {
                            const historyData = JSON.parse(stored);

                            // Verificar que el historial no tenga m√°s de 24 horas
                            const ahora = Date.now();
                            const tiempoTranscurrido = ahora - (historyData.timestamp || 0);
                            const limiteEnMs = 2 * 24 * 60 * 60 * 1000;

                            if (tiempoTranscurrido < limiteEnMs) {
                                // Historial v√°lido - restaurar
                                history = historyData.history || [];
                                currentIndex = historyData.currentIndex !== undefined ? historyData.currentIndex : -1;

                                console.log(`‚úì Historial restaurado: ${history.length} estados, √≠ndice actual: ${currentIndex}`);

                                // CR√çTICO: Si hay estados y el √≠ndice es v√°lido, retornar TRUE
                                return history.length > 0 && currentIndex >= 0;
                            } else {
                                // Historial expirado - limpiar
                                console.log('Historial expirado (m√°s de 24hs), limpiando...');
                                localStorage.removeItem(storageKey);
                                history = [];
                                currentIndex = -1;
                            }
                        }
                    } catch (error) {
                        console.error('Error cargando historial:', error);
                        history = [];
                        currentIndex = -1;
                    }

                    updateButtons();
                    return false; // No se carg√≥ historial v√°lido
                }

                function clearStorage() {
                    try {
                        const perfilActual = window.PerfilManager ? PerfilManager.obtenerPerfilActual() : 'default';
                        const storageKey = `history_${perfilActual}`;
                        localStorage.removeItem(storageKey);
                    } catch (error) {
                        console.error('Error limpiando historial:', error);
                    }
                }

                function clear() {
                    history = [];
                    currentIndex = -1;
                    clearStorage();
                    updateButtons();
                }

                function getCurrentState() {
                    if (currentIndex >= 0 && currentIndex < history.length) {
                        return deepClone(history[currentIndex]);
                    }
                    return null;
                }

                return {
                    saveState,
                    undo,
                    redo,
                    canUndo,
                    canRedo,
                    updateButtons,
                    clear,
                    saveToLocalStorage,
                    loadFromLocalStorage,
                    getCurrentState
                };
            })();

            // ====================================================================
            // TIPOS DE REGISTRO MODULE
            // ====================================================================
            const TiposRegistro = (function () {
                const TIPOS = {
                    FERIADO: {
                        id: 'feriado',
                        codigo: '00:00',
                        emoji: 'ü•≥',
                        label: 'Feriado',
                        labelPlural: 'Feriados',
                        descripcion: 'D√≠a no laboral',
                        color: 'purple',
                        contabiliza: true
                    },
                    AUSENCIA: {
                        id: 'ausencia',
                        codigo: '11:11',
                        emoji: 'üè†',
                        label: 'Licencia',
                        labelPlural: 'Licencias',
                        descripcion: 'Dia libre',
                        color: 'purple',
                        contabiliza: true
                    },
                    VACACIONES: {
                        id: 'vacaciones',
                        codigo: '12:12',
                        emoji: 'üèñÔ∏è',
                        label: 'Vacaciones',
                        labelPlural: 'Vacaciones',
                        descripcion: 'Vacaciones',
                        color: 'purple',
                        contabiliza: true
                    },
                    ASUETO: {
                        id: 'asueto',
                        codigo: '13:13',
                        emoji: 'üéÅ',
                        label: 'Asueto',
                        labelPlural: 'Asuetos',
                        descripcion: 'D√≠a de asueto',
                        color: 'purple',
                        contabiliza: true
                    },
                    ENFERMEDAD: {
                        id: 'enfermedad',
                        codigo: '14:14',
                        emoji: 'üè•',
                        label: 'Enfermedad',
                        labelPlural: 'Enfermedades',
                        descripcion: 'Enfermedad justificada',
                        color: 'purple',
                        contabiliza: true
                    },
                    PARO: {
                        id: 'paro',
                        codigo: '15:15',
                        emoji: 'üì¢',
                        label: 'Paro',
                        labelPlural: 'Paros',
                        descripcion: 'Fuerza Mayor',
                        color: 'purple',
                        contabiliza: true
                    },
                    REMOTO: {
                        id: 'remoto',
                        codigo: '16:16',
                        emoji: 'üíª',
                        label: 'Remoto',
                        labelPlural: 'Remotos',
                        descripcion: 'Trabajo desde casa',
                        color: 'purple',
                        contabiliza: true
                    },
                    CAPACITACION: {
                        id: 'capacitacion',
                        codigo: '17:17',
                        emoji: 'üìö',
                        label: 'Capacitaci√≥n',
                        labelPlural: 'Capacitaciones',
                        descripcion: 'Formacion profesional',
                        color: 'purple',
                        contabiliza: true
                    }
                };

                function esRegistroEspecial(entrada, salida) {
                    if (!entrada || !salida) return false;
                    return entrada === salida && Object.values(TIPOS).some(t => t.codigo === entrada);
                }

                function obtenerTipoPorCodigo(entrada, salida) {
                    if (!esRegistroEspecial(entrada, salida)) return null;
                    return Object.values(TIPOS).find(t => t.codigo === entrada) || null;
                }

                function obtenerTipoPorId(id) {
                    return Object.values(TIPOS).find(t => t.id === id) || null;
                }

                function validarTipoPermitido(id) {
                    return Object.values(TIPOS).some(t => t.id === id);
                }

                function obtenerTodosLosTipos() {
                    return Object.values(TIPOS);
                }

                function obtenerCodigosPorTipo(id) {
                    const tipo = obtenerTipoPorId(id);
                    return tipo ? { entrada: tipo.codigo, salida: tipo.codigo } : null;
                }

                return {
                    TIPOS,
                    esRegistroEspecial,
                    obtenerTipoPorCodigo,
                    obtenerTipoPorId,
                    validarTipoPermitido,
                    obtenerTodosLosTipos,
                    obtenerCodigosPorTipo
                };
            })();

            // ====================================================================
            // DATA MANAGEMENT MODULE 
            // ====================================================================
            const DataManagement = (function (S) {
                let registros = [], diasHabiles = [1, 2, 3, 4, 5], horasDiarias = 7, editandoId = null; let vistaActual = 'diaria';
                let filtroActivo = false;
                let filtroDesde = null;
                let filtroHasta = null;
                let filtroTipo = null;
                let grupoEnEdicion = null;

                function editarGrupo(grupo) {
                    if (grupoEnEdicion !== null) return;

                    grupoEnEdicion = {
                        registros: grupo.registros,
                        subtipo: grupo.subtipo,
                        fechaDesde: grupo.registros[grupo.registros.length - 1].fecha, // El m√°s antiguo
                        fechaHasta: grupo.registros[0].fecha // El m√°s reciente
                    };

                    $('edit-grupo-tipo').value = grupo.subtipo;
                    $('edit-grupo-desde').value = grupoEnEdicion.fechaDesde;
                    $('edit-grupo-hasta').value = grupoEnEdicion.fechaHasta;

                    ModalManager.abrir('modal-editar-grupo');

                    UILogic.setBloqueoEdicionGrupo(true);
                }

                async function guardarEdicionGrupo() {
                    if (!grupoEnEdicion) return;

                    const modal = $('modal-editar-grupo');
                    const btnGuardar = modal.querySelector('.btn-edit');
                    btnGuardar.disabled = true;

                    // ============================================
                    // 1. SANITIZACI√ìN Y CAPTURA DE INPUTS
                    // ============================================
                    const nuevoTipo = S.sanitizeString($('edit-grupo-tipo').value.trim(), 20);
                    const nuevaDesde = S.sanitizeString($('edit-grupo-desde').value.trim(), 10);
                    const nuevaHasta = S.sanitizeString($('edit-grupo-hasta').value.trim(), 10);

                    // ============================================
                    // 2. VALIDACIONES B√ÅSICAS
                    // ============================================

                    // Validar existencia
                    if (!nuevaDesde || !nuevaHasta) {
                        UILogic.mostrarToast('Verifica ambas fechas', 'error');
                        btnGuardar.disabled = false;
                        return;
                    }

                    // Validar formato
                    if (!S.validarFechaSegura(nuevaDesde)) {
                        UILogic.mostrarToast('Fecha "Desde" inv√°lida', 'error');
                        btnGuardar.disabled = false;
                        return;
                    }

                    if (!S.validarFechaSegura(nuevaHasta)) {
                        UILogic.mostrarToast('Fecha "Hasta" inv√°lida', 'error');
                        btnGuardar.disabled = false;
                        return;
                    }

                    // Validar orden
                    if (nuevaDesde > nuevaHasta) {
                        UILogic.mostrarToast('La fecha inicial debe ser inferior a la final', 'error');
                        btnGuardar.disabled = false;
                        return;
                    }

                    // ============================================
                    // 3. VALIDACI√ìN DE RANGO RAZONABLE (2 A√ëOS)
                    // ============================================
                    const hoy = new Date();
                    const fechaInicioObj = new Date(nuevaDesde.replace(/-/g, '/') + ' 00:00:00');
                    const fechaFinObj = new Date(nuevaHasta.replace(/-/g, '/') + ' 00:00:00');

                    // Permitir hasta 2 a√±os en el futuro
                    const dosPasado = new Date(hoy);
                    dosPasado.setFullYear(hoy.getFullYear() - 2);
                    const dosFuturo = new Date(hoy);
                    dosFuturo.setFullYear(hoy.getFullYear() + 2);

                    if (fechaInicioObj < dosPasado || fechaFinObj > dosFuturo) {
                        UILogic.mostrarToast(
                            'El rango debe estar entre 2 a√±os atr√°s y 2 a√±os adelante',
                            'error'
                        );
                        btnGuardar.disabled = false;
                        return;
                    }

                    // ============================================
                    // 4. VALIDACI√ìN DE TIPO
                    // ============================================
                    if (!TiposRegistro.validarTipoPermitido(nuevoTipo)) {
                        UILogic.mostrarToast('Tipo de registro inv√°lido', 'error');
                        btnGuardar.disabled = false;
                        return;
                    }

                    // ============================================
                    // 5. VALIDACI√ìN DE L√çMITE DE 60 D√çAS
                    // ============================================
                    const diffTime = Math.abs(fechaFinObj - fechaInicioObj);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

                    if (diffDays > 60) {
                        UILogic.mostrarToast(
                            `El rango contiene ${diffDays} d√≠as.\nM√°ximo: 60 d√≠as por operaci√≥n.`,
                            'error'
                        );
                        btnGuardar.disabled = false;
                        return;
                    }

                    // ============================================
                    // 6. DETECCI√ìN DE CAMBIOS
                    // ============================================
                    const huboCambios =
                        nuevoTipo !== grupoEnEdicion.subtipo ||
                        nuevaDesde !== grupoEnEdicion.fechaDesde ||
                        nuevaHasta !== grupoEnEdicion.fechaHasta;

                    if (!huboCambios) {
                        UILogic.mostrarToast('Sin cambios', 'info');
                        btnGuardar.disabled = false;
                        UILogic.cerrarEdicionGrupo();
                        return;
                    }

                    // ============================================
                    // 7. GENERAR LISTA DE FECHAS NUEVAS
                    // ============================================
                    const fechasNuevas = [];
                    let checkFecha = new Date(nuevaDesde.replace(/-/g, '/') + ' 00:00:00');
                    const checkFin = new Date(nuevaHasta.replace(/-/g, '/') + ' 00:00:00');

                    while (checkFecha <= checkFin) {
                        const y = checkFecha.getFullYear();
                        const m = String(checkFecha.getMonth() + 1).padStart(2, '0');
                        const d = String(checkFecha.getDate()).padStart(2, '0');
                        fechasNuevas.push(`${y}-${m}-${d}`);
                        checkFecha.setDate(checkFecha.getDate() + 1);
                    }

                    // ============================================
                    // 8. VALIDACI√ìN DE CONFLICTOS (OPTIMIZADA)
                    // ============================================
                    const idsDelGrupo = grupoEnEdicion.registros.map(r => r.id);
                    const conflictos = registros.filter(r =>
                        fechasNuevas.includes(r.fecha) && !idsDelGrupo.includes(r.id)
                    );

                    if (conflictos.length > 0) {
                        const diasConflicto = conflictos
                            .map(r => r.fecha.substring(8, 10))
                            .sort((a, b) => a - b)
                            .join(', ');

                        UILogic.mostrarToast(
                            `Conflicto en d√≠a(s): ${diasConflicto}\nYa existen registros en esas fechas.`,
                            'error'
                        );
                        btnGuardar.disabled = false;
                        return;
                    }

                    // ============================================
                    // 9. L√ìGICA DE ACTUALIZACI√ìN
                    // ============================================
                    registros = registros.filter(r => !idsDelGrupo.includes(r.id));

                    const codigosTipo = TiposRegistro.obtenerCodigosPorTipo(nuevoTipo);
                    const entrada = codigosTipo.entrada;
                    const salida = codigosTipo.salida;
                    const idsNuevos = [];

                    fechasNuevas.forEach(fechaISO => {
                        const t = calcularHoras(entrada, salida, null);
                        const nuevoId = S.generarIDSeguro();
                        idsNuevos.push(nuevoId);

                        registros.push({
                            id: nuevoId,
                            fecha: fechaISO,
                            entrada: entrada,
                            salida: salida,
                            tiempoFuera: null,
                            horas: t?.horas || 0,
                            minutos: t?.minutos || 0,
                            total: t?.total || 0
                        });
                    });

                    registros.sort((a, b) => {
                        if (a.fecha !== b.fecha) return b.fecha.localeCompare(a.fecha);
                        return (b.entrada || '').localeCompare(a.entrada || '');
                    });

                    HistoryManager.saveState(registros);
                    const saved = await guardarYActualizar(true, idsNuevos);

                    if (saved) {
                        UILogic.mostrarToast('Grupo actualizado', 'success');
                        btnGuardar.disabled = false;
                        UILogic.cerrarEdicionGrupo();
                    } else {
                        btnGuardar.disabled = false;
                    }
                }

                async function eliminarGrupoActual() {
                    if (!grupoEnEdicion) return;

                    // VALIDACI√ìN DE L√çMITE
                    if (grupoEnEdicion.registros.length > 60) {
                        UILogic.mostrarToast(`Este grupo contiene ${grupoEnEdicion.registros.length} registros.\nM√°ximo permitido: 60 registros por operaci√≥n.`, 'error');
                        return;
                    }

                    const idsAEliminar = grupoEnEdicion.registros.map(r => r.id);
                    registros = registros.filter(r => !idsAEliminar.includes(r.id));

                    HistoryManager.saveState(registros);
                    const saved = await guardarYActualizar();

                    if (saved) {
                        UILogic.mostrarToast('Grupo eliminado', 'success');
                        UILogic.cerrarEdicionGrupo();
                    }
                }

                function setGrupoEnEdicion(val) { grupoEnEdicion = val; }

                async function cargarConVerificacion() {
                    try {
                        const stored = localStorage.getItem('registros');
                        if (!stored) return [];
                        const data = JSON.parse(stored);

                        if (data.hash) {
                            const hashCalculado = await S.calcularHashSHA256(data.registros);

                            // comparaci√≥n segura contra timing attacks
                            if (!S.constantTimeCompare(hashCalculado, data.hash)) {
                                console.warn('‚ö†Ô∏è Integridad comprometida');
                                UILogic.mostrarToast('Advertencia de integridad', 'warning');
                                const continuar = confirm('‚ö†Ô∏è Los datos pueden haber sido modificados.\n\n¬øDeseas cargarlos de todos modos?');
                                if (!continuar) {
                                    localStorage.removeItem('registros');
                                    return [];
                                }
                            }
                        }
                        return (data.registros || []).filter(S.validarRegistroSeguro);
                    } catch (e) {
                        console.error('Error cargando:', e);
                        return [];
                    }
                }



                async function registrarDiaEspecial(fecha, tipo) {
                    // Verificar si ya existe un registro para hoy
                    const registroExistente = registros.find(r => r.fecha === fecha);

                    if (registroExistente) {
                        UILogic.mostrarToast('Ya existe un registro para hoy', 'warning');
                        throw new Error('Registro ya existe');
                    }

                    // Obtener c√≥digos del tipo especial
                    const tipoConfig = TiposRegistro.obtenerTipoPorId(tipo);
                    if (!tipoConfig) {
                        UILogic.mostrarToast('Tipo inv√°lido', 'error');
                        throw new Error('Tipo inv√°lido');
                    }

                    const entrada = tipoConfig.codigo;
                    const salida = tipoConfig.codigo;
                    const tipoTexto = `${tipoConfig.emoji} ${tipoConfig.label}`;

                    // Verificar l√≠mite
                    if (registros.length >= S.SECURITY_LIMITS.MAX_REGISTROS) {
                        UILogic.mostrarToast('L√≠mite de registros alcanzado', 'error');
                        throw new Error('L√≠mite alcanzado');
                    }

                    // Crear registro
                    const nuevoId = S.generarIDSeguro();
                    const t = calcularHoras(entrada, salida, null);

                    registros.push({
                        id: nuevoId,
                        fecha: fecha,
                        entrada: entrada,
                        salida: salida,
                        tiempoFuera: null,
                        horas: t?.horas || 0,
                        minutos: t?.minutos || 0,
                        total: t?.total || 0
                    });

                    registros.sort((a, b) => {
                        if (a.fecha !== b.fecha) return b.fecha.localeCompare(a.fecha);
                        return (b.entrada || '').localeCompare(a.entrada || '');
                    });

                    HistoryManager.saveState(registros);
                    const saved = await guardarYActualizar(true, nuevoId);

                    if (saved) {
                        UILogic.mostrarToast(`Registrado como ${tipoTexto}`, 'success');
                    } else {
                        throw new Error('Error al guardar');
                    }
                }

                async function guardarConIntegridad(regs) {
                    if (!S.saveLimiter.canProceed()) {
                        UILogic.mostrarToast('Demasiadas operaciones, espera un momento', 'warning');
                        return false;
                    }
                    try {
                        const hash = await S.calcularHashSHA256(regs);
                        const data = {
                            registros: regs,
                            hash,
                            timestamp: Date.now(),
                            version: S.SECURITY_LIMITS.SCHEMA_VERSION
                        };
                        const str = JSON.stringify(data);
                        const size = new Blob([str]).size;
                        if (size > S.SECURITY_LIMITS.MAX_JSON_SIZE) {
                            UILogic.mostrarToast('Almacenamiento lleno', 'error');
                            return false;
                        }
                        localStorage.setItem('registros', str);
                        return true;
                    } catch (e) {
                        console.error('Error guardando:', e);
                        if (e.name === 'QuotaExceededError') {
                            UILogic.mostrarToast('Espacio lleno', 'error');
                        }
                        return false;
                    }
                }

                // Dentro de DataManagement...

                async function guardarYActualizar(actualizarRegistros = true, idNuevo = null) {
                    let saveSuccessful = true;
                    // Verificamos si estamos en el perfil 'default' (el principal)
                    const esPerfilDefault = window.PerfilManager && PerfilManager.obtenerPerfilActual() === 'default';
                    // 1. Guardado Legacy (Compatibilidad hacia atr√°s)
                    if (actualizarRegistros && esPerfilDefault) {
                        saveSuccessful = await guardarConIntegridad(registros);
                    }

                    // 2. Guardado del Sistema de Perfiles
                    if (window.PerfilManager) {
                        PerfilManager.guardarDatosPerfilActual();
                    }

                    if (saveSuccessful) {
                        UILogic.actualizarUI(idNuevo);
                    }
                    return saveSuccessful;
                }

                function cargarConfiguracion() {
                    try {
                        let d = JSON.parse(localStorage.getItem('diasHabiles'));
                        const hd = parseFloat(localStorage.getItem('horasDiarias'));

                        // L√≥gica de migraci√≥n: N√∫mero antiguo vs Array nuevo
                        let diasFinal = [1, 2, 3, 4, 5]; // Default

                        if (d === null) {
                            // Default
                        } else if (typeof d === 'number') {
                            // MIGRACI√ìN: Convertir n√∫mero viejo a array
                            diasFinal = [];
                            for (let i = 1; i <= d; i++) diasFinal.push(i);
                            if (d === 7) diasFinal.push(0);
                        } else if (Array.isArray(d)) {
                            // Ya es el formato nuevo
                            diasFinal = d;
                        }

                        let t = localStorage.getItem('temaOscuro') === 'true';
                        if (localStorage.getItem('temaOscuro') === null) t = true;
                        const v = localStorage.getItem('vistaActual');

                        const horasFinal = (!isNaN(hd) && Number.isFinite(hd) && hd >= 0 && hd <= 24) ? hd : 7;

                        return {
                            diasHabiles: diasFinal,
                            horasDiarias: horasFinal,
                            temaOscuro: t,
                            vistaActual: (v === 'semana' || v === 'diaria') ? v : 'diaria'
                        };
                    } catch (e) {
                        console.error('Error config:', e);
                        return { diasHabiles: [1, 2, 3, 4, 5], horasDiarias: 7, temaOscuro: true, vistaActual: 'diaria' };
                    }
                }

                function tiempoEnMinutos(h) {
                    if (!h || !h.includes(':')) return 0;
                    const [hr, mn] = h.split(':').map(Number);
                    return (hr * 60) + mn;
                }

                function calcularHoras(e, s, tf = null, cr = null, esCalculoTemporal = false) {
                    const tfMinutos = tf ? tiempoEnMinutos(tf) : 0;
                    const crMinutos = cr ? tiempoEnMinutos(cr) : 0;

                    // NO verificar tipo especial si es c√°lculo temporal (hora actual)
                    if (!esCalculoTemporal) {
                        const tipoEspecial = TiposRegistro.obtenerTipoPorCodigo(e, s);
                        if (tipoEspecial) {
                            const resultado = { horas: 0, minutos: 0, total: horasDiarias };
                            resultado[`es${tipoEspecial.label}`] = true;
                            return resultado;
                        }
                    }

                    if (!e || !s || !e.includes(':') || !s.includes(':')) return null;

                    const [hE, mE] = e.split(':').map(Number);
                    const [hS, mS] = s.split(':').map(Number);

                    if (!Number.isFinite(hE) || !Number.isFinite(mE) || !Number.isFinite(hS) || !Number.isFinite(mS)) {
                        return null;
                    }

                    const minutosEntrada = hE * 60 + mE;
                    const minutosSalida = hS * 60 + mS;

                    let minTotal = minutosSalida - minutosEntrada;
                    if (minTotal < 0) minTotal += 24 * 60;

                    let minNeto = (minTotal - tfMinutos) + crMinutos;

                    if (minNeto < 0) minNeto = 0;

                    return { horas: Math.floor(minNeto / 60), minutos: minNeto % 60, total: minNeto / 60 };
                }

                function calcularHorasFeriadoEnRango(inicio, fin) {
                    const horasDiariasLocal = horasDiarias;
                    const diasHabilesConfig = diasHabiles;
                    let horasDescontar = 0;

                    registros.forEach(r => {
                        const tipoEspecial = TiposRegistro.obtenerTipoPorCodigo(r.entrada, r.salida);

                        // Solo descontar si es especial Y NO es remoto
                        if (r.fecha >= inicio && r.fecha <= fin && tipoEspecial) {
                            // Si es remoto, NO descontar (porque suma horas al total)
                            if (tipoEspecial.id === 'remoto') {
                                return; // Saltar este registro
                            }

                            const fechaObj = new Date(r.fecha.replace(/-/g, '/') + ' 00:00:00');
                            const diaSemana = fechaObj.getDay();

                            if (diasHabilesConfig.includes(diaSemana)) {
                                horasDescontar += horasDiariasLocal;
                            }
                        }
                    });
                    return horasDescontar;
                }

                function validarFormulario() {
                    let valido = true;
                    const fecha = $('fecha').value;
                    const entrada = $('entrada').value.trim();
                    const salida = $('salida').value.trim();

                    UILogic.limpiarError('fecha', 'error-fecha');
                    UILogic.limpiarError('entrada', 'error-entrada');
                    UILogic.limpiarError('salida', 'error-salida');

                    if (!fecha || !S.validarFechaSegura(fecha)) {
                        UILogic.mostrarError('fecha', 'error-fecha');
                        valido = false;
                    }
                    if (entrada && !S.validarHoraSegura(entrada)) {
                        UILogic.mostrarError('entrada', 'error-entrada');
                        valido = false;
                    }
                    if (salida && !S.validarHoraSegura(salida)) {
                        UILogic.mostrarError('salida', 'error-salida');
                        valido = false;
                    }
                    return valido;
                }

                async function agregarRegistro() {
                    if (!validarFormulario()) {
                        UILogic.mostrarToast('Verifica los campos', 'error');
                        return;
                    }

                    const btn = $('btn-agregar');
                    btn.disabled = true;
                    let usaHoraActual = false;

                    const f = S.sanitizeString($('fecha').value, 10);
                    let e = S.sanitizeString($('entrada').value.trim(), 5);
                    let s = S.sanitizeString($('salida').value.trim(), 5);

                    // --- VALIDACI√ìN DE FUTURO PARA NORMALES ---
                    const hoy = UILogic.obtenerFechaHoy();
                    if (f > hoy) {
                        // Verificamos si es un registro especial (estos S√ç se permiten en el futuro)
                        const esEspecial = TiposRegistro.esRegistroEspecial(e, s);

                        if (!esEspecial) {
                            UILogic.resetearBoton(btn);
                            UILogic.mostrarToast('Fecha futura no permitida en registro regular', 'warning');
                            return;
                        }
                    }

                    const registroExistente = registros.find(r => r.fecha === f);

                    if (!e && !s) {
                        const now = new Date();
                        const h = String(now.getHours()).padStart(2, '0');
                        const m = String(now.getMinutes()).padStart(2, '0');
                        const horaActual = `${h}:${m}`;

                        if (registroExistente && registroExistente.entrada && !registroExistente.salida) {
                            s = horaActual;
                            $('salida').value = s;
                            usaHoraActual = true;
                        } else {
                            e = horaActual;
                            $('entrada').value = e;
                            usaHoraActual = true;
                        }
                    }

                    if (!e && s) {
                        if (!registroExistente) {
                            UILogic.resetearBoton(btn);
                            UILogic.mostrarToast('Debes registrar una entrada primero', 'error');
                            return;
                        }

                        if (registroExistente.salida) {
                            UILogic.resetearBoton(btn);
                            UILogic.mostrarToast('Ya existe un registro completo para esta fecha', 'error');
                            return;
                        }

                        if (!registroExistente.entrada) {
                            UILogic.resetearBoton(btn);
                            UILogic.mostrarToast('Debes registrar una entrada primero', 'error');
                            return;
                        }
                    }

                    if (registroExistente && !e && s && registroExistente.entrada && !registroExistente.salida) {
                        // Capturamos si el timer fue detenido
                        const timerDetenido = detenerYRegistrarTimer(registroExistente);

                        registroExistente.salida = s;
                        let t = calcularHoras(registroExistente.entrada, s, registroExistente.tiempoFuera || null);
                        registroExistente.horas = t?.horas || 0;
                        registroExistente.minutos = t?.minutos || 0;
                        registroExistente.total = t?.total || 0;

                        HistoryManager.saveState(registros);

                        // PASAMOS EL ID DEL REGISTRO ACTUALIZADO PARA ANIMARLO
                        const saved = await guardarYActualizar(true, registroExistente.id);
                        if (saved) {
                            // FEEDBACK VISUAL (solo salida manual)
                            const salidaManual = !usaHoraActual;
                            if (salidaManual) {
                                UILogic.aplicarFeedbackRegistro(false, true); // Solo salida
                            }

                            // Mensaje diferenciado seg√∫n si hab√≠a timer activo
                            let mensaje;
                            if (timerDetenido && usaHoraActual) {
                                // Caso: Salida con hora actual Y timer activo
                                const tiempoFuera = registroExistente.tiempoFuera || '00:00';
                                mensaje = `Salida registrada con hora actual \n‚è±Ô∏è Descanso finalizado: +${tiempoFuera} \n(entrada: ${registroExistente.entrada})`;
                            } else if (usaHoraActual) {
                                // Caso: Salida con hora actual SIN timer
                                mensaje = `Salida registrada con hora actual \n(entrada: ${registroExistente.entrada})`;
                            } else {
                                // Caso: Salida manual
                                mensaje = `Salida ${s} agregada\n(entrada: ${registroExistente.entrada})`;
                            }

                            UILogic.mostrarToast(mensaje, 'success');
                            UILogic.resetearBoton(btn);
                            $('fecha').value = UILogic.obtenerFechaHoy();
                            $('salida').value = '';
                        }
                        return;
                    }

                    if (registroExistente) {
                        UILogic.resetearBoton(btn);
                        if (usaHoraActual) {
                            $('entrada').value = '';
                        }
                        UILogic.mostrarToast('Ya existe un registro para esta fecha', 'error');
                        return;
                    }

                    if (registros.length >= S.SECURITY_LIMITS.MAX_REGISTROS) {
                        UILogic.resetearBoton(btn);
                        UILogic.mostrarToast('L√≠mite alcanzado', 'error');
                        return;
                    }

                    // GENERAMOS ID
                    const nuevoId = S.generarIDSeguro();

                    const t = calcularHoras(e || null, s || null, null);
                    registros.push({
                        id: nuevoId,
                        fecha: f,
                        entrada: e || null,
                        salida: s || null,
                        tiempoFuera: null,
                        horas: t?.horas || 0,
                        minutos: t?.minutos || 0,
                        total: t?.total || 0
                    });
                    registros.sort((a, b) => {
                        if (a.fecha !== b.fecha) return b.fecha.localeCompare(a.fecha);
                        return (b.entrada || '').localeCompare(a.entrada || '');
                    });

                    HistoryManager.saveState(registros);

                    // PASAMOS EL ID NUEVO AQUI
                    const saved = await guardarYActualizar(true, nuevoId);

                    if (saved) {
                        // FEEDBACK VISUAL (entrada y/o salida manual)
                        const entradaManual = e && !usaHoraActual;
                        const salidaManual = s && !usaHoraActual;

                        if (entradaManual || salidaManual) {
                            UILogic.aplicarFeedbackRegistro(entradaManual, salidaManual);
                        }

                        const mensaje = usaHoraActual ? 'Registro agregado con hora actual' : 'Registro agregado';
                        UILogic.mostrarToast(mensaje, 'success');
                        UILogic.resetearBoton(btn);
                        $('fecha').value = UILogic.obtenerFechaHoy();
                        $('entrada').value = '';
                        $('salida').value = '';
                    }

                }

                async function eliminarRegistroActual() {
                    if (editandoId) {
                        const modal = $('modal-editar');
                        const btnEliminar = modal.querySelector('.btn-delete');
                        btnEliminar.disabled = true;
                        const registroABorrar = registros.find(r => r.id === editandoId);
                        const hoy = UILogic.obtenerFechaHoy();

                        if (registroABorrar && registroABorrar.fecha === hoy) {
                            // LIMPIAR TIMER DEL PERFIL ACTUAL
                            const perfilId = window.PerfilManager ? PerfilManager.obtenerPerfilActual() : 'default';
                            const storageKey = `breakStartTime_${perfilId}`;
                            if (localStorage.getItem(storageKey)) {
                                localStorage.removeItem(storageKey);
                                UILogic.mostrarToast('Timer detenido al borrar el registro', 'info');
                            }
                        }

                        registros = registros.filter(r => r.id !== editandoId);
                        HistoryManager.saveState(registros);

                        const saved = await guardarYActualizar();
                        btnEliminar.disabled = false;
                        btnEliminar.innerHTML = '<svg class="icon"><use href="#icon-trash"/></svg> Eliminar';

                        if (saved) {
                            UILogic.mostrarToast('Registro eliminado', 'success');
                            UILogic.cerrarEdicion();
                            // Forzamos actualizaci√≥n del bot√≥n visualmente
                            UILogic.actualizarEstadoBotonTimerMain();

                            if (window.UILogic && window.UILogic.actualizarBotonLote) {
                                window.UILogic.actualizarBotonLote();
                            }
                        }
                    }
                }

                function editarRegistro(id) {
                    // 1. Validaciones iniciales (si ya se est√° editando o no existe el ID)
                    if (editandoId !== null) return;
                    const r = registros.find(x => x.id === id);
                    if (!r) return;

                    // 2. Cargar datos en los inputs
                    editandoId = id;
                    $('edit-fecha').value = r.fecha;
                    $('edit-entrada').value = r.entrada || '';
                    $('edit-salida').value = r.salida || '';
                    $('edit-tiempo-fuera').value = r.tiempoFuera || '';

                    // 3. CONFIGURAR EL BOT√ìN DE CR√âDITO (Aqu√≠ est√° el cambio visual)
                    const btnCredito = document.getElementById('btn-toggle-credito');

                    // A) Limpieza total: Le quitamos cualquier estilo previo para empezar de cero
                    btnCredito.style.background = '';
                    btnCredito.style.color = '';
                    btnCredito.style.border = '';

                    // B) Decidir si se pinta de verde o se queda gris
                    if (r.credito && r.credito !== '00:00') {
                        // SI TIENE CR√âDITO -> Lo pintamos estilo "D√≠a H√°bil" (Verde transparente)
                        btnCredito.dataset.activo = "true";

                        btnCredito.style.background = 'rgba(96, 172, 148, 0.1)'; // Fondo transparente
                        btnCredito.style.color = 'var(--c-green)';                // Icono verde
                        btnCredito.style.border = '1px solid var(--c-green)';     // Borde fino
                    } else {
                        // NO TIENE CR√âDITO -> Se queda como est√° (Gris por defecto de CSS)
                        btnCredito.dataset.activo = "false";
                    }

                    // 4. Mostrar el modal y activar bloqueos
                    ModalManager.abrir('modal-editar');

                    UILogic.setBloqueoEdicion(true);

                    requestAnimationFrame(() => {
                        UILogic.verificarBloqueoCredito();
                    });
                }

                async function guardarEdicion() {
                    const r = registros.find(x => x.id === editandoId);
                    if (!r) return;

                    const modal = $('modal-editar');
                    const btnGuardar = modal.querySelector('.btn-edit');
                    btnGuardar.disabled = true;

                    // --- 1. OBTENER VALORES DE LOS INPUTS ---
                    const f = S.sanitizeString($('edit-fecha').value, 10);
                    const e = S.sanitizeString($('edit-entrada').value.trim(), 5);
                    const s = S.sanitizeString($('edit-salida').value.trim(), 5);

                    let tf = S.sanitizeString($('edit-tiempo-fuera').value.trim(), 5);
                    if (tf === '') tf = null;

                    // --- CALCULAR CR√âDITO SEG√öN EL BOT√ìN ---
                    let cr = null;
                    const btnCredito = document.getElementById('btn-toggle-credito');

                    // Solo calculamos si el bot√≥n existe y est√° marcado como activo
                    if (btnCredito && btnCredito.dataset.activo === "true") {
                        // Calculamos las horas trabajadas reales (sin cr√©dito)
                        const calcTemp = calcularHoras(e, s, tf, null);

                        if (calcTemp) {
                            const horasTrabajadas = calcTemp.total;
                            const horasObjetivo = horasDiarias; // Variable global de configuraci√≥n

                            // Diferencia: Lo que falta para llegar al objetivo
                            const diferencia = horasObjetivo - horasTrabajadas;

                            if (diferencia > 0.01) { // Usamos 0.01 para evitar errores de redondeo peque√±os
                                // Convertimos la diferencia a formato HH:MM
                                const h = Math.floor(diferencia);
                                const m = Math.round((diferencia - h) * 60);
                                cr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                            }
                            // Si diferencia <= 0, significa que ya cumpli√≥ el horario, as√≠ que cr se queda en null
                        }
                    }
                    // --- VALIDACI√ìN DE FUTURO PARA NORMALES ---
                    const hoy = UILogic.obtenerFechaHoy();
                    if (f > hoy) {
                        const esEspecial = TiposRegistro.esRegistroEspecial(e, s);

                        if (!esEspecial) {
                            UILogic.restaurarBotonGuardarEdicion(btnGuardar);
                            UILogic.mostrarToast('Fecha futura no permitida en registro regular', 'warning');
                            return;
                        }
                    }

                    // --- 2. DETECTAR SI HUBO CAMBIOS ---
                    const actualEntrada = r.entrada || '';
                    const nuevaEntrada = e || '';
                    const actualSalida = r.salida || '';
                    const nuevaSalida = s || '';
                    const actualTF = r.tiempoFuera || '';
                    const nuevoTF = tf || '';

                    // Comparar cr√©dito tambi√©n
                    const actualCR = r.credito || '';
                    const nuevoCR = cr || '';

                    if (r.fecha === f &&
                        actualEntrada === nuevaEntrada &&
                        actualSalida === nuevaSalida &&
                        actualTF === nuevoTF &&
                        actualCR === nuevoCR) {

                        UILogic.mostrarToast('Sin cambios', 'info');
                        UILogic.restaurarBotonGuardarEdicion(btnGuardar);
                        UILogic.cerrarEdicion();
                        return;
                    }

                    // --- 3. VALIDACIONES DE SEGURIDAD ---
                    if (!S.validarFechaSegura(f)) {
                        UILogic.restaurarBotonGuardarEdicion(btnGuardar);
                        UILogic.mostrarToast('Fecha inv√°lida', 'error');
                        return;
                    }

                    if (e && !S.validarHoraSegura(e)) {
                        UILogic.restaurarBotonGuardarEdicion(btnGuardar);
                        UILogic.mostrarToast('Hora de entrada inv√°lida', 'error');
                        return;
                    }

                    if (s && !S.validarHoraSegura(s)) {
                        UILogic.restaurarBotonGuardarEdicion(btnGuardar);
                        UILogic.mostrarToast('Hora de salida inv√°lida', 'error');
                        return;
                    }

                    if (tf && !S.validarHoraSegura(tf)) {
                        UILogic.restaurarBotonGuardarEdicion(btnGuardar);
                        UILogic.mostrarToast('Tiempo fuera inv√°lido', 'error');
                        return;
                    }

                    if (!e && s) {
                        UILogic.restaurarBotonGuardarEdicion(btnGuardar);
                        UILogic.mostrarToast('Debes registrar una entrada', 'error');
                        return;
                    }

                    // Caso: Borrar registro si todo est√° vac√≠o
                    if (!e && !s) {
                        const registroABorrar = registros.find(r => r.id === editandoId);
                        if (registroABorrar && registroABorrar.fecha === UILogic.obtenerFechaHoy()) {
                            const perfilId = window.PerfilManager ? PerfilManager.obtenerPerfilActual() : 'default';
                            const storageKey = `breakStartTime_${perfilId}`;
                            localStorage.removeItem(storageKey);
                            UILogic.actualizarEstadoBotonTimerMain();
                        }
                        registros = registros.filter(r => r.id !== editandoId);
                        HistoryManager.saveState(registros);
                        const saved = await guardarYActualizar();
                        if (saved) {
                            UILogic.mostrarToast('Registro eliminado (vac√≠o)', 'info');
                            UILogic.restaurarBotonGuardarEdicion(btnGuardar);
                            UILogic.cerrarEdicion();
                        } else {
                            UILogic.restaurarBotonGuardarEdicion(btnGuardar);
                        }
                        return;
                    }

                    // Verificar duplicados de fecha
                    const existeFecha = registros.some(reg => reg.fecha === f && reg.id !== editandoId);
                    if (existeFecha) {
                        UILogic.restaurarBotonGuardarEdicion(btnGuardar);
                        UILogic.mostrarToast('Ya existe otro registro para esa fecha', 'error');
                        return;
                    }

                    // Tiempo Fuera no puede superar tiempo trabajado
                    if (e && s && tf) {
                        const [hE, mE] = e.split(':').map(Number);
                        const [hS, mS] = s.split(':').map(Number);
                        const [hF, mF] = tf.split(':').map(Number);

                        const minutosEntrada = hE * 60 + mE;
                        const minutosSalida = hS * 60 + mS;
                        const minutosFuera = hF * 60 + mF;

                        let tiempoTranscurrido = minutosSalida - minutosEntrada;
                        if (tiempoTranscurrido < 0) tiempoTranscurrido += 24 * 60;

                        if (minutosFuera > tiempoTranscurrido) {
                            UILogic.restaurarBotonGuardarEdicion(btnGuardar);
                            UILogic.mostrarToast('El tiempo fuera no puede superar el tiempo trabajado', 'error');
                            return;
                        }
                    }

                    // --- 4. ACTUALIZAR EL OBJETO ---
                    r.fecha = f;
                    r.entrada = e || null;

                    if (s && !actualSalida) {
                        const timerDetenido = detenerYRegistrarTimer(r);
                        if (timerDetenido) tf = r.tiempoFuera;
                    }

                    r.salida = s || null;
                    r.tiempoFuera = tf;
                    r.credito = cr; // Guardamos el cr√©dito calculado

                    // --- 5. RECALCULAR TOTALES ---
                    const t = calcularHoras(r.entrada, r.salida, r.tiempoFuera, r.credito);

                    r.horas = t?.horas || 0;
                    r.minutos = t?.minutos || 0;
                    r.total = t?.total || 0;

                    // Ordenar
                    registros.sort((a, b) => {
                        if (a.fecha !== b.fecha) return b.fecha.localeCompare(a.fecha);
                        return (b.entrada || '').localeCompare(a.entrada || '');
                    });

                    HistoryManager.saveState(registros);

                    const saved = await guardarYActualizar();

                    if (saved) {
                        // Mensaje personalizado si se aplic√≥ compensaci√≥n
                        if (cr) {
                            UILogic.mostrarToast(`Guardado con Salida Temprano (+${cr})`, 'success');
                        } else {
                            UILogic.mostrarToast('Registro actualizado', 'success');
                        }
                        UILogic.restaurarBotonGuardarEdicion(btnGuardar);
                        UILogic.cerrarEdicion();
                    } else {
                        UILogic.restaurarBotonGuardarEdicion(btnGuardar);
                    }
                }

                function guardarConfig() {
                    const vd = parseFloat($('config-horas-diarias').value);

                    // Leer checkboxes y ordenar para comparar bien
                    const checkboxes = document.querySelectorAll('input[name="dia-habil"]:checked');
                    const nuevosDias = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a, b) => a - b);

                    if (nuevosDias.length === 0) {
                        UILogic.mostrarToast('Selecciona al menos un d√≠a', 'error');
                        return;
                    }
                    if (isNaN(vd) || vd < 0 || vd > 24) {
                        UILogic.mostrarToast('Horas inv√°lidas', 'error');
                        return;
                    }

                    // --- VALIDACI√ìN DE CAMBIOS (Array vs Array) ---
                    const diasActuales = [...diasHabiles].sort((a, b) => a - b);

                    // Convertimos a texto para comparar contenido real
                    const sonDiasIguales = JSON.stringify(diasActuales) === JSON.stringify(nuevosDias);

                    if (sonDiasIguales && vd === horasDiarias) {
                        UILogic.mostrarToast('Sin cambios', 'info');
                        UILogic.cerrarConfig();
                        return;
                    }
                    // Guardar en memoria
                    diasHabiles = nuevosDias;
                    horasDiarias = vd;

                    // Recalcular feriados (00:00) si cambiaron las horas
                    registros.forEach(r => {
                        if (r.entrada === '00:00' && r.salida === '00:00') {
                            const t = calcularHoras('00:00', '00:00', r.tiempoFuera || null);
                            r.horas = t?.horas || 0; r.minutos = t?.minutos || 0; r.total = t?.total || 0;
                        }
                    });

                    try {
                        const esPerfilDefault = window.PerfilManager && PerfilManager.obtenerPerfilActual() === 'default';
                        if (esPerfilDefault) {
                            localStorage.setItem('diasHabiles', JSON.stringify(diasHabiles));
                            localStorage.setItem('horasDiarias', horasDiarias);
                            localStorage.removeItem('horasSemanales');
                        }
                    } catch (e) {
                        UILogic.mostrarToast('Error al guardar', 'error');
                        return;
                    }

                    guardarYActualizar(true);
                    UILogic.mostrarToast('Configuraci√≥n guardada', 'success');
                    UILogic.cerrarConfig();
                }

                async function borrarTodoHistorial() {
                    const totalRegistros = registros.length;
                    if (totalRegistros === 0) {
                        UILogic.mostrarToast('No hay registros para borrar', 'info');
                        return;
                    }

                    const confirmar = confirm(`‚ö†Ô∏è Esto eliminar√° ${totalRegistros} registros, esta acci√≥n se guarda en el historial durante 2 dias`);

                    if (!confirmar) return;

                    //  LIMPIAR TIMER DEL PERFIL ACTUAL
                    const perfilId = window.PerfilManager ? PerfilManager.obtenerPerfilActual() : 'default';
                    const storageKey = `breakStartTime_${perfilId}`;
                    localStorage.removeItem(storageKey);

                    registros = [];
                    HistoryManager.saveState(registros);

                    if (await guardarYActualizar(true)) {
                        UILogic.actualizarUI();
                        const mensaje = totalRegistros === 1
                            ? '1 registro eliminado'
                            : `${totalRegistros} registros eliminados`;
                        UILogic.mostrarToast(mensaje, 'success');
                        UILogic.cerrarConfig();
                    }
                }

                function exportarJSON() {
                    //  Generar fecha local en formato YYYY-MM-DD HH:MM:SS
                    const ahora = new Date();
                    const a√±o = ahora.getFullYear();
                    const mes = String(ahora.getMonth() + 1).padStart(2, '0');
                    const dia = String(ahora.getDate()).padStart(2, '0');
                    const hora = String(ahora.getHours()).padStart(2, '0');
                    const minuto = String(ahora.getMinutes()).padStart(2, '0');
                    const segundo = String(ahora.getSeconds()).padStart(2, '0');

                    const fechaLocal = `${a√±o}-${mes}-${dia} ${hora}:${minuto}:${segundo}`;

                    const data = {
                        registros,
                        diasHabiles,
                        horasDiarias,
                        fecha: fechaLocal, // Fecha local sin conversi√≥n UTC
                        version: S.SECURITY_LIMITS.SCHEMA_VERSION
                    };

                    try {
                        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;

                        // Obtener y limpiar nombre del perfil
                        let nombrePerfil = 'Backup';
                        if (window.PerfilManager) {
                            nombrePerfil = window.PerfilManager.obtenerDatosPerfil().nombre;
                        }
                        const nombreSafe = nombrePerfil.replace(/[^a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë'\-_ ]/g, '').trim().replace(/\s+/g, '_');

                        //  Usar tambi√©n fecha local para el nombre del archivo
                        const fechaHoy = `${a√±o}-${mes}-${dia}`;

                        a.download = `Horarios_${nombreSafe}_${fechaHoy}.json`;

                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        UILogic.mostrarToast('Datos exportados', 'success');
                    } catch (e) {
                        console.error(e);
                        UILogic.mostrarToast('Error al exportar', 'error');
                    }
                }

                function importarDatos(modo = 'replace') {
                    const fileInput = $('file-import');
                    const file = fileInput.files[0];

                    if (!file) {
                        UILogic.mostrarToast('Selecciona un archivo primero', 'error');
                        return;
                    }
                    if (file.size > S.SECURITY_LIMITS.MAX_JSON_SIZE) {
                        UILogic.mostrarToast('Archivo muy grande', 'error');
                        return;
                    }

                    // Validaci√≥n estricta de MIME
                    if (!file.type || file.type !== 'application/json') {
                        UILogic.mostrarToast('Solo se permiten archivos JSON', 'error');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            // Validar que el contenido no est√© vac√≠o
                            const contenido = e.target.result;
                            if (!contenido || contenido.trim().length === 0) {
                                UILogic.mostrarToast('Archivo vac√≠o', 'error');
                                return;
                            }

                            // Validar tama√±o del contenido antes de parsear
                            if (contenido.length > S.SECURITY_LIMITS.MAX_JSON_SIZE) {
                                UILogic.mostrarToast('Contenido del archivo demasiado grande', 'error');
                                return;
                            }

                            // Parse seguro con protecci√≥n contra Prototype Pollution
                            const data = JSON.parse(contenido, (key, value) => {
                                if (['__proto__', 'constructor', 'prototype'].includes(key)) {
                                    console.warn('‚ö†Ô∏è Intento de prototype pollution bloqueado');
                                    return undefined;
                                }
                                return value;
                            });

                            // VALIDACI√ìN DE CLAVES PERMITIDAS (ACTUALIZADA)
                            const allowedRootKeys = [
                                'registros',
                                'diasHabiles',
                                'horasDiarias',
                                'fecha',
                                'version',
                                'hash',
                                'timestamp',
                                'rangoExportado'
                            ];
                            const dataKeys = Object.keys(data);
                            const hasInvalidKeys = dataKeys.some(k => !allowedRootKeys.includes(k));

                            if (hasInvalidKeys) {
                                UILogic.mostrarToast('Archivo con estructura sospechosa', 'error');
                                return;
                            }

                            // Validaci√≥n estricta de estructura
                            if (!data || typeof data !== 'object' || Array.isArray(data)) {
                                UILogic.mostrarToast('Estructura de archivo inv√°lida', 'error');
                                return;
                            }

                            if (!data.registros || !Array.isArray(data.registros)) {
                                UILogic.mostrarToast('Archivo inv√°lido o corrupto', 'error');
                                return;
                            }

                            // NUEVA VALIDACI√ìN: rangoExportado
                            if (data.rangoExportado !== undefined) {
                                // Sanitizar y validar formato
                                const rangoSafe = S.sanitizeString(String(data.rangoExportado), 100);

                                // Validar que solo contenga caracteres seguros
                                const regexRangoSeguro = /^[a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s\-:]+$/;
                                if (!regexRangoSeguro.test(rangoSafe)) {
                                    UILogic.mostrarToast('Metadatos de rango inv√°lidos', 'error');
                                    return;
                                }

                                // Opcional: Validar coherencia (si viene rango, verificar que los registros coincidan)
                                if (rangoSafe.includes('Mes')) {
                                    const mesMatch = rangoSafe.match(/(\d{4}-\d{2})/);
                                    if (mesMatch && data.registros.length > 0) {
                                        const mesEsperado = mesMatch[1];
                                        const todosDelMes = data.registros.every(r =>
                                            r.fecha && r.fecha.startsWith(mesEsperado)
                                        );
                                        if (!todosDelMes) {
                                            console.warn('‚ö†Ô∏è Advertencia: Registros no coinciden con el rango declarado');
                                            // No bloqueamos, solo advertimos
                                        }
                                    }
                                }
                            }

                            // Validar l√≠mite de registros antes de procesar
                            if (data.registros.length > S.SECURITY_LIMITS.MAX_REGISTROS) {
                                UILogic.mostrarToast(`M√°ximo ${S.SECURITY_LIMITS.MAX_REGISTROS} registros permitidos`, 'error');
                                return;
                            }

                            // Filtrar y normalizar datos
                            const registrosImportados = data.registros
                                .filter(r => S.validarRegistroSeguro(r))
                                .map(r => {
                                    const validarHora = (h) => h && S.REGEX_PATTERNS.HORA.test(h) ? S.sanitizeString(h, 5) : null;

                                    return {
                                        id: (r.id && S.REGEX_PATTERNS.ID.test(r.id)) ? r.id : S.generarIDSeguro(),
                                        fecha: S.sanitizeString(r.fecha, 10),
                                        entrada: validarHora(r.entrada),
                                        salida: validarHora(r.salida),
                                        tiempoFuera: validarHora(r.tiempoFuera),
                                        horas: Math.max(0, Math.min(24, parseFloat(r.horas) || 0)),
                                        minutos: Math.max(0, Math.min(59, parseFloat(r.minutos) || 0)),
                                        total: Math.max(0, Math.min(24, parseFloat(r.total) || 0)),
                                        credito: validarHora(r.credito),
                                    };
                                });

                            if (registrosImportados.length === 0) {
                                UILogic.mostrarToast('No se encontraron registros v√°lidos', 'warning');
                                return;
                            }

                            // Recalcular horas para asegurar consistencia
                            registrosImportados.forEach(r => {
                                const t = calcularHoras(r.entrada, r.salida, r.tiempoFuera || null, r.credito || null);
                                r.horas = t?.horas || 0;
                                r.minutos = t?.minutos || 0;
                                r.total = t?.total || 0;
                            });

                            // --- MODO REEMPLAZAR ---
                            if (modo === 'replace') {
                                const confirmMsg = `‚ö†Ô∏è ATENCI√ìN\n\nSe borrar√°n tus datos actuales y se reemplazar√°n por ${registrosImportados.length} registros del archivo.\n\n¬øEst√°s seguro?`;
                                if (!confirm(confirmMsg)) return;

                                registros = registrosImportados;

                                // VALIDACI√ìN MEJORADA DE diasHabiles (SOPORTA AMBOS FORMATOS)
                                if (data.diasHabiles !== undefined) {
                                    if (Array.isArray(data.diasHabiles)) {
                                        // Formato nuevo (v6.63+)
                                        const diasValidos = data.diasHabiles.filter(d =>
                                            Number.isInteger(d) && d >= 0 && d <= 6
                                        );
                                        if (diasValidos.length > 0) {
                                            diasHabiles = diasValidos;
                                        }
                                    } else {
                                        // Formato antiguo (n√∫mero)
                                        const diasParsed = parseFloat(data.diasHabiles);
                                        if (Number.isFinite(diasParsed) && diasParsed >= 1 && diasParsed <= 7) {
                                            const diasArray = [];
                                            for (let i = 1; i <= diasParsed; i++) diasArray.push(i);
                                            if (diasParsed === 7) diasArray.push(0);
                                            diasHabiles = diasArray;
                                        }
                                    }
                                }

                                // VALIDACI√ìN DE horasDiarias
                                if (data.horasDiarias !== undefined) {
                                    const horasParsed = typeof data.horasDiarias === 'string'
                                        ? parseFloat(data.horasDiarias)
                                        : data.horasDiarias;

                                    if (Number.isFinite(horasParsed) && horasParsed >= 0 && horasParsed <= 24) {
                                        horasDiarias = horasParsed;
                                    }
                                }

                                const mensaje = registrosImportados.length === 1
                                    ? 'Se reemplazaron los datos por 1 registro'
                                    : `Se reemplazaron los datos por ${registrosImportados.length} registros`;

                                finalizarImportacionAndSave(mensaje);
                            }

                            // --- MODO COMBINAR ---
                            else if (modo === 'merge') {
                                const fechasExistentes = new Set(registros.map(r => r.fecha));
                                const nuevos = registrosImportados.filter(imp => !fechasExistentes.has(imp.fecha));

                                if (nuevos.length === 0) {
                                    UILogic.mostrarToast('No hay d√≠as nuevos para agregar', 'info');
                                    return;
                                }

                                // Validar que no se exceda el l√≠mite total
                                if (registros.length + nuevos.length > S.SECURITY_LIMITS.MAX_REGISTROS) {
                                    UILogic.mostrarToast(`L√≠mite alcanzado. Solo se pueden agregar ${S.SECURITY_LIMITS.MAX_REGISTROS - registros.length} registros m√°s`, 'error');
                                    return;
                                }

                                registros = registros.concat(nuevos);

                                const mensaje = nuevos.length === 1
                                    ? 'Se agreg√≥ 1 d√≠a'
                                    : `Se agregaron ${nuevos.length} d√≠as`;

                                finalizarImportacionAndSave(mensaje);
                            }

                        } catch (err) {
                            console.error('Error en importaci√≥n:', err);
                            if (err instanceof SyntaxError) {
                                UILogic.mostrarToast('Archivo JSON mal formado', 'error');
                            } else {
                                UILogic.mostrarToast('Error al procesar el archivo', 'error');
                            }
                        }
                    };

                    // Manejar errores de lectura
                    reader.onerror = () => {
                        UILogic.mostrarToast('Error al leer el archivo', 'error');
                    };

                    reader.readAsText(file);
                }

                async function finalizarImportacionAndSave(mensajeExito) {
                    registros.sort((a, b) => {
                        if (a.fecha !== b.fecha) return b.fecha.localeCompare(a.fecha);
                        return (b.entrada || '').localeCompare(a.entrada || '');
                    });

                    HistoryManager.saveState(registros);

                    if (await guardarYActualizar()) {
                        try {

                            const esPerfilDefault = window.PerfilManager && PerfilManager.obtenerPerfilActual() === 'default';

                            if (esPerfilDefault) {
                                // Solo guardamos diasHabiles y horasDiarias (NO el tema)
                                localStorage.setItem('diasHabiles', JSON.stringify(diasHabiles));
                                localStorage.setItem('horasDiarias', horasDiarias);
                            }
                        } catch (ex) {
                            console.error('Error guardando configuraci√≥n:', ex);
                            UILogic.mostrarToast('Datos importados pero ajustes no guardados', 'warning');
                        }

                        UILogic.mostrarToast(mensajeExito, 'success');
                        UILogic.cerrarImportar();
                        UILogic.cerrarConfig();
                        $('file-import').value = '';
                    }
                }

                //  FUNCI√ìN HELPER PARA DETENER TIMER
                function detenerYRegistrarTimer(registro) {
                    const perfilId = window.PerfilManager ? PerfilManager.obtenerPerfilActual() : 'default';
                    const storageKey = `breakStartTime_${perfilId}`;
                    const storedStart = localStorage.getItem(storageKey);

                    if (!storedStart) return false; // No hay timer corriendo

                    const start = parseInt(storedStart);
                    const end = Date.now();
                    const diffMs = end - start;
                    const segundosTranscurridos = Math.floor(diffMs / 1000);

                    // Si el tiempo es menor a 30 segundos, no registrar
                    if (segundosTranscurridos < 30) {
                        localStorage.removeItem(storageKey);
                        return false;
                    }

                    // Calcular minutos con umbral de 30 segundos
                    let minutosTranscurridos = Math.floor(segundosTranscurridos / 60);
                    const segundosRestantes = segundosTranscurridos % 60;
                    if (segundosRestantes >= 30) minutosTranscurridos += 1;

                    // Sumar al tiempo existente
                    const tiempoActual = registro.tiempoFuera || '00:00';
                    registro.tiempoFuera = UILogic.sumarMinutosAHora(tiempoActual, minutosTranscurridos);

                    // Limpiar timer
                    localStorage.removeItem(storageKey);

                    return true; // Timer detenido exitosamente
                }

                function calcularBufferSemanal(inicioSemana, fechaHoy) {
                    const horasDiariasLocal = horasDiarias;
                    let buffer = 0;

                    const registrosRango = registros.filter(r => r.fecha >= inicioSemana && r.fecha <= fechaHoy);
                    const registrosMap = new Map(registrosRango.map(r => [r.fecha, r]));

                    let fechaIteracion = new Date(inicioSemana.replace(/-/g, '/') + ' 00:00:00');
                    let fechaLimite = new Date(fechaHoy.replace(/-/g, '/') + ' 00:00:00');

                    while (fechaIteracion <= fechaLimite) {
                        const y = fechaIteracion.getFullYear();
                        const m = String(fechaIteracion.getMonth() + 1).padStart(2, '0');
                        const d = String(fechaIteracion.getDate()).padStart(2, '0');
                        const isoDate = `${y}-${m}-${d}`;

                        const numDia = fechaIteracion.getDay();
                        const esDiaLaboralConfigurado = diasHabiles.includes(numDia);

                        const r = registrosMap.get(isoDate);
                        let horasObjetivoDia = 0;
                        let horasHechasDia = 0;

                        const esEspecial = r && TiposRegistro.esRegistroEspecial(r.entrada, r.salida);

                        // Validar si el registro est√° cerrado o si es un d√≠a pasado
                        const tieneSalida = r && r.salida && !esEspecial;
                        const esDiaPasado = isoDate < fechaHoy;

                        // Solo sumamos objetivo si es un d√≠a configurado Y no es especial
                        if (esDiaLaboralConfigurado && !esEspecial) {
                            // Si es un d√≠a pasado (ya termin√≥) O es hoy y ya cerraste turno, cuenta el objetivo
                            if (esDiaPasado || (isoDate === fechaHoy && tieneSalida)) {
                                horasObjetivoDia = horasDiariasLocal;
                            }
                        }

                        if (r && !esEspecial) {
                            if (r.salida) {
                                horasHechasDia = r.total;
                            }
                        }

                        buffer += (horasHechasDia - horasObjetivoDia);

                        // Sumar 1 d√≠a
                        fechaIteracion.setDate(fechaIteracion.getDate() + 1);
                    }
                    return buffer;
                }

                function aplicarFiltros() {
                    const desde = $('filtro-fecha-desde').value;
                    const hasta = $('filtro-fecha-hasta').value;
                    const tipo = $('filtro-tipo').value;

                    if (!desde && !hasta && !tipo) {
                        UILogic.mostrarToast('Selecciona al menos un filtro', 'warning');
                        return;
                    }

                    filtroActivo = true;
                    filtroDesde = desde || null;
                    filtroHasta = hasta || null;
                    filtroTipo = tipo || null;

                    guardarYActualizar(false);
                    UILogic.cerrarFiltros();

                    let mensaje = 'Filtro aplicado';
                    if (tipo) {
                        if (tipo === 'normal') {
                            mensaje += ': Normales';
                        } else {
                            const tipoConfig = TiposRegistro.obtenerTipoPorId(tipo);
                            mensaje += `: ${tipoConfig ? tipoConfig.labelPlural : tipo}`;
                        }
                    }
                    UILogic.mostrarToast(mensaje, 'success');
                    document.getElementById('btn-filtro').classList.add('filtro-activo');
                }

                function limpiarFiltros() {
                    filtroActivo = false;
                    filtroDesde = null;
                    filtroHasta = null;
                    filtroTipo = null;
                    $('filtro-fecha-desde').value = '';
                    $('filtro-fecha-hasta').value = '';
                    $('filtro-tipo').value = '';

                    guardarYActualizar(false);
                    UILogic.cerrarFiltros();
                    UILogic.mostrarToast('Filtro eliminado', 'info');
                    document.getElementById('btn-filtro').classList.remove('filtro-activo');
                }

                function obtenerRegistrosFiltrados() {
                    if (!filtroActivo) return registros;

                    return registros.filter(r => {
                        // Filtro por fechas
                        if (filtroDesde && r.fecha < filtroDesde) return false;
                        if (filtroHasta && r.fecha > filtroHasta) return false;

                        if (filtroTipo) {
                            const tipoRegistro = TiposRegistro.obtenerTipoPorCodigo(r.entrada, r.salida);

                            if (filtroTipo === 'normal') {
                                // Si el filtro es "normal", excluir todos los especiales
                                if (tipoRegistro) return false;
                            } else {
                                // Si el filtro es un tipo especial, solo mostrar ese tipo
                                if (!tipoRegistro || tipoRegistro.id !== filtroTipo) return false;
                            }
                        }

                        return true;
                    });
                }

                async function registrarVacacionesDirecto(desde, hasta, tipo) {
                    const tipoConfig = TiposRegistro.obtenerTipoPorId(tipo);
                    if (!tipoConfig) {
                        UILogic.mostrarToast('Tipo inv√°lido', 'error');
                        throw new Error('Tipo inv√°lido');
                    }

                    const entrada = tipoConfig.codigo;
                    const salida = tipoConfig.codigo;

                    let fechaActual = new Date(desde.replace(/-/g, '/') + ' 00:00:00');
                    const fechaFin = new Date(hasta.replace(/-/g, '/') + ' 00:00:00');
                    const fechasARegistrar = [];

                    while (fechaActual <= fechaFin) {
                        const y = fechaActual.getFullYear();
                        const m = String(fechaActual.getMonth() + 1).padStart(2, '0');
                        const d = String(fechaActual.getDate()).padStart(2, '0');
                        fechasARegistrar.push(`${y}-${m}-${d}`);
                        fechaActual.setDate(fechaActual.getDate() + 1);
                    }

                    // VALIDACI√ìN DE L√çMITE
                    if (fechasARegistrar.length > 60) {
                        UILogic.mostrarToast(`El rango seleccionado contiene ${fechasARegistrar.length} d√≠as.\n M√°ximo permitido: 60 d√≠as por operaci√≥n.`, 'error');
                        throw new Error('L√≠mite de d√≠as excedido');
                    }

                    const nuevosRegistros = fechasARegistrar.filter(f => !registros.some(r => r.fecha === f));

                    if (nuevosRegistros.length === 0) {
                        UILogic.mostrarToast('Todas las fechas ya est√°n registradas', 'warning');
                        throw new Error('Sin fechas nuevas');
                    }

                    //  1: Creamos array para guardar IDs ---
                    const idsNuevosParaAnimar = [];

                    nuevosRegistros.forEach(fecha => {
                        const t = calcularHoras(entrada, salida, null);
                        const nuevoId = S.generarIDSeguro(); // Generamos ID

                        idsNuevosParaAnimar.push(nuevoId); // Lo guardamos para animar

                        registros.push({
                            id: nuevoId,
                            fecha: fecha,
                            entrada: entrada,
                            salida: salida,
                            tiempoFuera: null,
                            horas: t?.horas || 0,
                            minutos: t?.minutos || 0,
                            total: t?.total || 0
                        });
                    });

                    registros.sort((a, b) => {
                        if (a.fecha !== b.fecha) return b.fecha.localeCompare(a.fecha);
                        return (b.entrada || '').localeCompare(a.entrada || '');
                    });

                    HistoryManager.saveState(registros);

                    //  2: Enviamos el array de IDs a la UI ---
                    const saved = await guardarYActualizar(true, idsNuevosParaAnimar);

                    if (saved) {
                        const mensaje = nuevosRegistros.length === 1
                            ? '1 d√≠a registrado'
                            : `${nuevosRegistros.length} d√≠as registrados`;
                        UILogic.mostrarToast(mensaje, 'success');
                        if (UILogic.actualizarBotonLote) {
                            UILogic.actualizarBotonLote();
                        }
                    } else {
                        throw new Error('Error al guardar');
                    }
                }

                async function borrarPeriodoDirecto(desde, hasta) {
                    // Solo borra registros normales (eliminamos par√°metro 'tipo')
                    const registrosAEliminar = registros.filter(r => {
                        if (r.fecha < desde || r.fecha > hasta) return false;

                        // Excluir todos los tipos especiales
                        const esEspecial = TiposRegistro.esRegistroEspecial(r.entrada, r.salida);

                        return !esEspecial;
                    });

                    if (registrosAEliminar.length > 60) {
                        UILogic.mostrarToast(`M√°ximo 60 registros. Encontrados: ${registrosAEliminar.length}`, 'error');
                        throw new Error('L√≠mite excedido');
                    }

                    if (registrosAEliminar.length === 0) {
                        UILogic.mostrarToast('No hay registros normales en ese per√≠odo', 'info');
                        throw new Error('Sin registros');
                    }

                    registros = registros.filter(r => !registrosAEliminar.includes(r));
                    HistoryManager.saveState(registros);

                    const saved = await guardarYActualizar();
                    if (saved) {
                        const mensaje = registrosAEliminar.length === 1
                            ? '1 registro eliminado'
                            : `${registrosAEliminar.length} registros eliminados`;
                        UILogic.mostrarToast(mensaje, 'success');
                        UILogic.actualizarBotonLote?.();
                    } else {
                        throw new Error('Error al guardar');
                    }
                }

                return {
                    registros: () => registros,
                    horasSemanales: () => (horasDiarias * diasHabiles.length),
                    diasHabiles: () => diasHabiles,
                    horasDiarias: () => horasDiarias,
                    setDiasHabiles: (v) => diasHabiles = v,
                    setHorasDiarias: (v) => horasDiarias = v,
                    editandoId: () => editandoId,
                    setEditandoId: (id) => editandoId = id,
                    vistaActual: () => vistaActual,
                    setVistaActual: (v) => vistaActual = v,
                    cargarConVerificacion,
                    cargarConfiguracion,
                    calcularHoras,
                    calcularHorasFeriadoEnRango,
                    guardarYActualizar,
                    agregarRegistro,
                    eliminarRegistroActual,
                    editarRegistro,
                    guardarEdicion,
                    guardarConfig,
                    borrarTodoHistorial,
                    exportarJSON,
                    importarDatos,
                    calcularBufferSemanal,
                    aplicarFiltros,
                    limpiarFiltros,
                    obtenerRegistrosFiltrados,
                    registrarVacacionesDirecto,
                    borrarPeriodoDirecto,
                    registrarDiaEspecial,
                    editarGrupo,
                    guardarEdicionGrupo,
                    eliminarGrupoActual,
                    setGrupoEnEdicion: (val) => grupoEnEdicion = val,
                    undoAction: function () {
                        const prevState = HistoryManager.undo();
                        if (prevState) {
                            registros.splice(0, registros.length, ...prevState);
                            guardarYActualizar();
                            UILogic.mostrarToast('Deshecho', 'info');

                            // Solo actualizar si estamos en modo lote
                            if (window.UILogic && window.UILogic.actualizarBotonLote) {
                                // Verificar si el modo lote est√° activo
                                const modoLote = document.getElementById('modo-lote');
                                if (modoLote && modoLote.style.display !== 'none') {
                                    window.UILogic.actualizarBotonLote();
                                }
                            }

                            // Iniciar timer de auto-cierre
                            if (window.UILogic && window.UILogic.iniciarTimerAutoCierreBotones) {
                                window.UILogic.iniciarTimerAutoCierreBotones();
                            }
                        }
                    },

                    redoAction: function () {
                        const nextState = HistoryManager.redo();
                        if (nextState) {
                            registros.splice(0, registros.length, ...nextState);
                            guardarYActualizar();
                            UILogic.mostrarToast('Rehecho', 'info');

                            // Solo actualizar si estamos en modo lote
                            if (window.UILogic && window.UILogic.actualizarBotonLote) {
                                // Verificar si el modo lote est√° activo
                                const modoLote = document.getElementById('modo-lote');
                                if (modoLote && modoLote.style.display !== 'none') {
                                    window.UILogic.actualizarBotonLote();
                                }
                            }

                            // Iniciar timer de auto-cierre
                            if (window.UILogic && window.UILogic.iniciarTimerAutoCierreBotones) {
                                window.UILogic.iniciarTimerAutoCierreBotones();
                            }
                        }
                    }
                };

            })(SecurityAndUtils);

            // ====================================================================
            // UI LOGIC MODULE
            // ====================================================================

            const UILogic = (function (S, D) {

                let toastTimeout = null;
                let intervaloPulsacion = null;
                let timeoutInicial = null;
                let edicionBloqueada = true;
                let edicionGrupoBloqueada = true;
                let perfilEnEdicion = null;
                let modoLoteActivo = false;
                let tiempoExpansionBotones = null;
                let timerAutoCierreBotones = null;

                // FUNCI√ìN DEBOUNCE REUTILIZABLE
                function debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                }

                function mostrarError(inputId, errorId) {
                    const input = $(inputId);
                    const error = $(errorId);
                    if (input) input.classList.add('error');
                    if (error) error.style.display = 'block';
                }

                function limpiarError(inputId, errorId) {
                    const input = $(inputId);
                    const error = $(errorId);
                    if (input) input.classList.remove('error');
                    if (error) error.style.display = 'none';
                }

                function mostrarToast(mensaje, tipo = 'info') {
                    const toast = $('toast');
                    const textoLimpio = S.sanitizeString(mensaje, 200);

                    // Limpiar timeouts anteriores
                    if (toastTimeout) {
                        clearTimeout(toastTimeout);
                        toastTimeout = null;
                    }

                    // Remover clase show si existe (para reset de animaci√≥n)
                    toast.classList.remove('show');

                    // Actualizar contenido y tipo
                    toast.textContent = textoLimpio;
                    toast.className = `toast ${tipo}`;

                    // Mostrar toast despu√©s de un peque√±o delay (para permitir reset)
                    setTimeout(() => toast.classList.add('show'), 10);

                    // Programar ocultaci√≥n
                    toastTimeout = setTimeout(() => {
                        toast.classList.remove('show');
                        toastTimeout = null;
                    }, 3000);
                }

                function resetearBoton(btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<svg class="icon"><use href="#icon-save"/></svg> <span id="btn-registrar-texto">Registrar</span>';
                }

                function restaurarBotonGuardarEdicion(btnGuardar) {
                    btnGuardar.disabled = false;
                    btnGuardar.innerHTML = '<svg class="icon"><use href="#icon-save"/></svg> Guardar';
                }

                function obtenerFechaHoy() {
                    const now = new Date();
                    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                }

                function obtenerNombreDia(f) {
                    if (!f) return '';
                    const dias = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                    try {
                        const [y, m, d] = f.split('-').map(Number);
                        const date = new Date(y, m - 1, d);
                        if (isNaN(date.getTime())) return '';
                        return dias[date.getDay()];
                    } catch (e) { return ''; }
                }

                function obtenerSemanaActual() {
                    const hoy = new Date();

                    // Normalizar a medianoche LOCAL (evita problemas de zona horaria)
                    hoy.setHours(0, 0, 0, 0);

                    const diaSemana = hoy.getDay(); // 0=Domingo, 1=Lunes...

                    // Calcular offset al lunes (sin mutar el objeto original)
                    const offsetLunes = diaSemana === 0 ? -6 : 1 - diaSemana;

                    // Crear NUEVA instancia para el lunes
                    const lunes = new Date(hoy);
                    lunes.setDate(hoy.getDate() + offsetLunes);

                    // Crear NUEVA instancia para el domingo
                    const domingo = new Date(lunes);
                    domingo.setDate(lunes.getDate() + 6);

                    // Formatear a YYYY-MM-DD en hora local (no UTC)
                    const formatearFecha = (fecha) => {
                        const y = fecha.getFullYear();
                        const m = String(fecha.getMonth() + 1).padStart(2, '0');
                        const d = String(fecha.getDate()).padStart(2, '0');
                        return `${y}-${m}-${d}`;
                    };

                    return {
                        inicio: formatearFecha(lunes),
                        fin: formatearFecha(domingo)
                    };
                }

                function obtenerLunesSemana(fecha) {
                    const date = new Date(fecha.replace(/-/g, '/') + ' 00:00:00');
                    const dia = date.getDay();
                    const offset = dia === 0 ? -6 : 1 - dia;
                    const lunes = new Date(date);
                    lunes.setDate(date.getDate() + offset);
                    return lunes.toISOString().split('T')[0];
                }

                function horasATexto(t) {
                    const totalHoras = Math.max(0, t);

                    const h = Math.floor(totalHoras);
                    const m = Math.round((totalHoras - h) * 60);

                    let partes = [];

                    if (h > 0) {
                        partes.push(`${h} ${h === 1 ? 'hora' : 'horas'}`);
                    }

                    if (m > 0) {
                        partes.push(`${m} ${m === 1 ? 'minuto' : 'minutos'}`);
                    } else if (h === 0 && m === 0) {
                        partes.push('0 minutos');
                    }

                    return partes.join(' ');
                }

                function formatoDiferencia(tiempoTotalHoras) {
                    const horasDiarias = D.horasDiarias();
                    const objetivoMinutos = horasDiarias * 60;
                    const actualMinutos = Math.round(tiempoTotalHoras * 60);
                    let diferenciaMinutos = actualMinutos - objetivoMinutos;
                    if (diferenciaMinutos === 0) return '';
                    const signo = diferenciaMinutos > 0 ? '+' : '-';
                    const absMinutos = Math.abs(diferenciaMinutos);
                    const h = Math.floor(absMinutos / 60);
                    const m = absMinutos % 60;
                    let diferenciaTexto = '';
                    if (h > 0) diferenciaTexto += `${h}h`;
                    if (m > 0 || h === 0) {
                        if (h > 0) diferenciaTexto += ' ';
                        diferenciaTexto += `${m}m`;
                    }
                    if (diferenciaTexto === '') return '';
                    return `${signo}${diferenciaTexto}`;
                }

                function formatoTituloMes(claveMes) {
                    const [a√±o, mes] = claveMes.split('-');
                    const fecha = new Date(a√±o, mes - 1, 1);
                    const opciones = { month: 'long', year: 'numeric' };
                    let nombre = fecha.toLocaleDateString('es-ES', opciones);
                    return nombre.charAt(0).toUpperCase() + nombre.slice(1);
                }

                function agruparRegistrosPorMes(registros) {
                    // Validar entrada
                    if (!Array.isArray(registros)) {
                        console.warn('agruparRegistrosPorMes: entrada inv√°lida');
                        return new Map();
                    }

                    const grupos = new Map();
                    registros.forEach(r => {
                        // Validar cada registro
                        if (!r || typeof r !== 'object' || !r.fecha || typeof r.fecha !== 'string') {
                            return;
                        }

                        // Validar longitud m√≠nima
                        if (r.fecha.length < 7) {
                            return;
                        }

                        const claveMes = r.fecha.substring(0, 7);
                        if (!grupos.has(claveMes)) {
                            grupos.set(claveMes, []);
                        }
                        grupos.get(claveMes).push(r);
                    });
                    return grupos;
                }

                // Funci√≥n auxiliar para identificar tipo de registro
                function obtenerTipoRegistro(registro) {
                    if (!registro) return null;

                    const tipo = TiposRegistro.obtenerTipoPorCodigo(registro.entrada, registro.salida);
                    return tipo ? tipo.id : null; // Retorna el id o null si es normal
                }

                // Funci√≥n auxiliar para verificar si una fecha es consecutiva a otra
                function esFechaConsecutiva(fechaActual, fechaSiguiente) {
                    const actual = new Date(fechaActual.replace(/-/g, '/') + ' 00:00:00');
                    const siguiente = new Date(fechaSiguiente.replace(/-/g, '/') + ' 00:00:00');

                    // Sumar 1 d√≠a a la fecha actual
                    actual.setDate(actual.getDate() - 1);

                    return actual.toISOString().split('T')[0] === fechaSiguiente;
                }

                // Funci√≥n principal mejorada
                function agruparRegistrosConsecutivos(registros) {
                    if (!registros || registros.length === 0) return [];

                    const resultado = [];
                    let i = 0;

                    while (i < registros.length) {
                        const registroActual = registros[i];
                        const tipoActual = obtenerTipoRegistro(registroActual);

                        // Si es un registro normal, agregar individualmente
                        if (tipoActual === null) {
                            resultado.push({
                                tipo: 'individual',
                                registros: [registroActual]
                            });
                            i++;
                            continue;
                        }

                        // Buscar registros consecutivos del mismo tipo
                        const grupo = [registroActual];
                        let j = i + 1;

                        while (j < registros.length) {
                            const registroSiguiente = registros[j];
                            const tipoSiguiente = obtenerTipoRegistro(registroSiguiente);

                            // Si cambi√≥ el tipo, terminar el grupo
                            if (tipoSiguiente !== tipoActual) break;

                            // Verificar si es fecha consecutiva
                            const ultimaFecha = grupo[grupo.length - 1].fecha;
                            if (!esFechaConsecutiva(ultimaFecha, registroSiguiente.fecha)) break;

                            // Agregar al grupo
                            grupo.push(registroSiguiente);
                            j++;
                        }

                        // Agregar al resultado (grupo o individual)
                        if (grupo.length > 1) {
                            resultado.push({
                                tipo: 'grupo',
                                subtipo: tipoActual,
                                registros: grupo
                            });
                        } else {
                            resultado.push({
                                tipo: 'individual',
                                registros: grupo
                            });
                        }

                        i = j;
                    }

                    return resultado;
                }

                function crearItemRegistroIndividual(r, horasDiarias, idResaltar = null) {
                    const item = document.createElement('div');
                    const hoy = obtenerFechaHoy();

                    let className = r.fecha === hoy ? 'registro-item hoy' : 'registro-item';

                    if (idResaltar && r.id === idResaltar) {
                        className += ' nuevo-registro-animacion';
                    }

                    item.className = className;
                    item.dataset.registroId = r.id;
                    item.dataset.accion = 'editar-registro';

                    const info = document.createElement('div');
                    info.className = 'registro-info';

                    const tipoEspecial = TiposRegistro.obtenerTipoPorCodigo(r.entrada, r.salida);

                    const fechaEl = document.createElement('div');
                    fechaEl.className = 'registro-fecha';

                    let etiqueta = '';
                    if (tipoEspecial) {
                        etiqueta = ` ${tipoEspecial.emoji} (${tipoEspecial.label})`;
                    }

                    fechaEl.textContent = `${obtenerNombreDia(r.fecha)} ${r.fecha.substring(8)}${etiqueta}`;
                    // --- VISUALIZACI√ìN DE EXTRAS ---
                    const tfText = r.tiempoFuera && r.tiempoFuera !== '' ? ` (${r.tiempoFuera} Fuera)` : '';
                    const crText = r.credito && r.credito !== '00:00' ? ' (Salida Temprano)' : '';

                    const horasEl = document.createElement('div');
                    horasEl.className = 'registro-horas';

                    if (tipoEspecial) {
                        horasEl.textContent = tipoEspecial.descripcion;
                    } else {
                        horasEl.textContent = `${r.entrada || '-'} ‚Üí ${r.salida || '-'}${tfText}${crText}`;
                    }

                    const totalEl = document.createElement('div');
                    totalEl.className = 'registro-total';
                    let totalText = 'Incompleto';
                    totalEl.classList.remove('green-text', 'red-text', 'purple-text');

                    if (tipoEspecial) {
                        totalText = 'Justificado';
                        totalEl.classList.add('purple-text');
                    } else if (r.entrada && r.salida) {
                        totalText = `${r.horas}h ${r.minutos}m`;

                        if (horasDiarias === 0) {
                            // Sin color
                        } else {
                            const diffText = formatoDiferencia(r.total);
                            if (r.total >= horasDiarias) {
                                totalEl.classList.add('green-text');
                            } else {
                                totalEl.classList.add('red-text');
                            }
                            if (diffText) totalText += ` (${diffText})`;
                        }
                    } else if (r.entrada && !r.salida) {
                        const esHoy = r.fecha === hoy;
                        if (esHoy) {
                            totalText = 'En curso . . .';
                            totalEl.classList.add('blue-text');
                        } else {
                            totalText = 'Incompleto';
                            totalEl.classList.add('yellow-text');
                        }
                    } else {
                        totalText = 'Sin datos';
                    }

                    totalEl.textContent = totalText;
                    info.appendChild(fechaEl);
                    info.appendChild(horasEl);
                    info.appendChild(totalEl);
                    item.appendChild(info);

                    return item;
                }

                function setProgressBarColor(progressEl, status) {
                    if (!progressEl) return;
                    progressEl.className = 'progress-fill';
                    progressEl.classList.add(status);
                }

                function actualizarListaRegistros(registros, idNuevo = null) {
                    const lista = $('lista-registros');

                    // 2. Guardar estado de meses abiertos
                    const mesesExpandidos = new Set();
                    lista.querySelectorAll('.registro-mes-container').forEach(container => {
                        const detalle = container.querySelector('.registro-mes-detalle');
                        if (detalle && detalle.classList.contains('expanded')) {
                            const header = container.querySelector('.registro-mes-header');
                            if (header && header.dataset.mesId) {
                                mesesExpandidos.add(header.dataset.mesId);
                            }
                        }
                    });

                    lista.innerHTML = '';
                    const horasDiarias = D.horasDiarias();
                    const registrosAMostrar = D.obtenerRegistrosFiltrados();

                    if (registrosAMostrar.length === 0) {
                        lista.innerHTML = '<div class="empty-state">No hay registros</div>';
                        return;
                    }

                    const gruposPorMes = agruparRegistrosPorMes(registrosAMostrar);
                    const fragmento = document.createDocumentFragment();

                    const hoy = obtenerFechaHoy();
                    const mesHoy = hoy.substring(0, 7);

                    gruposPorMes.forEach((registrosDelMes, claveMes) => {
                        const grupos = agruparRegistrosConsecutivos(registrosDelMes);

                        // Contenedor Mes
                        const contenedorMesActual = document.createElement('div');
                        contenedorMesActual.className = 'registro-mes-container';

                        // Header Mes
                        const headerMes = document.createElement('h3');
                        headerMes.className = 'registro-mes-header';
                        headerMes.dataset.mesId = claveMes;

                        const chevron = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                        chevron.setAttribute('class', 'icon chevron-mes');
                        chevron.setAttribute('viewBox', '0 0 24 24');
                        chevron.style.width = '1.2em';
                        chevron.style.height = '1.2em';
                        chevron.style.verticalAlign = 'middle';
                        const use = document.createElementNS('http://www.w3.org/2000/svg', 'use');
                        use.setAttribute('href', '#icon-chevron-down');
                        chevron.appendChild(use);

                        const textoMes = document.createTextNode(' ' + formatoTituloMes(claveMes));
                        headerMes.appendChild(chevron);
                        headerMes.appendChild(textoMes);

                        // Detalle Mes
                        const detalleMesActual = document.createElement('div');
                        detalleMesActual.className = 'registro-mes-detalle';

                        //  L√ìGICA DE APERTURA CON LOCALSTORAGE
                        let debeEstarExpandido = false;

                        try {
                            const estadoGuardado = localStorage.getItem(`mes-${claveMes}-expandido`);

                            if (estadoGuardado !== null) {
                                // Si hay estado guardado, usarlo
                                debeEstarExpandido = estadoGuardado === 'true';
                            } else {
                                // Si no hay estado guardado (primera vez), abrir solo el mes actual
                                debeEstarExpandido = (claveMes === mesHoy);
                            }
                        } catch (e) {
                            // Fallback: abrir solo mes actual
                            debeEstarExpandido = (claveMes === mesHoy);
                        }

                        if (debeEstarExpandido) {
                            detalleMesActual.classList.add('expanded');
                            chevron.style.transform = 'rotate(180deg)';
                        }

                        // --- BUCLE PRINCIPAL DE ITEMS ---
                        let semanaAnterior = null;

                        grupos.forEach(grupo => {
                            // ... resto del c√≥digo sin cambios ...
                            if (grupo.tipo === 'grupo') {
                                const primerRegistro = grupo.registros[grupo.registros.length - 1]; // El m√°s antiguo del grupo
                                const semanaActual = obtenerLunesSemana(primerRegistro.fecha);

                                // Si cambi√≥ la semana, insertar separador
                                if (semanaAnterior && semanaActual !== semanaAnterior) {
                                    const separador = document.createElement('div');
                                    separador.className = 'separador-semana';
                                    detalleMesActual.appendChild(separador);
                                }

                                const container = crearGrupoExpandible(grupo, horasDiarias, idNuevo);
                                detalleMesActual.appendChild(container);

                                semanaAnterior = semanaActual;
                            } else {
                                const r = grupo.registros[0];
                                const semanaActual = obtenerLunesSemana(r.fecha);

                                // Si cambi√≥ la semana, insertar separador
                                if (semanaAnterior && semanaActual !== semanaAnterior) {
                                    const separador = document.createElement('div');
                                    separador.className = 'separador-semana';
                                    detalleMesActual.appendChild(separador);
                                }

                                const item = crearItemRegistroIndividual(r, horasDiarias, idNuevo);
                                detalleMesActual.appendChild(item);

                                semanaAnterior = semanaActual;
                            }
                        });

                        // Preparar datos para event delegation
                        headerMes.dataset.accion = 'toggle-mes';
                        headerMes.dataset.mesContainer = claveMes; // ID √∫nico del mes

                        contenedorMesActual.appendChild(headerMes);
                        contenedorMesActual.appendChild(detalleMesActual);
                        fragmento.appendChild(contenedorMesActual);
                    });

                    lista.appendChild(fragmento);
                }

                function crearGrupoExpandible(grupo, horasDiarias, idResaltar = null) {
                    const primerReg = grupo.registros[0];
                    const ultimoReg = grupo.registros[grupo.registros.length - 1];

                    const container = document.createElement('div');
                    container.className = 'registro-grupo-container';

                    // Encabezado del grupo
                    const header = document.createElement('div');

                    // --- L√≥gica de detecci√≥n de IDs nuevos ---
                    let className = 'registro-item';
                    let animarGrupo = false;

                    if (idResaltar) {
                        const idsNuevos = Array.isArray(idResaltar) ? idResaltar : [idResaltar];
                        const contieneNuevo = grupo.registros.some(r => idsNuevos.includes(r.id));
                        if (contieneNuevo) {
                            animarGrupo = true;
                        }
                    }

                    if (animarGrupo) {
                        className += ' nuevo-registro-animacion';
                    }
                    header.className = className;

                    const info = document.createElement('div');
                    info.className = 'registro-info';

                    const fechaEl = document.createElement('div');
                    fechaEl.className = 'registro-fecha';

                    const tipoConfig = TiposRegistro.obtenerTipoPorId(grupo.subtipo);
                    const emoji = tipoConfig ? tipoConfig.emoji : 'üìÖ';
                    const label = tipoConfig ? tipoConfig.labelPlural : 'Registros';

                    fechaEl.textContent = `${emoji} ${label} (${grupo.registros.length} d√≠as)`;

                    const horasEl = document.createElement('div');
                    horasEl.className = 'registro-horas';
                    const rangoFechas = `${ultimoReg.fecha.substring(8)} al ${primerReg.fecha.substring(8)}`;
                    horasEl.textContent = rangoFechas;

                    const totalEl = document.createElement('div');
                    totalEl.className = 'registro-total purple-text';
                    totalEl.textContent = 'Justificado';

                    info.appendChild(fechaEl);
                    info.appendChild(horasEl);
                    info.appendChild(totalEl);
                    header.appendChild(info);

                    // Preparar datos para event delegation
                    header.dataset.accion = 'editar-grupo';
                    header.dataset.grupoData = JSON.stringify({
                        registros: grupo.registros.map(r => r.id),
                        subtipo: grupo.subtipo
                    });

                    container.appendChild(header);
                    return container;
                }

                function calcularEstadisticasMes(mesAnio = null) {
                    // Si no se especifica mes, usar el actual
                    let mesActual, a√±oActual;

                    if (mesAnio) {
                        const [a√±o, mes] = mesAnio.split('-').map(Number);
                        a√±oActual = a√±o;
                        mesActual = mes - 1;
                    } else {
                        const hoy = new Date();
                        mesActual = hoy.getMonth();
                        a√±oActual = hoy.getFullYear();
                    }

                    const registrosMes = D.registros().filter(r => {
                        const [a√±o, mes] = r.fecha.split('-').map(Number);
                        return a√±o === a√±oActual && mes === mesActual + 1;
                    });

                    // Contadores b√°sicos usando tipos centralizados
                    const contarPorTipo = (tipoId) => {
                        const tipo = TiposRegistro.obtenerTipoPorId(tipoId);
                        if (!tipo) return 0;
                        return registrosMes.filter(r => r.entrada === tipo.codigo && r.salida === tipo.codigo).length;
                    };

                    const feriados = contarPorTipo('feriado');
                    const ausencias = contarPorTipo('ausencia');
                    const vacaciones = contarPorTipo('vacaciones');
                    const enfermedades = contarPorTipo('enfermedad');
                    const asuetosDiaCompleto = contarPorTipo('asueto');
                    const paros = contarPorTipo('paro');
                    const remotos = contarPorTipo('remoto');
                    const capacitaciones = contarPorTipo('capacitacion');

                    // Contar Compensaciones/Asuetos parciales (d√≠as con cr√©dito v√°lido)
                    const compensaciones = registrosMes.filter(r => r.credito && r.credito !== '00:00').length;

                    // Calcular tiempo fuera total
                    let tiempoFueraTotalMinutos = 0;
                    registrosMes.forEach(r => {
                        if (r.tiempoFuera && r.tiempoFuera !== '00:00') {
                            const [h, m] = r.tiempoFuera.split(':').map(Number);
                            if (!isNaN(h) && !isNaN(m)) {
                                tiempoFueraTotalMinutos += (h * 60) + m;
                            }
                        }
                    });

                    const hTiempoFuera = Math.floor(tiempoFueraTotalMinutos / 60);
                    const mTiempoFuera = tiempoFueraTotalMinutos % 60;

                    // Filtrar solo registros v√°lidos para promedios (excluir registros especiales)
                    const registrosValidos = registrosMes.filter(r =>
                        r.entrada && r.salida &&
                        !TiposRegistro.esRegistroEspecial(r.entrada, r.salida)
                    );

                    if (registrosValidos.length === 0) {
                        return {
                            entradaPromedio: '--:--',
                            salidaPromedio: '--:--',
                            diasTrabajados: 0,
                            promedioDiario: '--:--',
                            tiempoFueraTotal: `--:--`,
                            semanaPasada: '--:--',
                            feriados: feriados,
                            ausencias: ausencias,
                            vacaciones: vacaciones,
                            enfermedades: enfermedades,
                            asuetosDiaCompleto: asuetosDiaCompleto,
                            compensaciones: compensaciones,
                            paros: paros,
                            remotos: remotos,
                            capacitaciones: capacitaciones
                        };
                    }

                    // C√°lculos de promedios (Entrada)
                    let sumaMinutosEntrada = 0;
                    registrosValidos.forEach(r => {
                        const [h, m] = r.entrada.split(':').map(Number);
                        sumaMinutosEntrada += h * 60 + m;
                    });
                    const promedioEntrada = Math.round(sumaMinutosEntrada / registrosValidos.length);
                    const hEntrada = Math.floor(promedioEntrada / 60);
                    const mEntrada = promedioEntrada % 60;

                    // C√°lculos de promedios (Salida)
                    let sumaMinutosSalida = 0;
                    registrosValidos.forEach(r => {
                        const [h, m] = r.salida.split(':').map(Number);
                        sumaMinutosSalida += h * 60 + m;
                    });
                    const promedioSalida = Math.round(sumaMinutosSalida / registrosValidos.length);
                    const hSalida = Math.floor(promedioSalida / 60);
                    const mSalida = promedioSalida % 60;

                    // Promedio horas diarias
                    const totalHoras = registrosValidos.reduce((sum, r) => sum + r.total, 0);
                    const promedioDiario = totalHoras / registrosValidos.length;
                    const hPromedio = Math.floor(promedioDiario);
                    const mPromedio = Math.round((promedioDiario - hPromedio) * 60);

                    // CALCULAR SEMANA PASADA
                    const hoy = new Date();
                    hoy.setHours(0, 0, 0, 0); // Normalizar a medianoche

                    const diaSemana = hoy.getDay(); // 0=Dom, 1=Lun...
                    const offsetLunesActual = diaSemana === 0 ? -6 : 1 - diaSemana;

                    // Lunes de esta semana
                    const lunesActual = new Date(hoy);
                    lunesActual.setDate(hoy.getDate() + offsetLunesActual);

                    // Lunes de semana pasada (restar 7 d√≠as al lunes actual)
                    const lunesPasado = new Date(lunesActual);
                    lunesPasado.setDate(lunesActual.getDate() - 7);

                    // Domingo de semana pasada (restar 1 d√≠a al lunes actual)
                    const domingoPasado = new Date(lunesActual);
                    domingoPasado.setDate(lunesActual.getDate() - 1);

                    // Formatear a YYYY-MM-DD
                    const inicioSemanaPasada = `${lunesPasado.getFullYear()}-${String(lunesPasado.getMonth() + 1).padStart(2, '0')}-${String(lunesPasado.getDate()).padStart(2, '0')}`;
                    const finSemanaPasada = `${domingoPasado.getFullYear()}-${String(domingoPasado.getMonth() + 1).padStart(2, '0')}-${String(domingoPasado.getDate()).padStart(2, '0')}`;

                    // Filtrar TODOS los registros de semana pasada
                    const todosRegistrosSemanaPasada = D.registros().filter(r =>
                        r.fecha >= inicioSemanaPasada && r.fecha <= finSemanaPasada
                    );

                    // Separar normales de especiales
                    const normalesSemanaPasada = todosRegistrosSemanaPasada.filter(r => {
                        const esEspecial = TiposRegistro.esRegistroEspecial(r.entrada, r.salida);
                        return r.entrada && r.salida && !esEspecial;
                    });

                    const especialesSemanaPasada = todosRegistrosSemanaPasada.filter(r =>
                        TiposRegistro.esRegistroEspecial(r.entrada, r.salida)
                    );

                    // Contar tipos especiales
                    const especialesPorTipo = {};
                    especialesSemanaPasada.forEach(r => {
                        const tipo = TiposRegistro.obtenerTipoPorCodigo(r.entrada, r.salida);
                        if (tipo) {
                            if (!especialesPorTipo[tipo.labelPlural]) {
                                especialesPorTipo[tipo.labelPlural] = 0;
                            }
                            especialesPorTipo[tipo.labelPlural]++;
                        }
                    });

                    // Sumar horas trabajadas (normales + remotos como objetivo diario)
                    const horasDiariasObjetivo = D.horasDiarias();
                    let totalSemanaPasada = normalesSemanaPasada.reduce((sum, r) => sum + r.total, 0);

                    // Agregar horas de d√≠as remotos (equivalente al objetivo diario)
                    especialesSemanaPasada.forEach(r => {
                        const tipo = TiposRegistro.obtenerTipoPorCodigo(r.entrada, r.salida);
                        if (tipo && tipo.id === 'remoto') {
                            totalSemanaPasada += horasDiariasObjetivo;
                        }
                    });
                    const hSemanaPasada = Math.floor(totalSemanaPasada);
                    const mSemanaPasada = Math.round((totalSemanaPasada - hSemanaPasada) * 60);

                    // Construir texto con detalles
                    let textoSemanaPasada = `${hSemanaPasada}h ${mSemanaPasada}m`;

                    if (Object.keys(especialesPorTipo).length > 0) {
                        const detalles = Object.entries(especialesPorTipo)
                            .map(([tipoPlural, cant]) => {
                                // Buscar el tipo original para obtener tanto singular como plural
                                const tipoObj = TiposRegistro.obtenerTodosLosTipos().find(t =>
                                    t.labelPlural.toLowerCase() === tipoPlural.toLowerCase()
                                );

                                const label = (cant === 1 && tipoObj) ? tipoObj.label : tipoPlural;
                                const diasTexto = cant === 1 ? 'dia de' : 'dias de';
                                return `${cant} ${diasTexto} ${label.toLowerCase()}`;
                            })
                            .join(', ');
                        textoSemanaPasada += ` [${detalles}]`;
                    }
                    return {
                        entradaPromedio: `${String(hEntrada).padStart(2, '0')}:${String(mEntrada).padStart(2, '0')}`,
                        salidaPromedio: `${String(hSalida).padStart(2, '0')}:${String(mSalida).padStart(2, '0')}`,
                        diasTrabajados: registrosValidos.length,
                        promedioDiario: `${hPromedio}h ${mPromedio}m`,
                        tiempoFueraTotal: `${hTiempoFuera}h ${mTiempoFuera}m`,
                        semanaPasada: textoSemanaPasada,
                        feriados: feriados,
                        ausencias: ausencias,
                        vacaciones: vacaciones,
                        enfermedades: enfermedades,
                        asuetosDiaCompleto: asuetosDiaCompleto,
                        compensaciones: compensaciones,
                        paros: paros,
                        remotos: remotos,
                        capacitaciones: capacitaciones
                    };
                }

                function actualizarEstadisticas(mesAnio = null) {
                    const selectMes = $('select-mes-stats');

                    // Si no se especifica mes, usar el seleccionado (o el actual como fallback)
                    if (!mesAnio && selectMes) {
                        mesAnio = selectMes.value;
                    }

                    // Si el mes seleccionado ya no tiene registros, resetear al actual
                    if (mesAnio && selectMes) {
                        const [a√±o, mes] = mesAnio.split('-').map(Number);
                        const registrosDelMes = D.registros().filter(r => {
                            const [aReg, mReg] = r.fecha.split('-').map(Number);
                            return aReg === a√±o && mReg === mes;
                        });

                        if (registrosDelMes.length === 0) {
                            // El mes seleccionado ya no tiene registros, volver al actual
                            const hoy = new Date();
                            mesAnio = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;
                            if (selectMes) selectMes.value = mesAnio;
                        }
                    }

                    const stats = calcularEstadisticasMes(mesAnio);

                    const elEntrada = $('stat-entrada-promedio');
                    const elSalida = $('stat-salida-promedio');
                    const elDias = $('stat-dias-trabajados');
                    const elPromedio = $('stat-promedio-diario');
                    const elSemanaPasada = $('stat-semana-pasada');
                    const elTiempoFueraTotal = $('stat-tiempo-fuera-total');
                    const elFeriados = $('stat-feriados');
                    const elAusencias = $('stat-ausencias');
                    const elVacaciones = $('stat-vacaciones');
                    const elEnfermedades = $('stat-enfermedades');
                    const elAsuetosDia = $('stat-asuetos-dia');
                    const elCompensaciones = $('stat-compensaciones');
                    const elParos = $('stat-paros');
                    const elRemotos = $('stat-remotos');
                    const elCapacitaciones = $('stat-capacitaciones');

                    if (elEntrada) elEntrada.textContent = stats.entradaPromedio;
                    if (elSalida) elSalida.textContent = stats.salidaPromedio;
                    if (elDias) elDias.textContent = stats.diasTrabajados;
                    if (elPromedio) elPromedio.textContent = stats.promedioDiario;
                    if (elSemanaPasada) elSemanaPasada.textContent = stats.semanaPasada;
                    if (elTiempoFueraTotal) elTiempoFueraTotal.textContent = stats.tiempoFueraTotal;

                    // Ocultar/Mostrar items seg√∫n valor
                    const toggleStatItem = (element, value) => {
                        if (!element) return;
                        const statItem = element.closest('.stat-item');
                        if (statItem) {
                            if (value === 0) {
                                statItem.style.display = 'none';
                            } else {
                                statItem.style.display = '';
                                element.textContent = value;
                            }
                        }
                    };

                    toggleStatItem(elDias, stats.diasTrabajados);
                    toggleStatItem(elFeriados, stats.feriados);
                    toggleStatItem(elAusencias, stats.ausencias);
                    toggleStatItem(elVacaciones, stats.vacaciones);
                    toggleStatItem(elEnfermedades, stats.enfermedades);
                    toggleStatItem(elAsuetosDia, stats.asuetosDiaCompleto);
                    toggleStatItem(elCompensaciones, stats.compensaciones);
                    toggleStatItem(elParos, stats.paros);
                    toggleStatItem(elRemotos, stats.remotos);
                    toggleStatItem(elCapacitaciones, stats.capacitaciones);

                }

                function actualizarUI(idNuevo = null, soloReloj = false) {
                    const registros = D.registros();
                    const horasSemanales = D.horasSemanales();
                    const horasDiarias = D.horasDiarias();
                    const diasHabilesConfig = D.diasHabiles();
                    const vistaActual = D.vistaActual();

                    if (!soloReloj) {
                        actualizarListaRegistros(registros, idNuevo);
                    }

                    const { inicio: ini, fin: fn } = obtenerSemanaActual();
                    const hoy = obtenerFechaHoy();

                    // --- DETECCI√ìN DE D√çAS H√ÅBILES (COMPATIBLE CON ARRAY v6.63) ---
                    const diaObj = new Date();
                    const diaSemanaHoy = diaObj.getDay(); // 0=Dom, 1=Lun...

                    // Verificamos si es array (versiones nuevas) o n√∫mero (fallback)
                    let esDiaHabilHoy = true;
                    if (Array.isArray(diasHabilesConfig)) {
                        esDiaHabilHoy = diasHabilesConfig.includes(diaSemanaHoy);
                    } else {
                        if (diaSemanaHoy === 0) esDiaHabilHoy = (diasHabilesConfig === 7);
                        else esDiaHabilHoy = (diaSemanaHoy <= diasHabilesConfig);
                    }
                    const esDiaDeDescanso = !esDiaHabilHoy;

                    // --- L√ìGICA DE SEMANA ABIERTA/CERRADA  ---
                    // Mapa para ordenar Lun(1) a Dom(7) y facilitar c√°lculo de "futuro"
                    const mapDia = d => d === 0 ? 7 : d;
                    const hoyIndex = mapDia(diaSemanaHoy);

                    // Detectar si quedan d√≠as laborales en el FUTURO (Ma√±ana en adelante)
                    let quedanDiasFuturos = false;
                    // Solo si es array iteramos (v6.63), sino usamos l√≥gica simple
                    if (Array.isArray(diasHabilesConfig)) {
                        for (let d = hoyIndex + 1; d <= 7; d++) {
                            const diaReal = d === 7 ? 0 : d;
                            if (diasHabilesConfig.includes(diaReal)) {
                                quedanDiasFuturos = true;
                                break;
                            }
                        }
                    } else {
                        // Fallback simple
                        quedanDiasFuturos = hoyIndex < diasHabilesConfig;
                    }

                    const registroHoy = registros.find(r => r.fecha === hoy);
                    const hoyCerrado = registroHoy && registroHoy.salida;
                    const semanaAbierta = quedanDiasFuturos || (esDiaHabilHoy && !hoyCerrado);

                    const bufferSemanal = D.calcularBufferSemanal(ini, hoy);

                    const statsEl = $('stats-semana');
                    const progressEl = $('progress-bar');
                    const mensajeEl = $('stats-mensaje');
                    const tituloEl = $('stats-titulo');
                    const hintEl = $('toggle-hint');
                    const bufferEl = $('stats-buffer');

                    // --- MOSTRAR BUFFER (SOLO SI SEMANA ABIERTA) ---
                    if (bufferEl) {
                        bufferEl.innerHTML = '';
                        // Solo mostrar buffer si hay horas configuradas, hay diferencia y la semana no termin√≥
                        if (horasDiarias > 0 && Math.abs(bufferSemanal) > 0.01 && semanaAbierta) {
                            const esPositivo = bufferSemanal > 0;
                            const bufferColor = esPositivo ? 'var(--c-green)' : 'var(--c-red)';
                            const bufferTextoHoras = horasATexto(Math.abs(bufferSemanal));
                            const bufferLabel = esPositivo ? 'extras' : 'faltantes';

                            // Crear punto como elemento DOM
                            const punto = document.createElement('span');
                            punto.style.display = 'inline-block';
                            punto.style.width = '10px';
                            punto.style.height = '10px';
                            punto.style.borderRadius = '50%';
                            punto.style.backgroundColor = bufferColor;
                            punto.style.marginRight = '6px';

                            const span = document.createElement('span');
                            span.style.color = bufferColor;
                            span.style.fontWeight = '500';
                            span.textContent = `${bufferTextoHoras} ${bufferLabel} esta semana`;

                            // Insertar punto + texto
                            span.insertBefore(punto, span.firstChild);
                            bufferEl.appendChild(span);
                        }
                    }

                    // =========================================================
                    // VISTA SEMANAL
                    // =========================================================
                    if (vistaActual === 'semana') {
                        tituloEl.innerHTML = `<svg class="icon"><use href="#icon-calendar-simple" /></svg> Esta Semana`;

                        // Solo contar hasta HOY
                        const fechaLimiteCalculo = hoy < fn ? hoy : fn;

                        // Filtrar todos los registros de la semana hasta hoy
                        const registrosSemana = registros.filter(r =>
                            r.fecha >= ini && r.fecha <= fechaLimiteCalculo
                        );

                        // =========================================================
                        // DETECCI√ìN: ¬øTodos los d√≠as laborables est√°n ocupados?
                        // =========================================================
                        let todosLosDiasLaborablesTienenEspecial = false;

                        if (Array.isArray(diasHabilesConfig) && diasHabilesConfig.length > 0 && horasDiarias > 0) {
                            // Generar todas las fechas de d√≠as laborables de la semana actual
                            const fechasLaborablesConfig = [];

                            // Parsear fechas de inicio y fin de semana
                            const [yIni, mIni, dIni] = ini.split('-').map(Number);
                            const [yFin, mFin, dFin] = fn.split('-').map(Number);

                            const inicioSemana = new Date(yIni, mIni - 1, dIni);
                            const finSemana = new Date(yFin, mFin - 1, dFin);

                            // Iterar cada d√≠a de la semana
                            let fechaActual = new Date(inicioSemana);
                            while (fechaActual <= finSemana) {
                                const diaSemana = fechaActual.getDay();

                                // Si este d√≠a est√° en la configuraci√≥n de laborables
                                if (diasHabilesConfig.includes(diaSemana)) {
                                    const y = fechaActual.getFullYear();
                                    const m = String(fechaActual.getMonth() + 1).padStart(2, '0');
                                    const d = String(fechaActual.getDate()).padStart(2, '0');
                                    const fechaStr = `${y}-${m}-${d}`;
                                    fechasLaborablesConfig.push(fechaStr);
                                }

                                // Avanzar al siguiente d√≠a (crear nueva instancia)
                                fechaActual = new Date(fechaActual);
                                fechaActual.setDate(fechaActual.getDate() + 1);
                            }

                            // Verificar si TODOS los d√≠as laborables tienen registros especiales
                            if (fechasLaborablesConfig.length > 0) {
                                let contadorEspeciales = 0;

                                fechasLaborablesConfig.forEach(fecha => {
                                    const reg = registros.find(r => r.fecha === fecha);
                                    if (reg) {
                                        const tipo = TiposRegistro.obtenerTipoPorCodigo(reg.entrada, reg.salida);
                                        // Es especial si tiene tipo Y no es remoto
                                        if (tipo && tipo.id !== 'remoto') {
                                            contadorEspeciales++;
                                        }
                                    }
                                });

                                // Solo si TODOS tienen especiales
                                todosLosDiasLaborablesTienenEspecial = (contadorEspeciales === fechasLaborablesConfig.length);
                            }
                        }

                        // Calcular total sumando:
                        // 1. Horas reales de registros normales
                        // 2. Objetivo diario por cada d√≠a remoto
                        let tot = 0;
                        registrosSemana.forEach(r => {
                            const tipoEspecial = TiposRegistro.obtenerTipoPorCodigo(r.entrada, r.salida);

                            if (tipoEspecial && tipoEspecial.id === 'remoto') {
                                // Si es remoto, sumar el objetivo diario
                                tot += horasDiarias;
                            } else if (!tipoEspecial) {
                                // Si es un registro normal, sumar las horas reales
                                tot += r.total;
                            }
                            // Los dem√°s tipos especiales no suman
                        });

                        const horasDescontar = D.calcularHorasFeriadoEnRango(ini, fn);
                        const objetivoAjustado = Math.max(0, horasSemanales - horasDescontar);
                        const prog = objetivoAjustado > 0 ? Math.min((tot / objetivoAjustado) * 100, 100) : 100;

                        if (statsEl) {
                            // Si todos los d√≠as laborables tienen registros especiales, mostrar mensaje alternativo
                            if (todosLosDiasLaborablesTienenEspecial) {
                                statsEl.textContent = "üòé Sin Jornadas";
                            } else {
                                statsEl.textContent = horasATexto(tot);
                            }
                        }

                        if (progressEl) {
                            progressEl.style.width = prog + '%';

                            let colorBarra = 'blue'; // Default para semana en curso

                            if (horasDiarias === 0) {
                                // Sin objetivo configurado
                                colorBarra = 'blue';
                            } else if (tot >= objetivoAjustado) {
                                // Objetivo cumplido
                                colorBarra = 'green';
                            } else if (semanaAbierta) {
                                // Semana a√∫n en curso (quedan d√≠as por delante)
                                colorBarra = 'blue';
                            } else {
                                // Semana cerrada y NO se cumpli√≥ el objetivo
                                colorBarra = 'red';
                            }

                            setProgressBarColor(progressEl, colorBarra);
                        }

                        const card = document.getElementById('stats-card');
                        if (card) {
                            // Limpiar clases previas
                            card.classList.remove('border-blue', 'border-green', 'border-red', 'border-purple', 'border-transparent');

                            if (horasDiarias === 0) {
                                // Sin objetivo configurado
                                card.classList.add('border-transparent');
                            } else if (tot >= objetivoAjustado) {
                                // Objetivo cumplido
                                card.classList.add('border-green');
                            } else if (semanaAbierta) {
                                // Semana a√∫n abierta (quedan d√≠as laborales por delante)
                                card.classList.add('border-blue');
                            } else {
                                // Semana cerrada y NO se cumpli√≥ el objetivo
                                card.classList.add('border-red');
                            }
                        }

                        if (mensajeEl) {
                            // Si todos los d√≠as laborables est√°n ocupados por registros especiales
                            if (todosLosDiasLaborablesTienenEspecial) {
                                mensajeEl.textContent = 'Semana sin d√≠as laborables';
                                mensajeEl.style.display = 'block';
                            } else if (horasDiarias === 0) {
                                mensajeEl.textContent = `Total registrado: ${horasATexto(tot)}`;
                                mensajeEl.style.display = 'none';
                            } else {
                                mensajeEl.style.display = 'block';
                                if (objetivoAjustado === 0) {
                                    mensajeEl.textContent = `${horasATexto(tot)} (Sin objetivo)`;
                                } else {
                                    if (tot >= objetivoAjustado) {
                                        mensajeEl.textContent = `Hiciste ${horasATexto(tot - objetivoAjustado)} de m√°s`;
                                    } else {
                                        const verbo = semanaAbierta ? "Faltan" : "Faltaron";
                                        mensajeEl.textContent = `${verbo} ${horasATexto(objetivoAjustado - tot)}`;
                                    }
                                }
                            }
                        }
                        if (hintEl) hintEl.textContent = 'Toca para ver Hoy';

                        // =========================================================
                        // VISTA DIARIA (HOY)
                        // =========================================================
                    } else {
                        tituloEl.innerHTML = `<svg class="icon"><use href="#icon-clock" /></svg> Hoy`;
                        const regHoy = registros.find(r => r.fecha === hoy);
                        let tiempoTranscurrido = 0;
                        let objetivoDiario = horasDiarias;

                        if (regHoy && regHoy.entrada) {
                            //  FIX: Solo detectar tipo especial si entrada Y salida existen y coinciden
                            const tipoEspecialHoy = (regHoy.salida && regHoy.entrada === regHoy.salida)
                                ? TiposRegistro.obtenerTipoPorCodigo(regHoy.entrada, regHoy.salida)
                                : null;

                            if (tipoEspecialHoy) {
                                // D√≠a especial (feriado, licencia, etc.)
                                if (statsEl) statsEl.textContent = `${tipoEspecialHoy.emoji} ${tipoEspecialHoy.label}`;
                                if (progressEl) {
                                    progressEl.style.width = '100%';
                                    setProgressBarColor(progressEl, tipoEspecialHoy.color);
                                }
                                if (mensajeEl) {
                                    mensajeEl.textContent = `¬°${tipoEspecialHoy.descripcion}!`;
                                    mensajeEl.style.display = 'block';
                                }

                                const card = document.getElementById('stats-card');
                                if (card) {
                                    card.classList.remove('border-blue', 'border-green', 'border-red', 'border-purple', 'border-transparent');
                                    card.classList.add('border-purple');
                                }
                            } else {
                                // --- D√çA NORMAL CON REGISTRO ---
                                if (regHoy.salida) {
                                    tiempoTranscurrido = regHoy.total;
                                } else {
                                    const ahora = new Date();
                                    const horaActual = String(ahora.getHours()).padStart(2, '0') + ':' + String(ahora.getMinutes()).padStart(2, '0');
                                    const t = D.calcularHoras(regHoy.entrada, horaActual, regHoy.tiempoFuera || null, null, true);
                                    tiempoTranscurrido = t ? t.total : 0;
                                }

                                const prog = objetivoDiario > 0 ? Math.min((tiempoTranscurrido / objetivoDiario) * 100, 100) : 100;

                                if (statsEl) statsEl.textContent = horasATexto(tiempoTranscurrido);
                                if (progressEl) {
                                    progressEl.style.width = prog + '%';
                                }

                                if (regHoy.salida) {
                                    // -------------------------------------------------
                                    // CASO 1: D√çA CERRADO (Ya marcaste salida)
                                    // -------------------------------------------------
                                    if (objetivoDiario === 0) {
                                        setProgressBarColor(progressEl, 'blue');
                                        if (mensajeEl) mensajeEl.style.display = 'none';

                                        //  Borde transparente
                                        const card = document.getElementById('stats-card');
                                        if (card) {
                                            card.classList.remove('border-blue', 'border-green', 'border-red', 'border-purple');
                                            card.classList.add('border-transparent');
                                        }
                                    } else {
                                        if (mensajeEl) mensajeEl.style.display = 'block';
                                        setProgressBarColor(progressEl, tiempoTranscurrido >= objetivoDiario ? 'green' : 'red');

                                        // Borde verde o rojo
                                        const card = document.getElementById('stats-card');
                                        if (card) {
                                            card.classList.remove('border-blue', 'border-green', 'border-red', 'border-purple', 'border-transparent');
                                            card.classList.add(tiempoTranscurrido >= objetivoDiario ? 'border-green' : 'border-red');
                                        }

                                        const dif = tiempoTranscurrido - objetivoDiario;
                                        if (mensajeEl) mensajeEl.textContent = dif >= 0 ? `${horasATexto(dif)} extras` : `Faltaron ${horasATexto(Math.abs(dif))}`;
                                    }
                                } else {
                                    // -------------------------------------------------
                                    // CASO 2: D√çA ABIERTO (Est√°s trabajando ahora)
                                    // -------------------------------------------------
                                    if (objetivoDiario === 0) {
                                        setProgressBarColor(progressEl, 'blue');
                                        if (mensajeEl) mensajeEl.style.display = 'none';

                                        // Borde transparente
                                        const card = document.getElementById('stats-card');
                                        if (card) {
                                            card.classList.remove('border-blue', 'border-green', 'border-red', 'border-purple');
                                            card.classList.add('border-transparent');
                                        }
                                    } else {
                                        if (mensajeEl) mensajeEl.style.display = 'block';

                                        // 1. ¬øObjetivo Cumplido HOY?
                                        const objetivoCumplido = tiempoTranscurrido >= objetivoDiario;

                                        // Barra: Verde si cumpliste, Azul si falta
                                        setProgressBarColor(progressEl, objetivoCumplido ? 'green' : 'blue');

                                        // Borde verde o azul
                                        const card = document.getElementById('stats-card');
                                        if (card) {
                                            card.classList.remove('border-blue', 'border-green', 'border-red', 'border-purple', 'border-transparent');
                                            card.classList.add(objetivoCumplido ? 'border-green' : 'border-blue');
                                        }

                                        const faltante = Math.max(0, objetivoDiario - tiempoTranscurrido);

                                        if (mensajeEl) {
                                            if (objetivoCumplido) {
                                                // --- A) YA CUMPLISTE LAS HORAS DE HOY ---
                                                const extra = tiempoTranscurrido - objetivoDiario;

                                                if (bufferSemanal < 0 && Math.abs(bufferSemanal) > extra) {
                                                    mensajeEl.textContent = `Te podes ir, pero deb√©s tiempo`;
                                                } else {
                                                    if (extra > 0) {
                                                        mensajeEl.textContent = `Te podes ir (+${horasATexto(extra)})`;
                                                    } else {
                                                        mensajeEl.textContent = `Te podes ir`;
                                                    }
                                                }
                                            } else {
                                                // --- B) FALTA PARA EL OBJETIVO DE HOY ---
                                                const faltanteTexto = `Faltan ${horasATexto(faltante)}`;

                                                if (bufferSemanal >= faltante) {
                                                    mensajeEl.textContent = `${faltanteTexto}, pero te pod√©s ir`;
                                                } else {
                                                    mensajeEl.textContent = faltanteTexto;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        } else {
                            // SIN REGISTRO HOY
                            if (progressEl) {
                                progressEl.style.width = '0%';
                                setProgressBarColor(progressEl, 'blue');
                            }

                            //  Borde transparente si no hay registro
                            const card = document.getElementById('stats-card');
                            if (card) {
                                card.classList.remove('border-blue', 'border-green', 'border-red', 'border-purple');
                                card.classList.add('border-transparent');
                            }

                            if (esDiaDeDescanso) {
                                if (statsEl) statsEl.textContent = "üò¥";
                                if (mensajeEl) {
                                    // Solo ocultar si NO hay objetivo de horas
                                    if (horasDiarias === 0) {
                                        mensajeEl.style.display = 'none';
                                    } else {
                                        mensajeEl.textContent = 'D√≠a libre';
                                        mensajeEl.style.display = 'block';
                                    }
                                }
                            } else {
                                if (statsEl) statsEl.textContent = "üò¥ Sin Actividad";
                                if (mensajeEl) {
                                    if (horasDiarias === 0) mensajeEl.style.display = 'none';
                                    else { mensajeEl.textContent = '...'; mensajeEl.style.display = 'block'; }
                                }
                            }
                        }

                        // --- L√ìGICA DE SALIDA ESTIMADA ---
                        if (hintEl) {
                            let mostrarEstimacion = false;
                            let horaSalida = '';
                            let minutosTotal = 0;

                            if (regHoy && regHoy.entrada && !regHoy.salida && objetivoDiario > 0) {
                                const esEspecial = TiposRegistro.esRegistroEspecial(regHoy.entrada, regHoy.salida);

                                if (!esEspecial) {
                                    const [hE, mE] = regHoy.entrada.split(':').map(Number);
                                    minutosTotal = (hE * 60) + mE + (objetivoDiario * 60);

                                    if (regHoy.tiempoFuera) {
                                        const [hF, mF] = regHoy.tiempoFuera.split(':').map(Number);
                                        minutosTotal += (hF * 60) + mF;
                                    }

                                    const perfilId = window.PerfilManager ? PerfilManager.obtenerPerfilActual() : 'default';
                                    const storageKey = `breakStartTime_${perfilId}`;
                                    const inicioBreak = localStorage.getItem(storageKey);

                                    if (inicioBreak) {
                                        const ahora = Date.now();
                                        const minutosEnCurso = Math.floor((ahora - parseInt(inicioBreak)) / 60000);
                                        if (minutosEnCurso > 0) minutosTotal += minutosEnCurso;
                                    }

                                    let hS = Math.floor(minutosTotal / 60);
                                    const mS = Math.round(minutosTotal % 60);
                                    if (hS >= 24) hS = hS % 24;

                                    horaSalida = `${String(hS).padStart(2, '0')}:${String(mS).padStart(2, '0')}`;
                                    mostrarEstimacion = true;
                                }
                            }

                            if (mostrarEstimacion) {
                                // ===================================================
                                // üîπ VERIFICAR SI HOY ES D√çA LABORAL
                                // ===================================================
                                const diaActual = new Date().getDay(); // 0=Domingo, 1=Lunes...
                                const esLaborable = diasHabilesConfig.includes(diaActual);

                                // Solo mostrar buffer si:
                                // 1) Hay diferencia significativa
                                // 2) El d√≠a actual ES laboral
                                const mostrarConBuffer = Math.abs(bufferSemanal) > 0.01 && esLaborable;

                                let textoFinal = `Salida estimada: <strong>${horaSalida}</strong>`;

                                if (mostrarConBuffer) {
                                    // Calcular salida considerando el buffer
                                    const minutosBuffer = bufferSemanal * 60;
                                    const minutosConBuffer = minutosTotal - minutosBuffer;

                                    let hSB = Math.floor(minutosConBuffer / 60);
                                    const mSB = Math.round(minutosConBuffer % 60);
                                    if (hSB >= 24) hSB = hSB % 24;

                                    const horaSalidaBuffer = `${String(hSB).padStart(2, '0')}:${String(mSB).padStart(2, '0')}`;

                                    // Color seg√∫n el buffer
                                    const colorBuffer = bufferSemanal > 0 ? 'var(--c-green)' :
                                        bufferSemanal < 0 ? 'var(--c-red)' :
                                            'var(--text-main)';

                                    textoFinal = `Salida estimada: <strong>${horaSalida}</strong> <span style="color: ${colorBuffer};">(<strong>${horaSalidaBuffer}</strong>)</span>`;
                                }

                                hintEl.innerHTML = textoFinal;
                            } else {
                                hintEl.textContent = 'Toca para ver la Semana';
                            }
                        }
                    }

                    poblarSelectorMeses();
                    actualizarEstadisticas();
                    actualizarEstadoBotonTimerMain();
                }

                function alternarTema() {
                    let temaOscuro = !D.cargarConfiguracion().temaOscuro;
                    document.body.classList.toggle('dark-mode');

                    // Guardar en la ra√≠z (NO dentro del perfil)
                    try {
                        localStorage.setItem('temaOscuro', temaOscuro);
                    } catch (e) { }

                    // Actualizar iconos de todos los botones
                    const botonesTema = [
                        'theme-toggle',
                        'theme-toggle-modal',
                        'btn-tema-selector'
                    ];

                    botonesTema.forEach(id => {
                        const btn = document.getElementById(id);
                        if (btn) {
                            const icon = btn.querySelector('use');
                            if (icon) {
                                icon.setAttribute('href', temaOscuro ? '#icon-sun' : '#icon-moon');
                            }
                        }
                    });
                }

                function alternarVista() {
                    const card = document.getElementById('stats-card');
                    const content = document.getElementById('stats-card-content');

                    // 1. Iniciamos animaci√≥n de la tarjeta Y del contenido
                    if (card) card.classList.add('cambiando-vista');
                    if (content) content.classList.add('fade-out');

                    // 2. Delay para permitir que la animaci√≥n se vea
                    setTimeout(() => {
                        // L√≥gica original de cambio de datos
                        let vistaActual = D.vistaActual() === 'semana' ? 'diaria' : 'semana';
                        D.setVistaActual(vistaActual);
                        try {
                            localStorage.setItem('vistaActual', vistaActual);
                        } catch (e) { }

                        actualizarUI(); // Se actualizan los textos (mientras est√° invisible)

                        // 3. Removemos fade-out para que vuelva a aparecer
                        if (content) content.classList.remove('fade-out');

                        // 4. Terminamos la animaci√≥n de la tarjeta
                        if (card) card.classList.remove('cambiando-vista');

                    }, 300); // sincronizado con la transici√≥n CSS
                }

                function pegarHoraActual(id) {
                    const c = document.getElementById(id);
                    if (!c) return;

                    // 1. Si el campo tiene contenido, limpiarlo (toggle)
                    if (c.value.trim() !== '') {
                        c.value = '';
                        UILogic.limpiarError('entrada', 'error-entrada');
                        UILogic.limpiarError('salida', 'error-salida');

                        // --- Avisar que se borr√≥ para bloquear el bot√≥n ---
                        if (id === 'edit-entrada' || id === 'edit-salida') {
                            verificarBloqueoCredito();
                        }
                        return;
                    }

                    // 2. Si est√° vac√≠o, pegar hora actual
                    const now = new Date();
                    const h = String(now.getHours()).padStart(2, '0');
                    const m = String(now.getMinutes()).padStart(2, '0');
                    c.value = `${h}:${m}`;

                    // --- Avisar que se peg√≥ para habilitar el bot√≥n ---
                    if (id === 'edit-entrada' || id === 'edit-salida') {
                        verificarBloqueoCredito();
                    }
                }

                function limpiarCampo(id) {
                    const c = document.getElementById(id);
                    if (c) c.value = '';

                }

                function formatearInput(e) {
                    let v = e.target.value.replace(/[^0-9]/g, '');
                    if (v.length >= 3) v = v.slice(0, 2) + ':' + v.slice(2, 4);
                    e.target.value = v;
                }

                function actualizarFeedbackConfig() {
                    const seleccionados = document.querySelectorAll('input[name="dia-habil"]:checked').length;
                    const horas = parseFloat($('config-horas-diarias').value) || 0;
                    const total = seleccionados * horas;

                    const el = $('config-total-feedback');
                    if (el) {
                        if (horas === 0) el.textContent = `(Registro libre sin objetivos)`;
                        else el.textContent = `(Total semanal: ${total}hs)`;
                    }
                }

                function iniciarCambioHoras(incremento) {
                    // Cambio inmediato al presionar
                    cambiarHorasDiarias(incremento);

                    // Esperar 500ms antes de iniciar repetici√≥n
                    timeoutInicial = setTimeout(() => {
                        intervaloPulsacion = setInterval(() => {
                            cambiarHorasDiarias(incremento);
                        }, 100); // Repetir cada 100ms
                    }, 500);
                }

                function detenerCambio() {
                    if (timeoutInicial) {
                        clearTimeout(timeoutInicial);
                        timeoutInicial = null;
                    }
                    if (intervaloPulsacion) {
                        clearInterval(intervaloPulsacion);
                        intervaloPulsacion = null;
                    }
                }

                function cambiarHorasDiarias(incremento) {
                    let valorActual = parseFloat($('config-horas-diarias').value);
                    if (isNaN(valorActual)) valorActual = D.horasDiarias();
                    let nuevoValor = valorActual + incremento;
                    if (nuevoValor > 24) nuevoValor = 24;
                    if (nuevoValor < 0) nuevoValor = 0;
                    $('config-horas-diarias').value = nuevoValor;
                    actualizarFeedbackConfig();
                }

                function cerrarConfig() {
                    ModalManager.cerrar('modal-config', () => {
                        UILogic.abrirSelectorPerfiles();
                    });
                }

                function cerrarEdicion() {
                    ModalManager.cerrar('modal-editar', () => {
                        D.setEditandoId(null);
                    });
                }

                function mostrarImportar() {
                    ModalManager.alternar('modal-config', 'modal-importar', null, () => {
                        $('file-import').value = '';

                        const nombreEl = document.getElementById('nombre-archivo-seleccionado');
                        if (nombreEl) {
                            nombreEl.style.display = 'none';
                            nombreEl.textContent = '';
                        }

                        const btnCombinar = document.getElementById('btn-combinar');
                        const btnReemplazar = document.getElementById('btn-reemplazar');

                        if (btnCombinar) {
                            btnCombinar.disabled = true;
                            btnCombinar.style.opacity = '0.5';
                        }
                        if (btnReemplazar) {
                            btnReemplazar.disabled = true;
                            btnReemplazar.style.opacity = '0.5';
                        }
                    });
                }

                function cerrarImportar() {
                    ModalManager.alternar('modal-importar', 'modal-config');
                }

                function poblarSelectorMeses() {
                    const selectMes = $('select-mes-stats');
                    if (!selectMes) return;

                    // Guardar mes seleccionado actual
                    const mesActualmenteSeleccionado = selectMes.value;

                    // Obtener todos los meses √∫nicos de los registros
                    const mesesUnicos = new Set();
                    D.registros().forEach(r => {
                        const mesAnio = r.fecha.substring(0, 7);
                        mesesUnicos.add(mesAnio);
                    });

                    // Convertir a array y ordenar (m√°s reciente primero)
                    const mesesOrdenados = Array.from(mesesUnicos).sort().reverse();

                    // Limpiar opciones previas
                    selectMes.innerHTML = '';

                    // Si no hay registros
                    if (mesesOrdenados.length === 0) {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'Sin registros';
                        selectMes.appendChild(option);
                        return;
                    }

                    // Mes actual
                    const hoy = new Date();
                    const mesActual = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;

                    // Determinar qu√© mes debe quedar seleccionado
                    let mesASeleccionar = mesActual;

                    // Si hab√≠a un mes seleccionado y a√∫n existe, mantenerlo
                    if (mesActualmenteSeleccionado && mesesOrdenados.includes(mesActualmenteSeleccionado)) {
                        mesASeleccionar = mesActualmenteSeleccionado;
                    } else if (!mesesOrdenados.includes(mesActual)) {
                        // Si el mes actual no tiene registros, usar el m√°s reciente
                        mesASeleccionar = mesesOrdenados[0];
                    }

                    // Crear opciones
                    mesesOrdenados.forEach(mesAnio => {
                        const option = document.createElement('option');
                        option.value = mesAnio;

                        // Formatear texto del mes
                        const [a√±o, mes] = mesAnio.split('-');
                        const fecha = new Date(a√±o, mes - 1, 1);
                        const nombreMes = fecha.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                        option.textContent = nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1);

                        // Seleccionar el mes correcto
                        if (mesAnio === mesASeleccionar) {
                            option.selected = true;
                        }

                        selectMes.appendChild(option);
                    });

                    // Actualizar stats con el mes correcto
                    actualizarEstadisticas(mesASeleccionar);
                }

                function cambiarMesStats() {
                    const selectMes = $('select-mes-stats');
                    const formStats = $('form-stats');
                    const icon = $('icon-indicator-stats');

                    if (!selectMes || !formStats) return;

                    const mesSeleccionado = selectMes.value;

                    // 1. Iniciamos fade-out del contenido
                    formStats.classList.add('fade-out');

                    // 2. Esperamos a que termine la animaci√≥n de fade-out
                    setTimeout(() => {
                        // Actualizamos los datos mientras est√° invisible
                        actualizarEstadisticas(mesSeleccionado);

                        // 3. Removemos fade-out para que vuelva a aparecer
                        formStats.classList.remove('fade-out');
                    }, 300);
                }

                function generarReporte() {
                    const selectMes = $('select-mes-stats');
                    const mesSeleccionado = selectMes ? selectMes.value : null;

                    if (!mesSeleccionado) {
                        mostrarToast('No hay mes seleccionado', 'error');
                        return;
                    }

                    const stats = calcularEstadisticasMes(mesSeleccionado);
                    const nombreMes = selectMes.options[selectMes.selectedIndex].text;

                    // Obtener registros del mes
                    const [a√±o, mes] = mesSeleccionado.split('-').map(Number);
                    const registrosMes = D.registros().filter(r => {
                        const [aReg, mReg] = r.fecha.split('-').map(Number);
                        return aReg === a√±o && mReg === mes;
                    });

                    // Calcular total de horas del mes (incluir remotos como objetivo diario)
                    let totalHoras = 0;
                    registrosMes.forEach(r => {
                        const tipoEspecial = TiposRegistro.obtenerTipoPorCodigo(r.entrada, r.salida);

                        if (tipoEspecial && tipoEspecial.id === 'remoto') {
                            totalHoras += D.horasDiarias();
                        } else if (!tipoEspecial) {
                            totalHoras += r.total;
                        }
                    });

                    const horasTotales = Math.floor(totalHoras);
                    const minutosTotales = Math.round((totalHoras - horasTotales) * 60);

                    // ============================================
                    // ESTRUCTURA MODULAR DEL REPORTE
                    // ============================================

                    const reporte = {
                        // --- ENCABEZADO ---
                        header: () => `
================================================================
REPORTE DE HORAS TRABAJADAS                   
================================================================

üìÖ Per√≠odo: ${nombreMes}
üìä Generado: ${new Date().toLocaleDateString('es-ES')} ${new Date().toLocaleTimeString('es-ES')}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`,

                        // --- RESUMEN GENERAL ---
                        resumenGeneral: () => `

üìà RESUMEN GENERAL
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

   ‚Ä¢ Jornadas:               ${stats.diasTrabajados}
   ‚Ä¢ Feriados:               ${stats.feriados}
   ‚Ä¢ Licencias:              ${stats.ausencias}
   ‚Ä¢ Vacaciones:             ${stats.vacaciones}
   ‚Ä¢ Enfermedades:           ${stats.enfermedades}
   ‚Ä¢ Asuetos:                ${stats.asuetosDiaCompleto}
   ‚Ä¢ Salidas Temprano:       ${stats.compensaciones}
   ‚Ä¢ Paros:                  ${stats.paros}
   ‚Ä¢ Remotos:                ${stats.remotos}
   ‚Ä¢ Capacitaciones:         ${stats.capacitaciones}

   ‚Ä¢ Entrada promedio:       ${stats.entradaPromedio}
   ‚Ä¢ Salida promedio:        ${stats.salidaPromedio}
   ‚Ä¢ Promedio diario:        ${stats.promedioDiario}
   
   ‚Ä¢ Total horas trabajadas: ${horasTotales}h ${minutosTotales}m`,

                        // --- DETALLE DIARIO ---
                        detalleDiario: () => {
                            let seccion = `

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

üìã DETALLE DIARIO
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

`;
                            const registrosOrdenados = [...registrosMes].sort((a, b) =>
                                new Date(a.fecha) - new Date(b.fecha)
                            );

                            const horasDiariasObjetivo = D.horasDiarias();

                            registrosOrdenados.forEach(r => {
                                const dia = obtenerNombreDia(r.fecha);
                                const fecha = r.fecha.split('-').reverse().join('/');

                                const tipoEspecial = TiposRegistro.obtenerTipoPorCodigo(r.entrada, r.salida);

                                let linea = '';

                                if (tipoEspecial) {
                                    linea = `${fecha}  ${dia.padEnd(10)} ${tipoEspecial.label.toUpperCase()}`;
                                } else {
                                    const entrada = r.entrada || '--:--';
                                    const salida = r.salida || '--:--';
                                    const total = r.salida ? `${r.horas}h ${r.minutos}m` : 'Incompleto';

                                    // Detalles extras
                                    const tiempoFuera = r.tiempoFuera ? ` (${r.tiempoFuera} fuera)` : '';
                                    const infoAsueto = (r.credito && r.credito !== '00:00') ? ' [SALIDA TEMPRANO]' : '';

                                    // Determinar si cumpli√≥ objetivo
                                    let indicador = '  ';
                                    if (r.salida) {
                                        if (r.total >= horasDiariasObjetivo) {
                                            indicador = '‚úì ';
                                        } else {
                                            indicador = '‚úó ';
                                        }
                                    }

                                    linea = `${fecha}  ${dia.padEnd(10)} ${entrada} ‚Üí ${salida}  [${total}]${tiempoFuera}${infoAsueto} ${indicador}`;
                                }

                                seccion += linea + '\n';
                            });

                            return seccion;
                        },

                        // --- TOTALES POR SEMANA ---
                        totalesPorSemana: () => {
                            function obtenerLunesSemana(fecha) {
                                const date = new Date(fecha.replace(/-/g, '/') + ' 00:00:00');
                                const dia = date.getDay();
                                const offset = dia === 0 ? -6 : 1 - dia;
                                const lunes = new Date(date);
                                lunes.setDate(date.getDate() + offset);
                                return lunes.toISOString().split('T')[0];
                            }

                            const horasDiariasObjetivo = D.horasDiarias(); // Definir aqu√≠ dentro de esta funci√≥n

                            // Obtener el mes seleccionado del selector
                            const selectMes = $('select-mes-stats');
                            const mesSeleccionado = selectMes ? selectMes.value : null;

                            if (!mesSeleccionado) return '';

                            // Obtener l√≠mites del mes actual
                            const [a√±oActual, mesActual] = mesSeleccionado.split('-').map(Number);
                            const primerDiaMes = `${a√±oActual}-${String(mesActual).padStart(2, '0')}-01`;
                            const ultimoDiaMes = new Date(a√±oActual, mesActual, 0).getDate();
                            const ultimaFechaMes = `${a√±oActual}-${String(mesActual).padStart(2, '0')}-${String(ultimoDiaMes).padStart(2, '0')}`;

                            const semanas = new Map();

                            registrosMes.forEach(r => {
                                const lunes = obtenerLunesSemana(r.fecha);
                                if (!semanas.has(lunes)) {
                                    semanas.set(lunes, {
                                        trabajados: [],
                                        feriados: [],
                                        ausencias: [],
                                        vacaciones: [],
                                        enfermedades: [],
                                        asuetos: [],
                                        paros: [],
                                        remotos: [],
                                        capacitaciones: []
                                    });
                                }

                                const semana = semanas.get(lunes);
                                const tipoEspecial = TiposRegistro.obtenerTipoPorCodigo(r.entrada, r.salida);

                                if (tipoEspecial) {
                                    // Agregar a la categor√≠a correspondiente
                                    const categoria = tipoEspecial.id + 's';
                                    if (semana[categoria]) {
                                        semana[categoria].push(r);
                                    }
                                } else {
                                    semana.trabajados.push(r);
                                    if (r.credito && r.credito !== '00:00') {
                                        semana.asuetos.push(r);
                                    }
                                }
                            });

                            const semanasOrdenadas = Array.from(semanas.entries()).sort((a, b) =>
                                new Date(a[0]) - new Date(b[0])
                            );

                            if (semanasOrdenadas.length === 0) return '';

                            let seccion = `

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

üìÖ TOTALES POR SEMANA
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

`;

                            const semanasIncompletas = [];

                            semanasOrdenadas.forEach(([lunes, datos], index) => {
                                // Calcular total semanal (trabajados + remotos)
                                let totalSemanal = datos.trabajados.reduce((sum, r) => sum + r.total, 0);

                                // Agregar horas de d√≠as remotos
                                if (datos.remotos && datos.remotos.length > 0) {
                                    totalSemanal += datos.remotos.length * horasDiariasObjetivo;
                                }

                                const horasSem = Math.floor(totalSemanal);
                                const minutosSem = Math.round((totalSemanal - horasSem) * 60);

                                const fechaLunes = new Date(lunes.replace(/-/g, '/') + ' 00:00:00');
                                const fechaDomingo = new Date(fechaLunes);
                                fechaDomingo.setDate(fechaLunes.getDate() + 6);
                                const domingo = fechaDomingo.toISOString().split('T')[0];

                                let fechaFin = domingo;
                                let esIncompleta = false;
                                let continuaEn = '';

                                if (domingo > ultimaFechaMes) {
                                    fechaFin = ultimaFechaMes;
                                    esIncompleta = true;

                                    const mesSiguiente = mesActual === 12 ? 1 : mesActual + 1;
                                    const a√±oSiguiente = mesActual === 12 ? a√±oActual + 1 : a√±oActual;
                                    const fechaSiguiente = new Date(a√±oSiguiente, mesSiguiente - 1, 1);
                                    const nombreMesSiguiente = fechaSiguiente.toLocaleDateString('es-ES', { month: 'long' });
                                    continuaEn = `contin√∫a en ${nombreMesSiguiente}`;
                                }

                                if (lunes < primerDiaMes) {
                                    lunes = primerDiaMes;
                                    esIncompleta = true;
                                    const mesAnterior = mesActual === 1 ? 12 : mesActual - 1;
                                    const a√±oAnterior = mesActual === 1 ? a√±oActual - 1 : a√±oActual;
                                    const fechaAnterior = new Date(a√±oAnterior, mesAnterior - 1, 1);
                                    const nombreMesAnterior = fechaAnterior.toLocaleDateString('es-ES', { month: 'long' });
                                    continuaEn = `viene de ${nombreMesAnterior}`;
                                }

                                const lunesFormato = (lunes < primerDiaMes ? primerDiaMes : lunes).split('-').reverse().join('/');
                                const finFormato = fechaFin.split('-').reverse().join('/');

                                const asterisco = esIncompleta ? '*' : '';

                                seccion += `   Semana ${index + 1} (${lunesFormato} - ${finFormato})${asterisco}:\n`;
                                seccion += `      ‚îî‚îÄ ${horasSem}h ${minutosSem}m`;

                                const notasExtras = [];
                                if (datos.feriados.length > 0) notasExtras.push(`${datos.feriados.length} feriado(s)`);
                                if (datos.ausencias.length > 0) notasExtras.push(`${datos.ausencias.length} ausencia(s)`);
                                if (datos.vacaciones.length > 0) notasExtras.push(`${datos.vacaciones.length} vacacion(es)`);
                                if (datos.enfermedades.length > 0) notasExtras.push(`${datos.enfermedades.length} enfermedad(es)`);
                                if (datos.asuetos.length > 0) notasExtras.push(`${datos.asuetos.length} asueto(s)`);
                                if (datos.paros.length > 0) notasExtras.push(`${datos.paros.length} paro(s)`);
                                if (datos.remotos.length > 0) notasExtras.push(`${datos.remotos.length} remoto(s)`);
                                if (datos.capacitaciones.length > 0) notasExtras.push(`${datos.capacitaciones.length} capacitacion(es)`);

                                if (notasExtras.length > 0) {
                                    seccion += ` [${notasExtras.join(', ')}]`;
                                }

                                seccion += '\n\n';

                                if (esIncompleta && continuaEn) {
                                    semanasIncompletas.push(`* Semana ${index + 1}: ${continuaEn}`);
                                }
                            });

                            if (semanasIncompletas.length > 0) {
                                seccion += semanasIncompletas.join('\n') + '\n';
                            }

                            return seccion;
                        },

                        configuracion: () => {
                            const nombresDias = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];

                            const diasTexto = D.diasHabiles()
                                .map(d => nombresDias[d])
                                .join(', ');

                            return `

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

‚öôÔ∏è Ajustes
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

   ‚Ä¢ Horas diarias:          ${D.horasDiarias()}
   ‚Ä¢ D√≠as h√°biles/semana:    ${diasTexto}
   ‚Ä¢ Horas semanales:        ${D.horasSemanales()}`;
                        },

                        footer: () => `

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

Generado por Sistema Horarios
`
                    };

                    const contenido =
                        reporte.header() +
                        reporte.resumenGeneral() +
                        reporte.detalleDiario() +
                        reporte.totalesPorSemana() +
                        reporte.configuracion() +
                        reporte.footer();

                    try {
                        const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `reporte_${mesSeleccionado}.txt`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);

                        mostrarToast('Reporte generado', 'success');
                    } catch (e) {
                        console.error('Error generando reporte:', e);
                        mostrarToast('Error al generar reporte', 'error');
                    }
                }
                // Funci√≥n auxiliar para sumar minutos a un formato HH:MM
                function sumarMinutosAHora(horaString, minutosASumar) {
                    let totalMinutos = minutosASumar;

                    // Si ya existe un valor en el input (ej: 00:20), lo sumamos
                    if (horaString && horaString.includes(':')) {
                        const [h, m] = horaString.split(':').map(Number);
                        if (!isNaN(h) && !isNaN(m)) {
                            totalMinutos += (h * 60) + m;
                        }
                    }

                    const horas = Math.floor(totalMinutos / 60);
                    const mins = Math.round(totalMinutos % 60);

                    // Formatear a HH:MM
                    return `${String(horas).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
                }

                function actualizarEstadoBotonTimerMain() {
                    const btn = document.getElementById('btn-timer-main');
                    const card = document.getElementById('stats-card');
                    if (!btn) return;

                    // Verificamos si el 'modo-lote' es el que est√° visible actualmente
                    const modoLote = document.getElementById('modo-lote');
                    if (modoLote && modoLote.style.display !== 'none') {
                        // Si estamos en modo lote, nos aseguramos que el bot√≥n siga oculto y SALIMOS
                        btn.style.display = 'none';
                        return;
                    }

                    // Si no estamos en modo lote, nos aseguramos que se vea
                    btn.style.display = '';

                    const hoy = obtenerFechaHoy();
                    const registroHoy = D.registros().find(r => r.fecha === hoy);

                    //  CLAVE ESPEC√çFICA POR PERFIL
                    const perfilId = window.PerfilManager ? PerfilManager.obtenerPerfilActual() : 'default';
                    const storageKey = `breakStartTime_${perfilId}`;
                    const isRunning = localStorage.getItem(storageKey) !== null;
                    const icon = btn.querySelector('use');

                    const diaCerrado = registroHoy && registroHoy.salida && registroHoy.salida.trim() !== '';

                    if (!isRunning && (!registroHoy || diaCerrado)) {
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                        btn.style.cursor = 'not-allowed';
                        btn.title = diaCerrado ? "D√≠a finalizado" : "Debes registrar entrada primero";
                    } else {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                        btn.title = isRunning ? "Detener descanso" : "Iniciar descanso";
                    }

                    if (isRunning) {
                        // Estado ACTIVO
                        btn.classList.add('running');
                        btn.style.color = 'var(--c-red)';
                        btn.style.borderColor = 'var(--c-red)';
                        icon.setAttribute('href', '#icon-exit');

                        if (card) {
                            card.classList.add('timer-running');
                            const titulo = card.querySelector('h2');

                            // Mantener contexto de vista
                            const vistaActual = D.vistaActual();
                            const icono = vistaActual === 'semana'
                                ? '<svg class="icon"><use href="#icon-calendar-simple"/></svg>'
                                : '<svg class="icon"><use href="#icon-clock"/></svg>';

                            const contexto = vistaActual === 'semana' ? 'Esta Semana' : 'Hoy';

                            if (titulo) {
                                titulo.innerHTML = `${icono} ${contexto} - <svg class="icon"><use href="#icon-exit"/></svg> Tiempo fuera`;
                            }
                        }

                    } else {
                        // Estado INACTIVO
                        btn.classList.remove('running');
                        btn.style.color = 'var(--text-main)';
                        btn.style.borderColor = 'var(--border)';
                        icon.setAttribute('href', '#icon-exit');

                        if (card) card.classList.remove('timer-running');
                    }
                }

                async function toggleTimerBreakMain() {
                    //  CLAVE ESPEC√çFICA POR PERFIL
                    const perfilId = window.PerfilManager ? PerfilManager.obtenerPerfilActual() : 'default';
                    const storageKey = `breakStartTime_${perfilId}`;
                    const storedStart = localStorage.getItem(storageKey);
                    const hoy = obtenerFechaHoy();
                    const registroHoy = D.registros().find(r => r.fecha === hoy);

                    // Doble verificaci√≥n de seguridad
                    if (!storedStart && !registroHoy) {
                        mostrarToast('Debes crear un registro para hoy primero', 'warning');
                        return;
                    }

                    if (!storedStart) {
                        // --- INICIAR ---
                        localStorage.setItem(storageKey, Date.now());
                        mostrarToast('‚è±Ô∏è Tiempo fuera iniciado', 'info');
                    } else {
                        // --- DETENER ---
                        const start = parseInt(storedStart);
                        const end = Date.now();
                        const diffMs = end - start;

                        // NUEVO: Calcular minutos con umbral de 30 segundos
                        const segundosTranscurridos = Math.floor(diffMs / 1000);
                        let minutosTranscurridos = Math.floor(segundosTranscurridos / 60);
                        const segundosRestantes = segundosTranscurridos % 60;

                        // Si los segundos restantes son >= 30, sumar 1 minuto m√°s
                        if (segundosRestantes >= 30) {
                            minutosTranscurridos += 1;
                        }

                        // Si el tiempo es menor a 30 segundos, no registrar nada
                        if (segundosTranscurridos < 30) {
                            localStorage.removeItem(storageKey);
                            mostrarToast('‚è±Ô∏è Tiempo muy corto, no se registr√≥', 'info');
                            actualizarEstadoBotonTimerMain();
                            actualizarUI();
                            return;
                        }

                        // Calcular nuevo tiempo
                        const tiempoActual = registroHoy.tiempoFuera || '00:00';
                        const nuevoTiempoFuera = sumarMinutosAHora(tiempoActual, minutosTranscurridos);

                        // Actualizar el registro en memoria
                        registroHoy.tiempoFuera = nuevoTiempoFuera;

                        // Recalcular totales del registro (horas netas)
                        const t = D.calcularHoras(registroHoy.entrada, registroHoy.salida, nuevoTiempoFuera);
                        registroHoy.horas = t?.horas || 0;
                        registroHoy.minutos = t?.minutos || 0;
                        registroHoy.total = t?.total || 0;
                        HistoryManager.saveState(D.registros());

                        // Guardar en base de datos
                        localStorage.removeItem(storageKey);
                        await D.guardarYActualizar(true, registroHoy.id); // Guardamos y refrescamos UI

                        const mensaje = minutosTranscurridos === 1
                            ? 'Se descont√≥ 1 minuto al registro de hoy'
                            : `Se descontaron ${minutosTranscurridos} minutos al registro de hoy`;
                        mostrarToast(mensaje, 'success');
                    }

                    actualizarEstadoBotonTimerMain();
                }

                function setBloqueoEdicion(bloqueado) {
                    edicionBloqueada = bloqueado;

                    const btnLock = $('btn-lock-toggle');
                    if (btnLock) {
                        const icon = btnLock.querySelector('use');
                        icon.setAttribute('href', bloqueado ? '#icon-lock' : '#icon-lock-open');
                        btnLock.title = bloqueado ? "Desbloquear edici√≥n" : "Bloquear edici√≥n";
                        btnLock.style.color = bloqueado ? 'var(--c-red)' : 'var(--text-main)';
                    }

                    // Bloquear Inputs (Menos el bot√≥n de cr√©dito, que se maneja aparte)
                    const inputs = ['edit-fecha', 'edit-entrada', 'edit-salida', 'edit-tiempo-fuera'];
                    inputs.forEach(id => {
                        const el = $(id);
                        if (el) el.disabled = bloqueado;
                    });

                    // Bloquear Botones generales
                    const modal = $('modal-editar');
                    if (modal) {
                        const botones = modal.querySelectorAll('button:not(#btn-lock-toggle):not(.btn-cancel):not(#btn-toggle-credito)');
                        botones.forEach(btn => {
                            btn.disabled = bloqueado;
                        });
                    }

                    // IMPORTANTE: Forzamos la revisi√≥n del bot√≥n de cr√©dito AHORA MISMO
                    verificarBloqueoCredito();
                }

                function toggleBloqueoEdicion() {
                    setBloqueoEdicion(!edicionBloqueada);
                }

                function renderizarListaPerfiles() {
                    const lista = document.getElementById('lista-perfiles-botones');
                    if (!lista) return;

                    lista.innerHTML = '';
                    const perfiles = window.PerfilManager.obtenerListaPerfiles();

                    perfiles.forEach(p => {
                        const container = document.createElement('div');
                        container.className = `btn-perfil-select ${p.esActual ? 'activo' : ''}`;

                        const infoSection = document.createElement('div');
                        infoSection.className = 'btn-perfil-info';

                        const nombreSpan = document.createElement('div');
                        nombreSpan.className = 'btn-perfil-nombre';
                        nombreSpan.textContent = p.nombre;

                        infoSection.appendChild(nombreSpan);

                        if (p.esActual) {
                            const badge = document.createElement('div');
                            badge.className = 'btn-perfil-badge';
                            badge.textContent = '‚úì Activo';
                            infoSection.appendChild(badge);
                        }

                        const editBtn = document.createElement('button');
                        editBtn.className = 'btn-perfil-edit';
                        editBtn.innerHTML = '<svg class="icon"><use href="#icon-edit"/></svg>';
                        editBtn.title = 'Editar perfil';
                        editBtn.onclick = (e) => {
                            e.stopPropagation();
                            UILogic.abrirEditorPerfil(p.id);
                        };

                        container.onclick = () => {
                            if (!p.esActual) {
                                window.PerfilManager.cambiarPerfil(p.id);
                            }
                        };

                        if (p.esActual) {
                            container.style.cursor = 'default';
                        }

                        container.appendChild(infoSection);
                        container.appendChild(editBtn);
                        lista.appendChild(container);
                    });
                }

                function abrirSelectorPerfiles() {
                    ModalManager.abrir('modal-selector-perfiles', () => {
                        const inputNuevo = document.getElementById('nombre-nuevo-perfil-selector');
                        if (inputNuevo) inputNuevo.value = '';

                        renderizarListaPerfiles();

                        const temaOscuro = document.body.classList.contains('dark-mode');
                        const toggleBtnModal = document.getElementById('theme-toggle-modal');

                        if (toggleBtnModal) {
                            const icon = toggleBtnModal.querySelector('use');
                            if (temaOscuro) {
                                icon.setAttribute('href', '#icon-sun');
                            } else {
                                icon.setAttribute('href', '#icon-moon');
                            }
                        }
                    });
                }

                function crearPerfilDesdeSelector() {
                    const input = document.getElementById('nombre-nuevo-perfil-selector');
                    if (!input) return;

                    // 1. Limpieza b√°sica
                    const nombre = S.sanitizeString(input.value.trim(), 30);

                    if (!nombre) {
                        mostrarToast('Ingresa un nombre para el perfil', 'error');
                        return;
                    }

                    // Permite: Letras, N√∫meros, Espacios, Guiones, Tildes y √ë
                    const regexSeguro = /^[a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\-_ ]+$/;

                    if (!regexSeguro.test(nombre)) {
                        mostrarToast('El nombre contiene caracteres no v√°lidos.\nSolo letras, n√∫meros y espacios.', 'error');
                        return;
                    }

                    const perfiles = JSON.parse(localStorage.getItem('perfiles') || '{}');

                    //  VALIDACI√ìN DE NOMBRE DUPLICADO (case-insensitive)
                    const nombreNormalizado = nombre.toLowerCase().trim();
                    const nombreExiste = Object.values(perfiles).some(perfil =>
                        perfil.nombre.toLowerCase().trim() === nombreNormalizado
                    );

                    if (nombreExiste) {
                        mostrarToast('Ya existe un perfil con ese nombre', 'error');
                        return;
                    }

                    if (Object.keys(perfiles).length >= 7) {
                        mostrarToast('M√°ximo de perfiles alcanzado (7)', 'error');
                        return;
                    }

                    const id = 'perfil_' + Date.now();
                    perfiles[id] = {
                        nombre: nombre,
                        registros: [],
                        diasHabiles: [1, 2, 3, 4, 5], // Array por defecto
                        horasDiarias: 7
                    };

                    localStorage.setItem('perfiles', JSON.stringify(perfiles));

                    // FORZAR ACTUALIZACI√ìN DEL PERFILMANAGER
                    if (window.PerfilManager) {
                        // Recargar los perfiles internamente
                        window.PerfilManager.inicializar();
                    }

                    mostrarToast(`Perfil "${nombre}" creado`, 'success');

                    input.value = '';

                    // RENDERIZAR LISTA ACTUALIZADA
                    renderizarListaPerfiles();

                    // Resaltar nuevo perfil
                    requestAnimationFrame(() => {
                        const lista = document.getElementById('lista-perfiles-botones');
                        const nuevoPerfilElement = lista?.lastElementChild;
                        if (nuevoPerfilElement) {
                            nuevoPerfilElement.style.animation = 'zoomIn 0.3s ease-out';
                            nuevoPerfilElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    });
                }

                function cerrarSelectorPerfiles() {
                    ModalManager.cerrar('modal-selector-perfiles');
                }

                function mostrarconfig() {
                    ModalManager.alternar('modal-selector-perfiles', 'modal-config', null, () => {
                        $('config-horas-diarias').value = D.horasDiarias();

                        const diasActivos = D.diasHabiles();
                        const checkboxes = document.querySelectorAll('input[name="dia-habil"]');
                        checkboxes.forEach(cb => {
                            cb.checked = diasActivos.includes(parseInt(cb.value));
                            cb.onchange = UILogic.actualizarFeedbackConfig;
                        });

                        UILogic.actualizarFeedbackConfig();
                    });
                }

                function abrirEditorPerfil(perfilId) {
                    perfilEnEdicion = perfilId;
                    const perfiles = JSON.parse(localStorage.getItem('perfiles') || '{}');
                    const perfil = perfiles[perfilId];

                    if (!perfil) {
                        mostrarToast('Perfil no encontrado', 'error');
                        return;
                    }

                    document.getElementById('nombre-perfil-editar').value = perfil.nombre;
                    document.getElementById('id-perfil-editar').value = perfilId;

                    // Deshabilitar bot√≥n eliminar si es el perfil default
                    const btnEliminar = document.getElementById('btn-eliminar-perfil-editor');
                    if (btnEliminar) {
                        btnEliminar.disabled = (perfilId === 'default');
                        btnEliminar.style.opacity = (perfilId === 'default') ? '0.5' : '1';
                    }

                    // Cerrar selector y abrir editor
                    ModalManager.alternar('modal-selector-perfiles', 'modal-editar-perfil');
                }

                function cerrarEditorPerfil() {
                    perfilEnEdicion = null;
                    ModalManager.alternar('modal-editar-perfil', 'modal-selector-perfiles', null, () => {
                        const inputNuevo = document.getElementById('nombre-nuevo-perfil-selector');
                        if (inputNuevo) inputNuevo.value = '';
                        renderizarListaPerfiles();
                    });
                }

                function guardarEdicionPerfil() {
                    if (!perfilEnEdicion) return;

                    // 1. Limpieza b√°sica
                    const nuevoNombre = S.sanitizeString(document.getElementById('nombre-perfil-editar').value.trim(), 30);

                    if (!nuevoNombre) {
                        mostrarToast('Ingresa un nombre v√°lido', 'error');
                        return;
                    }

                    // --- VALIDACI√ìN ESTRICTA ---
                    const regexSeguro = /^[a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\-_ ]+$/;

                    if (!regexSeguro.test(nuevoNombre)) {
                        mostrarToast('Caracteres no permitidos en el nombre.', 'error');
                        return;
                    }

                    const perfiles = JSON.parse(localStorage.getItem('perfiles') || '{}');

                    if (!perfiles[perfilEnEdicion]) {
                        mostrarToast('Perfil no encontrado', 'error');
                        return;
                    }

                    // Detectar cambios
                    if (perfiles[perfilEnEdicion].nombre === nuevoNombre) {
                        mostrarToast('Sin cambios', 'info');
                        cerrarEditorPerfil();
                        return;
                    }

                    // VALIDACI√ìN DE NOMBRE DUPLICADO (case-insensitive)
                    const nombreNormalizado = nuevoNombre.toLowerCase().trim();
                    const nombreExiste = Object.entries(perfiles).some(([id, perfil]) =>
                        id !== perfilEnEdicion && // Excluir el perfil que estamos editando
                        perfil.nombre.toLowerCase().trim() === nombreNormalizado
                    );

                    if (nombreExiste) {
                        mostrarToast('Ya existe otro perfil con ese nombre', 'error');
                        return;
                    }

                    perfiles[perfilEnEdicion].nombre = nuevoNombre;
                    localStorage.setItem('perfiles', JSON.stringify(perfiles));

                    const perfilActual = window.PerfilManager.obtenerPerfilActual();
                    if (perfilEnEdicion === perfilActual) {
                        const btnTexto = document.getElementById('nombre-perfil-header');
                        if (btnTexto) btnTexto.textContent = nuevoNombre;
                    }

                    if (window.PerfilManager) {
                        window.PerfilManager.inicializar();
                    }

                    mostrarToast('Perfil actualizado', 'success');
                    cerrarEditorPerfil();
                }

                async function eliminarPerfilDesdeEditor() {
                    if (!perfilEnEdicion || perfilEnEdicion === 'default') {
                        mostrarToast('No se puede eliminar el perfil Principal', 'error');
                        return;
                    }

                    const perfiles = JSON.parse(localStorage.getItem('perfiles') || '{}');
                    const perfil = perfiles[perfilEnEdicion];

                    if (!perfil) {
                        mostrarToast('Perfil no encontrado', 'error');
                        return;
                    }

                    const confirmacion = window.confirm(`¬øEst√°s seguro de que quieres eliminar el perfil "${perfil.nombre}"? Esta acci√≥n no se puede deshacer.`);

                    if (!confirmacion) return;

                    // Preguntar por Backup
                    const deseaBackup = window.confirm(`Descargar copia de registros del perfil "${perfil.nombre}" antes de eliminar?`);

                    if (deseaBackup) {
                        // Exportar datos del perfil antes de eliminar
                        const perfilActualTemp = window.PerfilManager.obtenerPerfilActual();

                        // Si no es el perfil actual, cambiar temporalmente para exportar
                        if (perfilEnEdicion !== perfilActualTemp) {
                            // Guardar datos del perfil a eliminar
                            const datosExportar = {
                                registros: perfil.registros,
                                diasHabiles: perfil.diasHabiles,
                                horasDiarias: perfil.horasDiarias,
                                fecha: new Date().toISOString(),
                                version: 3
                            };

                            const blob = new Blob([JSON.stringify(datosExportar, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `backup_${perfil.nombre}_${new Date().toISOString().split('T')[0]}.json`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        } else {
                            // Si es el perfil actual, usar la funci√≥n normal
                            D.exportarJSON();
                        }

                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }

                    // Eliminar el perfil
                    delete perfiles[perfilEnEdicion];
                    localStorage.setItem('perfiles', JSON.stringify(perfiles));

                    // Si era el perfil actual, cambiar a default
                    const perfilActual = window.PerfilManager.obtenerPerfilActual();
                    if (perfilEnEdicion === perfilActual) {
                        localStorage.setItem('perfilActivo', 'default');
                        mostrarToast('Perfil eliminado. Recargando...', 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        // --- Actualizar memoria del PerfilManager ---
                        if (window.PerfilManager) {
                            window.PerfilManager.inicializar();
                        }

                        mostrarToast('Perfil eliminado', 'success');
                        cerrarEditorPerfil();
                    }
                }

                function toggleModoLote() {
                    const modoNormal = document.getElementById('modo-normal');
                    const modoLote = document.getElementById('modo-lote');
                    const btnTexto = document.getElementById('btn-registrar-texto');
                    const btnTimer = document.getElementById('btn-timer-main');
                    const btn = document.getElementById('btn-agregar');

                    modoLoteActivo = !modoLoteActivo;

                    if (modoLoteActivo) {
                        // Cambiar a modo lote
                        modoNormal.classList.add('fade-out');

                        setTimeout(() => {
                            modoNormal.style.display = 'none';
                            modoLote.style.display = 'block';

                            // Forzar reflow
                            modoLote.offsetHeight;

                            modoLote.classList.remove('fade-out');

                            // Limpiar campos
                            document.getElementById('lote-tipo').value = 'feriado';
                            document.getElementById('lote-fecha-desde').value = '';
                            document.getElementById('lote-fecha-hasta').value = '';

                            btnTexto.textContent = 'Registrar Lote';
                            btn.style.background = '';
                            btn.style.color = '';

                            const iconUse = btn.querySelector('svg use');
                            if (iconUse) iconUse.setAttribute('href', '#icon-save');

                            btnTimer.disabled = true;
                            btnTimer.style.opacity = '0.3';

                            actualizarBotonLote();
                        }, 300);

                    } else {
                        // Volver a modo normal
                        modoLote.classList.add('fade-out');

                        setTimeout(() => {
                            modoLote.style.display = 'none';
                            modoNormal.style.display = 'block';

                            // Forzar reflow
                            modoNormal.offsetHeight;

                            modoNormal.classList.remove('fade-out');

                            btnTexto.textContent = 'Registrar';
                            btn.style.background = '';
                            btn.style.color = '';

                            const iconUse = btn.querySelector('svg use');
                            if (iconUse) iconUse.setAttribute('href', '#icon-save');

                            btnTimer.disabled = false;
                            btnTimer.style.opacity = '1';

                            actualizarEstadoBotonTimerMain();
                        }, 300);
                    }
                }

                async function ejecutarAccionRegistro() {
                    if (modoLoteActivo) {
                        await registrarLoteDesdeCard();
                    } else {
                        await DataManagement.agregarRegistro();
                    }

                    // Actualizar el estado del bot√≥n despu√©s de la operaci√≥n
                    if (modoLoteActivo) {
                        setTimeout(() => actualizarBotonLote(), 100);
                    }
                }

                async function registrarLoteDesdeCard() {
                    const inputDesde = document.getElementById('lote-fecha-desde');
                    const inputHasta = document.getElementById('lote-fecha-hasta');
                    const tipo = document.getElementById('lote-tipo').value;

                    // VALIDACI√ìN: Verificar si el usuario escribi√≥ algo inv√°lido
                    if (inputDesde.value === '' && inputDesde.validity && !inputDesde.validity.valid) {
                        mostrarToast('Fecha inicial inv√°lida', 'error');
                        return;
                    }

                    if (inputHasta.value === '' && inputHasta.validity && !inputHasta.validity.valid) {
                        mostrarToast('Fecha final inv√°lida', 'error');
                        return;
                    }

                    const desde = inputDesde.value;
                    const hasta = inputHasta.value;

                    // --- CASO 1: Sin fechas (registrar HOY) ---
                    if (!desde && !hasta) {
                        // Verificar que realmente est√©n vac√≠os y no inv√°lidos
                        if (!inputDesde.checkValidity() || !inputHasta.checkValidity()) {
                            mostrarToast('Revisa las fechas ingresadas', 'error');
                            return;
                        }

                        if (tipo === 'normal') {
                            mostrarToast('Completa los campos Desde y Hasta.', 'info');
                            return;
                        }

                        // ... resto del c√≥digo del CASO 1

                        const fechaHoy = UILogic.obtenerFechaHoy();
                        const registroExistente = DataManagement.registros().find(r => r.fecha === fechaHoy);
                        if (registroExistente) {
                            mostrarToast('Ya existe un registro para hoy', 'warning');
                            return;
                        }

                        // Intentar registrar
                        try {
                            await DataManagement.registrarDiaEspecial(fechaHoy, tipo);
                            // Solo limpiar si fue exitoso
                            document.getElementById('lote-fecha-desde').value = '';
                            document.getElementById('lote-fecha-hasta').value = '';
                        } catch (error) {
                            // No limpiar campos si hubo error
                            console.error('Error al registrar:', error);
                        }
                        return;
                    }

                    // --- CASO 2: Solo campo "Desde" (registrar d√≠a √∫nico) ---
                    if (desde && !hasta) {
                        if (tipo === 'normal') {
                            mostrarToast('Completa ambos campos', 'info');
                            return;
                        }

                        // Verificar si ya existe algo en esa fecha
                        const registroExistente = DataManagement.registros().find(r => r.fecha === desde);
                        if (registroExistente) {
                            mostrarToast('Ya existe un registro para esa fecha', 'warning');
                            return;
                        }

                        // Intentar registrar
                        try {
                            await DataManagement.registrarDiaEspecial(desde, tipo);
                            // Solo limpiar si fue exitoso
                            document.getElementById('lote-fecha-desde').value = '';
                            document.getElementById('lote-fecha-hasta').value = '';
                        } catch (error) {
                            // No limpiar campos si hubo error
                            console.error('Error al registrar:', error);
                        }
                        return;
                    }

                    // --- CASO 3: Solo "Hasta" sin "Desde" (error) ---
                    if (!desde && hasta) {
                        mostrarToast('Completa ambos campos', 'info');
                        return;
                    }

                    if (desde > hasta) {
                        mostrarToast('La fecha inicial debe ser superior a la final', 'error');
                        return;
                    }

                    // --- L√ìGICA DE RANGO ---
                    let registrosDelTipoEnRango;

                    if (tipo === 'normal') {
                        // Contar registros NORMALES (no especiales) en el rango
                        registrosDelTipoEnRango = DataManagement.registros().filter(r => {
                            const dentroDelRango = r.fecha >= desde && r.fecha <= hasta;
                            const esEspecial = TiposRegistro.esRegistroEspecial(r.entrada, r.salida);
                            return dentroDelRango && !esEspecial;
                        });
                    } else {
                        //  Obtener c√≥digos del tipo seleccionado
                        const codigosTipo = TiposRegistro.obtenerCodigosPorTipo(tipo);

                        if (!codigosTipo) {
                            mostrarToast('Tipo de registro inv√°lido', 'error');
                            return;
                        }

                        registrosDelTipoEnRango = DataManagement.registros().filter(r =>
                            r.fecha >= desde &&
                            r.fecha <= hasta &&
                            r.entrada === codigosTipo.entrada &&
                            r.salida === codigosTipo.salida
                        );
                    }

                    // Intentar la operaci√≥n (registrar o borrar)
                    try {
                        if (tipo === 'normal') {
                            await DataManagement.borrarPeriodoDirecto(desde, hasta);
                        } else {
                            await DataManagement.registrarVacacionesDirecto(desde, hasta, tipo);
                        }

                        // Solo limpiar campos si la operaci√≥n fue exitosa
                        document.getElementById('lote-fecha-desde').value = '';
                        document.getElementById('lote-fecha-hasta').value = '';
                    } catch (error) {
                        // No limpiar campos si hubo error
                        console.error('Error en operaci√≥n de lote:', error);
                    }
                }

                function actualizarBotonLote() {
                    const tipo = document.getElementById('lote-tipo').value;
                    const desde = document.getElementById('lote-fecha-desde').value;
                    const hasta = document.getElementById('lote-fecha-hasta').value;
                    const btn = document.getElementById('btn-agregar');
                    const btnTexto = document.getElementById('btn-registrar-texto');

                    // 1. LIMPIEZA: Reseteamos siempre al estilo original
                    btn.style.background = '';
                    btn.style.color = '';

                    // 2. Si faltan fechas, mostramos "Registrar" est√°ndar y salimos
                    if (!desde && !hasta) {
                        btnTexto.textContent = 'Registrar';

                        // Restaurar √≠cono original
                        const iconUse = btn.querySelector('svg use');
                        if (iconUse) iconUse.setAttribute('href', '#icon-save');

                        return;
                    }

                    // Solo "Desde" (d√≠a √∫nico)
                    if (desde && !hasta) {
                        if (tipo === 'normal') {
                            btnTexto.textContent = 'Requiere Rango';
                            btn.style.color = 'var(--c-red)';

                            // Restaurar √≠cono
                            const iconUse = btn.querySelector('svg use');
                            if (iconUse) iconUse.setAttribute('href', '#icon-save');

                            return;
                        }

                        // Verificar si ya existe
                        const registroExiste = DataManagement.registros().find(r => r.fecha === desde);
                        if (registroExiste) {
                            btnTexto.textContent = 'Registrado';
                            btn.style.color = 'var(--text-muted)';

                            const iconUse = btn.querySelector('svg use');
                            if (iconUse) iconUse.setAttribute('href', '#icon-save');
                        } else {
                            btnTexto.textContent = 'Registrar';

                            const iconUse = btn.querySelector('svg use');
                            if (iconUse) iconUse.setAttribute('href', '#icon-save');
                        }
                        return;
                    }

                    // Solo "Hasta" (error)
                    if (!desde && hasta) {
                        btnTexto.textContent = 'Requiere Rango';
                        btn.style.color = 'var(--c-red)';
                        return;
                    }

                    // VALIDACI√ìN DE FECHAS ANTES DE PROCESAR
                    if (!S.validarFechaSegura(desde)) {
                        btnTexto.textContent = 'Fecha Inicial Inv√°lida';
                        btn.style.color = 'var(--c-red)';

                        const iconUse = btn.querySelector('svg use');
                        if (iconUse) iconUse.setAttribute('href', '#icon-save');

                        return;
                    }

                    if (!S.validarFechaSegura(hasta)) {
                        btnTexto.textContent = 'Fecha Final Inv√°lida';
                        btn.style.color = 'var(--c-red)';

                        const iconUse = btn.querySelector('svg use');
                        if (iconUse) iconUse.setAttribute('href', '#icon-save');

                        return;
                    }

                    if (desde > hasta) {
                        btnTexto.textContent = 'Rango Inv√°lido';
                        btn.style.color = 'var(--c-red)';

                        const iconUse = btn.querySelector('svg use');
                        if (iconUse) iconUse.setAttribute('href', '#icon-save');

                        return;
                    }

                    // 3. Calcular d√≠as totales en el rango
                    const fechaInicio = new Date(desde.replace(/-/g, '/') + ' 00:00:00');
                    const fechaFin = new Date(hasta.replace(/-/g, '/') + ' 00:00:00');
                    const diffTime = Math.abs(fechaFin - fechaInicio);
                    const diasTotales = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

                    // 4. Buscamos registros en el rango
                    let registrosDelTipoEnRango;

                    if (tipo === 'normal') {
                        // Contar registros NORMALES (no especiales) en el rango
                        registrosDelTipoEnRango = DataManagement.registros().filter(r => {
                            const dentroDelRango = r.fecha >= desde && r.fecha <= hasta;
                            const esEspecial = TiposRegistro.esRegistroEspecial(r.entrada, r.salida);
                            return dentroDelRango && !esEspecial;
                        });

                        const cantidadRegistros = registrosDelTipoEnRango.length;

                        // Caso Normal: Siempre es una acci√≥n de borrado
                        if (cantidadRegistros > 0) {
                            btnTexto.textContent = `Borrar (${cantidadRegistros})`;
                            btn.style.color = 'var(--c-red)';

                            // Cambiar icono a papelera
                            const iconUse = btn.querySelector('svg use');
                            if (iconUse) iconUse.setAttribute('href', '#icon-trash');
                        } else {
                            btnTexto.textContent = 'Sin Registros';
                            btn.style.color = 'var(--text-muted)';

                            // Volver al icono original (save)
                            const iconUse = btn.querySelector('svg use');
                            if (iconUse) iconUse.setAttribute('href', '#icon-save');
                        }
                    } else {
                        // Casos Especiales - Contar d√≠as OCUPADOS y d√≠as LIBRES
                        const codigosTipo = TiposRegistro.obtenerCodigosPorTipo(tipo);

                        if (codigosTipo) {
                            // Contar cu√°ntos d√≠as YA tienen este tipo de registro
                            registrosDelTipoEnRango = DataManagement.registros().filter(r =>
                                r.fecha >= desde &&
                                r.fecha <= hasta &&
                                r.entrada === codigosTipo.entrada &&
                                r.salida === codigosTipo.salida
                            );

                            // Contar cu√°ntos d√≠as tienen CUALQUIER tipo de registro
                            const diasOcupados = DataManagement.registros().filter(r =>
                                r.fecha >= desde && r.fecha <= hasta
                            );

                            const yaRegistrados = registrosDelTipoEnRango.length;
                            const disponibles = diasTotales - diasOcupados.length;
                            const sobreescribirOtros = diasOcupados.length - yaRegistrados;

                            if (disponibles === 0 && yaRegistrados === diasTotales) {
                                btnTexto.textContent = `Registrado (${diasTotales})`;
                                btn.style.color = 'var(--text-muted)';

                                const iconUse = btn.querySelector('svg use');
                                if (iconUse) iconUse.setAttribute('href', '#icon-save');
                            } else if (disponibles === diasTotales) {
                                btnTexto.textContent = `Registrar (${diasTotales})`;

                                const iconUse = btn.querySelector('svg use');
                                if (iconUse) iconUse.setAttribute('href', '#icon-save');
                            } else if (sobreescribirOtros > 0) {
                                btnTexto.textContent = `Registrar (${disponibles} - ${sobreescribirOtros})`;

                                const iconUse = btn.querySelector('svg use');
                                if (iconUse) iconUse.setAttribute('href', '#icon-save');
                            } else {
                                btnTexto.textContent = `Registrar (${disponibles})`;

                                const iconUse = btn.querySelector('svg use');
                                if (iconUse) iconUse.setAttribute('href', '#icon-save');
                            }
                        } else {
                            registrosDelTipoEnRango = [];
                            btnTexto.textContent = 'Registrar';

                            const iconUse = btn.querySelector('svg use');
                            if (iconUse) iconUse.setAttribute('href', '#icon-save');
                        }
                    }
                }

                function toggleCredito() {
                    const btn = document.getElementById('btn-toggle-credito');

                    // Usamos el dataset como fuente de verdad
                    const estaActivo = btn.dataset.activo === "true";

                    if (estaActivo) {
                        // --- DESACTIVAR (Volver a Gris original) ---
                        btn.dataset.activo = "false";

                        // Limpiamos estilos para que retome la clase .time-btn original
                        btn.style.background = '';
                        btn.style.color = '';
                        btn.style.border = ''; // Quitar borde
                    } else {
                        // --- ACTIVAR (Estilo "D√≠a H√°bil/Perfil") ---
                        btn.dataset.activo = "true";

                        // Aplicamos EXACTAMENTE el mismo estilo que .day-checkbox input:checked~span
                        btn.style.background = 'rgba(96, 172, 148, 0.1)'; // Fondo verde transparente
                        btn.style.color = 'var(--c-green)';                // Icono verde
                        btn.style.border = '1px solid var(--c-green)';     // Borde verde
                    }
                }

                function mostrarExportar() {
                    ModalManager.alternar('modal-config', 'modal-exportar', null, () => {
                        // Reset del selector
                        const tipoSelect = document.getElementById('tipo-exportacion');
                        if (tipoSelect) tipoSelect.value = 'todo';

                        // Ocultar campos de rango
                        const camposRango = document.getElementById('campos-rango-exportar');
                        if (camposRango) camposRango.style.display = 'none';

                        // Limpiar fechas
                        document.getElementById('export-fecha-desde').value = '';
                        document.getElementById('export-fecha-hasta').value = '';
                    });
                }

                function cerrarExportar() {
                    ModalManager.alternar('modal-exportar', 'modal-config');
                }

                function toggleCamposRangoExport() {
                    const tipo = document.getElementById('tipo-exportacion').value;
                    const camposRango = document.getElementById('campos-rango-exportar');

                    if (tipo === 'rango') {
                        camposRango.style.display = 'block';
                    } else {
                        camposRango.style.display = 'none';
                    }
                }

                async function ejecutarExportacion() {
                    const tipo = document.getElementById('tipo-exportacion').value;
                    const btn = document.querySelector('#modal-exportar .btn-export');

                    btn.disabled = true;

                    try {
                        if (tipo === 'todo') {
                            // Exportaci√≥n completa (funci√≥n existente)
                            D.exportarJSON();
                            cerrarExportar();

                        } else if (tipo === 'mes-actual') {
                            // Exportar solo mes actual
                            const hoy = new Date();
                            const mesActual = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;
                            await exportarRango(mesActual, mesActual, true);

                        } else if (tipo === 'rango') {
                            // Exportar rango personalizado
                            const desde = S.sanitizeString(document.getElementById('export-fecha-desde').value, 10);
                            const hasta = S.sanitizeString(document.getElementById('export-fecha-hasta').value, 10);

                            if (!desde || !hasta) {
                                mostrarToast('Completa ambas fechas', 'error');
                                btn.disabled = false;
                                return;
                            }

                            if (!S.validarFechaSegura(desde) || !S.validarFechaSegura(hasta)) {
                                mostrarToast('Fechas inv√°lidas', 'error');
                                btn.disabled = false;
                                return;
                            }

                            if (desde > hasta) {
                                mostrarToast('La fecha inicial debe ser anterior a la final', 'error');
                                btn.disabled = false;
                                return;
                            }

                            await exportarRango(desde, hasta, false);
                        }

                    } catch (error) {
                        console.error('Error en exportaci√≥n:', error);
                        mostrarToast('Error al exportar', 'error');
                    } finally {
                        btn.disabled = false;
                    }
                }

                async function exportarRango(desde, hasta, esMes = false) {
                    // Filtrar registros por rango
                    let registrosFiltrados;

                    if (esMes) {
                        // Mes completo: "2025-01" incluye del 01 al 31
                        const [a√±o, mes] = desde.split('-').map(Number);
                        registrosFiltrados = D.registros().filter(r => {
                            const [aReg, mReg] = r.fecha.split('-').map(Number);
                            return aReg === a√±o && mReg === mes;
                        });
                    } else {
                        // Rango exacto
                        registrosFiltrados = D.registros().filter(r =>
                            r.fecha >= desde && r.fecha <= hasta
                        );
                    }

                    if (registrosFiltrados.length === 0) {
                        mostrarToast('No hay registros en ese rango', 'warning');
                        return;
                    }

                    // Generar fecha local
                    const ahora = new Date();
                    const a√±o = ahora.getFullYear();
                    const mes = String(ahora.getMonth() + 1).padStart(2, '0');
                    const dia = String(ahora.getDate()).padStart(2, '0');
                    const hora = String(ahora.getHours()).padStart(2, '0');
                    const minuto = String(ahora.getMinutes()).padStart(2, '0');
                    const segundo = String(ahora.getSeconds()).padStart(2, '0');
                    const fechaLocal = `${a√±o}-${mes}-${dia} ${hora}:${minuto}:${segundo}`;

                    const data = {
                        registros: registrosFiltrados,
                        diasHabiles: D.diasHabiles(),
                        horasDiarias: D.horasDiarias(),
                        fecha: fechaLocal,
                        version: S.SECURITY_LIMITS.SCHEMA_VERSION,
                        rangoExportado: esMes ? `Mes ${desde}` : `${desde} a ${hasta}`

                    };

                    if (data.rangoExportado) {
                        data.rangoExportado = S.sanitizeString(data.rangoExportado, 100);
                    }

                    try {
                        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;

                        // Nombre del archivo
                        let nombrePerfil = 'Backup';
                        if (window.PerfilManager) {
                            nombrePerfil = window.PerfilManager.obtenerDatosPerfil().nombre;
                        }
                        const nombreSafe = nombrePerfil.replace(/[^a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë'\-_ ]/g, '').trim().replace(/\s+/g, '_');
                        const fechaHoy = `${a√±o}-${mes}-${dia}`;

                        const sufijo = esMes ? `_${desde}` : `_${desde}_${hasta}`;
                        a.download = `Horarios_${nombreSafe}${sufijo}_${fechaHoy}.json`;

                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);

                        const mensaje = esMes
                            ? `Exportados ${registrosFiltrados.length} registros del mes`
                            : `Exportados ${registrosFiltrados.length} registros`;
                        mostrarToast(mensaje, 'success');
                        cerrarExportar();

                    } catch (e) {
                        console.error(e);
                        mostrarToast('Error al exportar', 'error');
                    }
                }

                async function init() {
                    if (typeof (Storage) === "undefined") {
                        alert("Tu navegador no soporta localStorage.");
                        return;
                    }

                    PerfilManager.inicializar();

                    // --- EXPORTAR M√ìDULOS (Mantener igual) ---
                    window.DataManagement = {
                        agregarRegistro: D.agregarRegistro,
                        guardarConfig: D.guardarConfig,
                        exportarJSON: D.exportarJSON,
                        mostrarImportar: mostrarImportar,
                        importarDatos: D.importarDatos,
                        borrarTodoHistorial: D.borrarTodoHistorial,
                        guardarEdicion: D.guardarEdicion,
                        eliminarRegistroActual: D.eliminarRegistroActual,
                        undoAction: D.undoAction,
                        redoAction: D.redoAction,
                        aplicarFiltros: D.aplicarFiltros,
                        limpiarFiltros: D.limpiarFiltros,
                        registrarDiaEspecial: D.registrarDiaEspecial,
                        registros: D.registros,
                        diasHabiles: D.diasHabiles,
                        horasDiarias: D.horasDiarias,
                        setDiasHabiles: D.setDiasHabiles,
                        setHorasDiarias: D.setHorasDiarias,
                        calcularHoras: D.calcularHoras,
                        registrarVacacionesDirecto: D.registrarVacacionesDirecto,
                        borrarPeriodoDirecto: D.borrarPeriodoDirecto,
                        editarGrupo: D.editarGrupo,
                        guardarEdicionGrupo: D.guardarEdicionGrupo,
                        eliminarGrupoActual: D.eliminarGrupoActual,
                    };
                    window.HistoryManager = { undo: D.undoAction, redo: D.redoAction };
                    window.PWAInstaller = { instalarApp: PWAInstaller.instalarApp };
                    window.PerfilManager = PerfilManager;

                    window.UILogic = {
                        alternarTema, cerrarConfig, pegarHoraActual, alternarVista,
                        cerrarEdicion, mostrarImportar, cerrarImportar, actualizarUI, mostrarToast,
                        mostrarError, limpiarError, resetearBoton, restaurarBotonGuardarEdicion,
                        limpiarCampo, obtenerFechaHoy, mostrarFiltros, poblarSelectorMeses, actualizarBotonLote,
                        cerrarFiltros, registrarLoteDesdeCard, cambiarMesStats, generarReporte, toggleHistorico, toggleStats,
                        sumarMinutosAHora, toggleTimerBreakMain, actualizarEstadoBotonTimerMain, toggleBloqueoEdicion, setBloqueoEdicion,
                        actualizarFeedbackConfig, poblarSelectorMeses, abrirSelectorPerfiles, actualizarBotonLote,
                        cerrarSelectorPerfiles, abrirEditorPerfil, cerrarEditorPerfil, guardarEdicionPerfil, toggleModoLote,
                        eliminarPerfilDesdeEditor, crearPerfilDesdeSelector, renderizarListaPerfiles, ejecutarAccionRegistro,
                        iniciarCambioHoras, detenerCambio, mostrarconfig, alternarFechaActual, verificarBloqueoCredito,
                        toggleCredito, init, toggleFormulario, setBloqueoEdicionGrupo, toggleBloqueoEdicionGrupo, cerrarEdicionGrupo,
                        mostrarExportar, cerrarExportar, ejecutarExportacion, toggleCamposRangoExport, aplicarFeedbackRegistro,
                        iniciarTimerAutoCierreBotones, cancelarTimerAutoCierreBotones
                    };

                    // === LISTENERS E INTERACTIVIDAD ===

                    // A) Inputs normales del formulario principal (Solo formato)
                    ['entrada', 'salida'].forEach(id => {
                        const el = $(id);
                        if (el) el.addEventListener('input', formatearInput);
                    });

                    // B) Inputs del Modal Editar (Formato + Verificaci√≥n OPTIMIZADA)
                    const verificarBloqueCreditoDebounced = debounce(verificarBloqueoCredito, 200);

                    ['edit-entrada', 'edit-salida'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            // Input: formato inmediato + validaci√≥n debounced
                            el.addEventListener('input', (e) => {
                                formatearInput(e); // Inmediato (visual)
                                verificarBloqueCreditoDebounced(); // Debounced (l√≥gica)
                            });

                            // Change: validaci√≥n inmediata al perder foco
                            el.addEventListener('change', verificarBloqueoCredito);
                        }
                    });

                    // C) Otros inputs
                    const tf = document.getElementById('edit-tiempo-fuera');
                    if (tf) tf.addEventListener('input', formatearInput);

                    // ===================================
                    // LISTENERS PARA TECLA ENTER MODULE
                    // ===================================

                    // --- TARJETA REGISTRAR ---
                    // A) Enter en campo Entrada ‚Üí Pasa a Salida
                    const inputEntrada = document.getElementById('entrada');
                    if (inputEntrada) {
                        inputEntrada.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                const inputSalida = document.getElementById('salida');
                                if (inputSalida) inputSalida.focus();
                            }
                        });
                    }

                    // B) Enter en campo Salida ‚Üí Ejecuta Registrar Y cierra teclado
                    const inputSalida = document.getElementById('salida');
                    if (inputSalida) {
                        inputSalida.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                inputSalida.blur();

                                const btnAgregar = document.getElementById('btn-agregar');
                                if (btnAgregar && !btnAgregar.disabled) {
                                    btnAgregar.click();
                                }
                            }
                        });
                    }

                    // --- MODAL EDITAR ---
                    // C) Enter en campo Entrada (editar) ‚Üí Pasa a Salida
                    const editEntrada = document.getElementById('edit-entrada');
                    if (editEntrada) {
                        editEntrada.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                const editSalida = document.getElementById('edit-salida');
                                if (editSalida) editSalida.focus();
                            }
                        });
                    }

                    // D) Enter en campo Salida (editar) ‚Üí Pasa a Tiempo Fuera
                    const editSalida = document.getElementById('edit-salida');
                    if (editSalida) {
                        editSalida.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                const editTiempoFuera = document.getElementById('edit-tiempo-fuera');
                                if (editTiempoFuera) editTiempoFuera.focus();
                            }
                        });
                    }

                    // E) Enter en campo Tiempo Fuera (editar) ‚Üí Guarda Y cierra teclado
                    const editTiempoFuera = document.getElementById('edit-tiempo-fuera');
                    if (editTiempoFuera) {
                        editTiempoFuera.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                editTiempoFuera.blur(); // Cierra el teclado

                                const btnGuardar = document.querySelector('#modal-editar .btn-edit');
                                if (btnGuardar && !btnGuardar.disabled) {
                                    btnGuardar.click(); // Ejecuta guardar
                                }
                            }
                        });
                    }

                    // --- PERFILES ---
                    // F) Enter en campo "Agregar Nuevo Perfil" ‚Üí Crea el perfil
                    const inputNuevoPerfil = document.getElementById('nombre-nuevo-perfil-selector');
                    if (inputNuevoPerfil) {
                        inputNuevoPerfil.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                inputNuevoPerfil.blur(); // Cierra teclado

                                // Ejecutar la funci√≥n de crear perfil
                                UILogic.crearPerfilDesdeSelector();
                            }
                        });
                    }

                    // G) Enter en campo "Editar Perfil" ‚Üí Guarda cambios
                    const inputEditarPerfil = document.getElementById('nombre-perfil-editar');
                    if (inputEditarPerfil) {
                        inputEditarPerfil.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                inputEditarPerfil.blur(); // Cierra teclado

                                const btnGuardarPerfil = document.querySelector('#modal-editar-perfil .btn-edit');
                                if (btnGuardarPerfil && !btnGuardarPerfil.disabled) {
                                    btnGuardarPerfil.click(); // Ejecuta guardar perfil
                                }
                            }
                        });
                    }

                    // ===================================

                    // CARGAR CONFIGURACI√ìN
                    const config = D.cargarConfiguracion();
                    const temaOscuro = config.temaOscuro;
                    D.setVistaActual(config.vistaActual);

                    const perfilActual = PerfilManager.obtenerDatosPerfil();
                    let diasRaw = perfilActual.diasHabiles;
                    let diasArraySeguro = [1, 2, 3, 4, 5];

                    if (Array.isArray(diasRaw)) {
                        diasArraySeguro = diasRaw;
                    } else if (typeof diasRaw === 'number') {
                        diasArraySeguro = [];
                        for (let i = 1; i <= diasRaw; i++) diasArraySeguro.push(i);
                        if (diasRaw === 7) diasArraySeguro.push(0);
                    }

                    D.setDiasHabiles(diasArraySeguro);
                    D.setHorasDiarias(perfilActual.horasDiarias !== undefined ? perfilActual.horasDiarias : 7);

                    const registrosCargados = perfilActual.registros || [];
                    D.registros().splice(0, D.registros().length, ...registrosCargados);

                    // Cargar historial guardado (si existe y es v√°lido)
                    const historialCargado = HistoryManager.loadFromLocalStorage();

                    if (historialCargado) {
                        // Si se carg√≥ historial v√°lido, restaurar el estado actual de ese historial
                        const estadoActual = HistoryManager.getCurrentState();
                        if (estadoActual && estadoActual.length > 0) {
                            D.registros().splice(0, D.registros().length, ...estadoActual);
                            console.log('‚úì Registros restaurados desde historial');
                        }
                    } else {
                        // Si no hay historial v√°lido, guardar el estado inicial
                        HistoryManager.saveState(D.registros());
                        console.log('‚úì Nuevo historial inicializado');
                    }

                    HistoryManager.updateButtons();

                    // TEMA
                    if (temaOscuro) {
                        document.body.classList.add('dark-mode');
                    }
                    // Restaurar iconos de tema...
                    const toggleBtnEl = $('theme-toggle');
                    if (toggleBtnEl) {
                        const tBtn = toggleBtnEl.querySelector('use');
                        if (tBtn) tBtn.setAttribute('href', temaOscuro ? '#icon-sun' : '#icon-moon');
                    }
                    const toggleBtnModal = $('theme-toggle-modal');
                    if (toggleBtnModal) {
                        const tBtnM = toggleBtnModal.querySelector('use');
                        if (tBtnM) tBtnM.setAttribute('href', temaOscuro ? '#icon-sun' : '#icon-moon');
                    }

                    $('fecha').value = obtenerFechaHoy();

                    // RESTAURAR ESTADO VISUAL
                    try {
                        if (localStorage.getItem('formularioExpandido') === 'true') toggleFormulario();
                        if (localStorage.getItem('statsExpandido') === 'true') toggleStats();

                        // Restaurar estado de Hist√≥rico (3 estados)
                        const estadoHistorico = localStorage.getItem('historicoExpandido');
                        if (estadoHistorico === 'meses' || estadoHistorico === 'completo') {
                            const contenido = $('contenido-historico');
                            const icon = $('icon-indicator-historico');
                            if (contenido) contenido.classList.add('expanded');

                            if (estadoHistorico === 'meses') {
                                // Estado 2: Chevron arriba (180¬∞)
                                if (icon) {
                                    icon.style.transform = '';
                                    icon.classList.add('rotated'); // 180¬∞
                                }
                            } else if (estadoHistorico === 'completo') {
                                // Estado 3: Chevron lateral derecha (90¬∞)
                                const botones = $('botones-historico');
                                if (botones) {
                                    botones.classList.add('expanded');
                                    tiempoExpansionBotones = Date.now();
                                }
                                if (icon) {
                                    icon.classList.remove('rotated');
                                    icon.style.transform = 'rotate(-90deg)'; // 90¬∞
                                }
                            }
                        } else {
                            // Estado 1: Chevron abajo (0¬∞)
                            const botones = $('botones-historico');
                            const icon = $('icon-indicator-historico');
                            if (botones) botones.classList.remove('expanded');
                            if (icon) {
                                icon.classList.remove('rotated');
                                icon.style.transform = '';
                            }
                        }
                    } catch (e) {
                        console.warn('Error restaurando estado visual:', e);
                    }

                    PWAInstaller.init();

                    actualizarUI();
                    setInterval(() => actualizarUI(null, true), 60000);
                    console.log('Sistema iniciado correctamente');

                    // ===================================
                    // EVENT DELEGATION - LISTA REGISTROS
                    // ===================================
                    const lista = document.getElementById('lista-registros');
                    if (lista) {
                        lista.addEventListener('click', (e) => {
                            // Buscar el elemento clickeado o su ancestro con data-accion
                            const target = e.target.closest('[data-accion]');
                            if (!target) return;

                            const accion = target.dataset.accion;

                            if (accion === 'editar-registro') {
                                const id = target.dataset.registroId;
                                if (id) D.editarRegistro(id);
                            }
                            else if (accion === 'editar-grupo') {
                                try {
                                    const grupoData = JSON.parse(target.dataset.grupoData);
                                    const registrosCompletos = D.registros().filter(r =>
                                        grupoData.registros.includes(r.id)
                                    );

                                    D.editarGrupo({
                                        registros: registrosCompletos,
                                        subtipo: grupoData.subtipo
                                    });
                                } catch (err) {
                                    console.error('Error al abrir grupo:', err);
                                }
                            }
                        });
                    }

                    // ===================================
                    // EVENT DELEGATION - TOGGLE MESES
                    // ===================================
                    lista.addEventListener('click', (e) => {
                        const header = e.target.closest('.registro-mes-header');
                        if (!header || header.dataset.accion !== 'toggle-mes') return;

                        e.stopPropagation();

                        const contenedor = header.closest('.registro-mes-container');
                        if (!contenedor) return;

                        const detalle = contenedor.querySelector('.registro-mes-detalle');
                        const chevronIcon = header.querySelector('.chevron-mes');

                        const estaExpandido = detalle.classList.contains('expanded');

                        if (estaExpandido) {
                            // CERRAR
                            detalle.classList.remove('expanded');
                            chevronIcon.style.transform = 'rotate(0deg)';

                            // Guardar estado
                            try {
                                localStorage.setItem(`mes-${header.dataset.mesId}-expandido`, 'false');
                            } catch (e) { }

                        } else {
                            // ABRIR
                            const otrosMesesAbiertos = lista.querySelectorAll('.registro-mes-detalle.expanded');
                            const hayOtrosAbiertos = Array.from(otrosMesesAbiertos).some(otro => otro !== detalle);

                            if (hayOtrosAbiertos) {
                                // Calcular y reservar altura antes de cerrar
                                otrosMesesAbiertos.forEach(otroDetalle => {
                                    if (otroDetalle !== detalle) {
                                        const alturaActual = otroDetalle.scrollHeight;

                                        // Fijar altura actual como m√≠nima temporalmente
                                        otroDetalle.style.minHeight = `${alturaActual}px`;

                                        // Cerrar visualmente
                                        otroDetalle.classList.remove('expanded');
                                        const otroContainer = otroDetalle.closest('.registro-mes-container');
                                        const otroChevron = otroContainer?.querySelector('.chevron-mes');
                                        const otroHeader = otroContainer?.querySelector('.registro-mes-header');

                                        if (otroChevron) otroChevron.style.transform = 'rotate(0deg)';

                                        // Guardar que se cerr√≥
                                        if (otroHeader && otroHeader.dataset.mesId) {
                                            try {
                                                localStorage.setItem(`mes-${otroHeader.dataset.mesId}-expandido`, 'false');
                                            } catch (e) { }
                                        }

                                        // Liberar la altura despu√©s de la animaci√≥n
                                        setTimeout(() => {
                                            otroDetalle.style.minHeight = '';
                                        }, 350);
                                    }
                                });

                                setTimeout(() => {
                                    detalle.classList.add('expanded');
                                    chevronIcon.style.transform = 'rotate(180deg)';

                                    // Guardar que se abri√≥
                                    try {
                                        localStorage.setItem(`mes-${header.dataset.mesId}-expandido`, 'true');
                                    } catch (e) { }

                                    // Scroll inteligente
                                    setTimeout(() => {
                                        const margenHeader = 80;
                                        const alturaVentana = window.innerHeight;
                                        const registros = detalle.querySelectorAll('.registro-item');

                                        if (registros.length > 0) {
                                            const primerRegistro = registros[0];
                                            const rectPrimero = primerRegistro.getBoundingClientRect();
                                            const segundoRegistro = registros.length > 1 ? registros[1] : null;
                                            const rectSegundo = segundoRegistro ? segundoRegistro.getBoundingClientRect() : null;

                                            const primeroCortado = rectPrimero.top < margenHeader || rectPrimero.bottom > alturaVentana;
                                            const segundoCortado = rectSegundo && (rectSegundo.top < margenHeader || rectSegundo.bottom > alturaVentana);

                                            if (primeroCortado || segundoCortado) {
                                                contenedor.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                            }
                                        }
                                    }, 310);
                                }, 300);

                            } else {
                                // No hay otros meses abiertos
                                detalle.classList.add('expanded');
                                chevronIcon.style.transform = 'rotate(180deg)';

                                // Guardar que se abri√≥
                                try {
                                    localStorage.setItem(`mes-${header.dataset.mesId}-expandido`, 'true');
                                } catch (e) { }

                                // Scroll inteligente
                                setTimeout(() => {
                                    const margenHeader = 80;
                                    const alturaVentana = window.innerHeight;
                                    const registros = detalle.querySelectorAll('.registro-item');

                                    if (registros.length > 0) {
                                        const primerRegistro = registros[0];
                                        const rectPrimero = primerRegistro.getBoundingClientRect();
                                        const segundoRegistro = registros.length > 1 ? registros[1] : null;
                                        const rectSegundo = segundoRegistro ? segundoRegistro.getBoundingClientRect() : null;

                                        const primeroCortado = rectPrimero.top < margenHeader || rectPrimero.bottom > alturaVentana;
                                        const segundoCortado = rectSegundo && (rectSegundo.top < margenHeader || rectSegundo.bottom > alturaVentana);

                                        if (primeroCortado || segundoCortado) {
                                            contenedor.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                        }
                                    }
                                }, 310);
                            }
                        }
                    });

                    // Listeners Lote
                    const loteDesde = document.getElementById('lote-fecha-desde');
                    const loteHasta = document.getElementById('lote-fecha-hasta');
                    const actualizarBotonLoteDebounced = debounce(actualizarBotonLote, 300);

                    const agregarListenersFecha = (el) => {
                        if (!el) return;
                        el.addEventListener('change', () => actualizarBotonLote()); // Inmediato
                        el.addEventListener('input', () => actualizarBotonLoteDebounced()); // Debounced
                    };
                    agregarListenersFecha(loteDesde);
                    agregarListenersFecha(loteHasta);

                    // Listener para mostrar/ocultar campos de rango en exportaci√≥n
                    const tipoExportSelect = document.getElementById('tipo-exportacion');
                    if (tipoExportSelect) {
                        tipoExportSelect.addEventListener('change', () => {
                            UILogic.toggleCamposRangoExport();
                        });
                    }
                    // Listener para mostrar nombre de archivo seleccionado
                    const fileInput = document.getElementById('file-import');
                    if (fileInput) {
                        fileInput.addEventListener('change', (e) => {
                            const nombreEl = document.getElementById('nombre-archivo-seleccionado');
                            const btnCombinar = document.getElementById('btn-combinar');
                            const btnReemplazar = document.getElementById('btn-reemplazar');

                            if (e.target.files.length > 0) {
                                // Mostrar nombre del archivo
                                if (nombreEl) {
                                    const nombreArchivo = e.target.files[0].name;
                                    nombreEl.textContent = `‚úì ${nombreArchivo}`;
                                    nombreEl.style.display = 'block';
                                }

                                // Habilitar botones
                                if (btnCombinar) {
                                    btnCombinar.disabled = false;
                                    btnCombinar.style.opacity = '1';
                                }
                                if (btnReemplazar) {
                                    btnReemplazar.disabled = false;
                                    btnReemplazar.style.opacity = '1';
                                }
                            } else {
                                // Si se cancela la selecci√≥n, ocultar y deshabilitar
                                if (nombreEl) {
                                    nombreEl.style.display = 'none';
                                    nombreEl.textContent = '';
                                }
                                if (btnCombinar) {
                                    btnCombinar.disabled = true;
                                    btnCombinar.style.opacity = '0.5';
                                }
                                if (btnReemplazar) {
                                    btnReemplazar.disabled = true;
                                    btnReemplazar.style.opacity = '0.5';
                                }
                            }
                        });
                    }
                }

                function mostrarFiltros() {
                    // Si hay filtro activo, limpiarlo directamente
                    if (D.obtenerRegistrosFiltrados().length !== D.registros().length) {
                        D.limpiarFiltros();
                        return;
                    }

                    // Si no hay filtro, mostrar modal
                    ModalManager.abrir('modal-filtros');
                }

                function cerrarFiltros() {
                    ModalManager.cerrar('modal-filtros');
                }

                // --- FUNCI√ìN GEN√âRICA PARA COLAPSABLES ---
                function toggleSeccionGen(elementId, iconId, storageKey, callback = null) {
                    const el = $(elementId);
                    const icon = $(iconId);

                    if (!el) return;

                    el.classList.toggle('expanded');
                    const isExpanded = el.classList.contains('expanded');

                    if (icon) {
                        if (isExpanded) icon.classList.add('rotated');
                        else icon.classList.remove('rotated');
                    }

                    try { localStorage.setItem(storageKey, isExpanded); } catch (e) { }

                    // Ejecutar l√≥gica extra si es necesario (ej: cargar stats)
                    if (isExpanded && callback) callback();
                }

                function toggleFormulario() {
                    const el = $('form-registro');
                    const estabaExpandido = el.classList.contains('expanded');

                    // 1. Ejecuta la animaci√≥n visual de contraer/expandir
                    toggleSeccionGen('form-registro', 'icon-indicator-form', 'formularioExpandido');

                    // 2. Si la tarjeta estaba abierta y ahora se est√° cerrando...
                    if (estabaExpandido) {

                        // --- Limpieza de Modo Normal ---
                        $('entrada').value = '';
                        $('salida').value = '';
                        $('fecha').value = obtenerFechaHoy(); // Resetea la fecha a hoy

                        // --- Limpieza de Modo Lote ---
                        const loteDesde = $('lote-fecha-desde');
                        const loteHasta = $('lote-fecha-hasta');
                        const loteTipo = $('lote-tipo');

                        if (loteDesde) loteDesde.value = '';
                        if (loteHasta) loteHasta.value = '';
                        if (loteTipo) loteTipo.value = 'feriado'; // Vuelve al valor por defecto

                        // 3. Si estaba activo el modo lote, resetearlo al modo normal
                        if (modoLoteActivo) {
                            toggleModoLote();
                        } else {
                            // Si ya estaba en modo normal, refrescamos el estado del bot√≥n principal
                            actualizarEstadoBotonTimerMain();
                        }
                    }
                }

                function toggleHistorico() {
                    cancelarTimerAutoCierreBotones();

                    const contenido = $('contenido-historico');
                    const botones = $('botones-historico');
                    const icon = $('icon-indicator-historico');


                    if (!contenido) return;

                    const contenidoExpandido = contenido.classList.contains('expanded');
                    const botonesExpandidos = botones.classList.contains('expanded');

                    try {
                        if (!contenidoExpandido) {
                            // ESTADO 1 ‚Üí ESTADO 2: Abrir meses (chevron a 180¬∞)
                            contenido.classList.add('expanded');
                            if (icon) {
                                icon.style.transform = ''; // Resetear inline
                                icon.classList.add('rotated'); // 180¬∞ arriba
                            }
                            localStorage.setItem('historicoExpandido', 'meses');
                            tiempoExpansionBotones = null;

                        } else if (contenidoExpandido && !botonesExpandidos) {
                            // ESTADO 2 ‚Üí ESTADO 3: Mostrar botones (chevron a 90¬∞)
                            botones.classList.add('expanded');
                            if (icon) {
                                icon.classList.remove('rotated'); // Quitar 180¬∞
                                icon.style.transform = 'rotate(-90deg)'; // Lateral derecha
                            }
                            localStorage.setItem('historicoExpandido', 'completo');
                            tiempoExpansionBotones = Date.now();

                        } else {
                            // ESTADO 3 ‚Üí Verificar tiempo
                            const tiempoTranscurrido = Date.now() - (tiempoExpansionBotones || 0);
                            const history_toggle_timer = tiempoTranscurrido > 500;

                            if (history_toggle_timer) {
                                // Solo ocultar botones (3 ‚Üí 2, chevron a 180¬∞)
                                botones.classList.remove('expanded');
                                if (icon) {
                                    icon.style.transform = ''; // Resetear inline
                                    icon.classList.add('rotated'); // Volver a 180¬∞
                                }
                                localStorage.setItem('historicoExpandido', 'meses');
                                tiempoExpansionBotones = null;
                            } else {
                                // Cerrar todo (3 ‚Üí 1, chevron a 0¬∞)
                                botones.classList.remove('expanded');
                                contenido.classList.remove('expanded');
                                if (icon) {
                                    icon.classList.remove('rotated'); // Quitar clase
                                    icon.style.transform = ''; // Resetear a 0¬∞ (abajo)
                                }
                                localStorage.setItem('historicoExpandido', 'cerrado');
                                tiempoExpansionBotones = null;
                            }
                        }
                    } catch (e) {
                        console.warn('Error guardando estado hist√≥rico:', e);
                    }
                }

                function iniciarTimerAutoCierreBotones() {
                    // Limpiar timer anterior si existe
                    if (timerAutoCierreBotones) {
                        clearTimeout(timerAutoCierreBotones);
                        timerAutoCierreBotones = null;
                    }

                    // Iniciar nuevo timer de 5 segundos
                    timerAutoCierreBotones = setTimeout(() => {
                        const botones = $('botones-historico');
                        const contenido = $('contenido-historico');
                        const icon = $('icon-indicator-historico');

                        // Solo cerrar si est√°n expandidos
                        if (botones && botones.classList.contains('expanded')) {
                            // ESTADO 3 ‚Üí ESTADO 2 (Solo ocultar botones)
                            botones.classList.remove('expanded');

                            if (icon) {
                                icon.style.transform = ''; // Resetear inline
                                icon.classList.add('rotated'); // Volver a 180¬∞
                            }

                            try {
                                localStorage.setItem('historicoExpandido', 'meses');
                            } catch (e) {
                                console.warn('Error guardando estado hist√≥rico:', e);
                            }

                            tiempoExpansionBotones = null;
                        }

                        timerAutoCierreBotones = null;
                    }, 3000); // 3 segundos timer autocierre
                }

                function cancelarTimerAutoCierreBotones() {
                    if (timerAutoCierreBotones) {
                        clearTimeout(timerAutoCierreBotones);
                        timerAutoCierreBotones = null;
                    }
                }

                function toggleStats() {
                    toggleSeccionGen('form-stats', 'icon-indicator-stats', 'statsExpandido', () => {
                        // L√≥gica espec√≠fica de stats al abrir
                        poblarSelectorMeses();
                        const selectMes = $('select-mes-stats');
                        if (selectMes && selectMes.value) {
                            actualizarEstadisticas(selectMes.value);
                        } else {
                            actualizarEstadisticas();
                        }
                    });
                }

                function alternarFechaActual(id) {
                    const c = document.getElementById(id);
                    if (!c) return;

                    // Si tiene datos, limpiar. Si est√° vac√≠o, poner hoy.
                    if (c.value.trim() !== '') {
                        c.value = '';
                    } else {
                        c.value = obtenerFechaHoy();
                    }

                    // Actualizar el estado del bot√≥n principal
                    actualizarBotonLote();
                }

                function verificarBloqueoCredito() {
                    const btnCredito = document.getElementById('btn-toggle-credito');
                    if (!btnCredito) return; // Seguridad

                    // 1. Verificamos estado del candado global
                    const bloqueoGlobal = document.getElementById('edit-fecha').disabled;

                    // 2. Obtenemos valores
                    const e = document.getElementById('edit-entrada').value.trim();
                    const s = document.getElementById('edit-salida').value.trim();

                    // 3. Validamos que el horario est√© VISUALMENTE completo (5 caracteres: HH:MM)
                    const horarioCompleto = e.length === 5 && s.length === 5;

                    // 4. Detectamos si son d√≠as especiales (para bloquear tambi√©n)
                    const esEspecial = TiposRegistro.esRegistroEspecial(e, s);

                    // Si hay candado O es d√≠a especial O el horario NO est√° completo...
                    if (bloqueoGlobal || esEspecial || !horarioCompleto) {
                        // ... APAGAMOS EL BOT√ìN
                        btnCredito.disabled = true;
                        btnCredito.style.opacity = '0.5';
                        btnCredito.style.cursor = 'not-allowed';

                        // Si el usuario borra la hora, visualmente desactivamos el toggle verde para no confundir
                        if (!horarioCompleto && btnCredito.dataset.activo === "true") {
                            toggleCredito(); // Esto lo vuelve gris autom√°ticamente
                        }
                    } else {
                        // ... HABILITAMOS EL BOT√ìN
                        btnCredito.disabled = false;
                        btnCredito.style.opacity = '1';
                        btnCredito.style.cursor = 'pointer';
                    }
                }

                function setBloqueoEdicionGrupo(bloqueado) {
                    edicionGrupoBloqueada = bloqueado;

                    const btnLock = $('btn-lock-grupo-toggle');
                    if (btnLock) {
                        const icon = btnLock.querySelector('use');
                        icon.setAttribute('href', bloqueado ? '#icon-lock' : '#icon-lock-open');
                        btnLock.title = bloqueado ? "Desbloquear edici√≥n" : "Bloquear edici√≥n";
                        btnLock.style.color = bloqueado ? 'var(--c-red)' : 'var(--text-main)';
                    }

                    const inputs = ['edit-grupo-tipo', 'edit-grupo-desde', 'edit-grupo-hasta'];
                    inputs.forEach(id => {
                        const el = $(id);
                        if (el) el.disabled = bloqueado;
                    });

                    const modal = $('modal-editar-grupo');
                    if (modal) {
                        const botones = modal.querySelectorAll('button:not(#btn-lock-grupo-toggle):not(.btn-cancel)');
                        botones.forEach(btn => {
                            btn.disabled = bloqueado;
                        });
                    }
                }

                function toggleBloqueoEdicionGrupo() {
                    setBloqueoEdicionGrupo(!edicionGrupoBloqueada);
                }

                function cerrarEdicionGrupo() {
                    ModalManager.cerrar('modal-editar-grupo', () => {
                        D.setGrupoEnEdicion(null);
                    });
                }

                function aplicarFeedbackRegistro(mostrarEntrada, mostrarSalida) {
                    const inputEntrada = $('entrada');
                    const inputSalida = $('salida');

                    const labelEntrada = inputEntrada?.closest('.form-group')?.querySelector('label');
                    const labelSalida = inputSalida?.closest('.form-group')?.querySelector('label');

                    // Guardar textos originales
                    const textoOriginalEntrada = labelEntrada ? labelEntrada.textContent : 'Entrada';
                    const textoOriginalSalida = labelSalida ? labelSalida.textContent : 'Salida';

                    // Funci√≥n helper para animar cambio de texto
                    const cambiarTextoSuave = (label, nuevoTexto, color) => {
                        if (!label) return;

                        // Fade out
                        label.style.opacity = '0';
                        label.style.transform = 'translateY(-3px)';

                        setTimeout(() => {
                            label.textContent = nuevoTexto;
                            label.style.color = color;
                            // Fade in
                            label.style.opacity = '1';
                            label.style.transform = 'translateY(0)';
                        }, 150); // Mitad del tiempo de transici√≥n
                    };

                    if (mostrarEntrada && inputEntrada && labelEntrada) {
                        inputEntrada.classList.add('input-agregado-animacion');
                        cambiarTextoSuave(labelEntrada, '‚úì Agregado', 'var(--c-green)');
                    }

                    if (mostrarSalida && inputSalida && labelSalida) {
                        inputSalida.classList.add('input-agregado-animacion');
                        cambiarTextoSuave(labelSalida, '‚úì Agregado', 'var(--c-green)');
                    }

                    // Remover despu√©s de 2 segundos
                    setTimeout(() => {
                        if (mostrarEntrada && inputEntrada && labelEntrada) {
                            inputEntrada.classList.remove('input-agregado-animacion');
                            cambiarTextoSuave(labelEntrada, textoOriginalEntrada, '');
                        }

                        if (mostrarSalida && inputSalida && labelSalida) {
                            inputSalida.classList.remove('input-agregado-animacion');
                            cambiarTextoSuave(labelSalida, textoOriginalSalida, '');
                        }
                    }, 2000);
                }

                return {
                    init, obtenerFechaHoy, pegarHoraActual, alternarTema, alternarVista, cerrarConfig,
                    cerrarEdicion, mostrarImportar, cerrarImportar, actualizarUI, mostrarToast, mostrarError,
                    limpiarError, resetearBoton, restaurarBotonGuardarEdicion, toggleFormulario,
                    limpiarCampo, mostrarFiltros, cerrarFiltros, registrarLoteDesdeCard,
                    cambiarMesStats, generarReporte, toggleHistorico, toggleStats, sumarMinutosAHora,
                    toggleTimerBreakMain, actualizarEstadoBotonTimerMain, toggleBloqueoEdicion, setBloqueoEdicion,
                    actualizarFeedbackConfig, poblarSelectorMeses, abrirSelectorPerfiles, actualizarBotonLote,
                    cerrarSelectorPerfiles, abrirEditorPerfil, cerrarEditorPerfil, guardarEdicionPerfil, toggleModoLote,
                    eliminarPerfilDesdeEditor, crearPerfilDesdeSelector, renderizarListaPerfiles, ejecutarAccionRegistro,
                    iniciarCambioHoras, detenerCambio, mostrarconfig, alternarFechaActual, verificarBloqueoCredito,
                    toggleCredito, setBloqueoEdicionGrupo, toggleBloqueoEdicionGrupo, cerrarEdicionGrupo,
                    mostrarExportar, cerrarExportar, ejecutarExportacion, toggleCamposRangoExport, aplicarFeedbackRegistro,
                    iniciarTimerAutoCierreBotones, cancelarTimerAutoCierreBotones
                };

            })(SecurityAndUtils, DataManagement);

            UILogic.init();
        })();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('SW registrado:', registration.scope);
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // L√≥gica visual para avisar al usuario
                                    if (window.UILogic) UILogic.mostrarToast('Nueva versi√≥n disponible. Recarga la p√°gina.', 'info');
                                }
                            });
                        });
                    })
                    .catch(err => console.error('‚ùå Error SW:', err));
            });
        }
    </script>
</body>

</html>

<!--// ====================================================================
    //                 NOTAS SISTEMA LUSHIBOSCA VERSION 7.34
    // ====================================================================
    
     - CAMBIOS:
    1) Se cambia la paleta de colores
    2) minima refactorizacion en scroollbar


     - BUGS MENORES CONOCIDOS:
     1) al tener un registro con entrada y luego agregar una salida, deshacer la accion
     y tocar el timer, al rehacer la accion, el timer sigue corriendo
     2) al borrar un lote el boton detecta muy rapido los cambios produciendo un cambio
     repentino del estado en la etiqueta pasando de por ejemplo borrar - sin registros - registrar,
     el flujo correcto seria borrar - registrar luego de ejecutar la accion
     3) pulsar deliberadamente undo y redo de forma reiterada mas de 20 veces aproximadamente,
     la interfaz deja de mostrar los cambios hasta que se actualiza la pagina
     4) en la tarjeta de estadisticas, la semana pasada se muestra solamente, si existen
     registros regulares en la semana actual, si hay registros especiales, el item semana pasada 
     no muestra datos

     - IDEAS DESCARTADAS/REVISION:
     1) Registro especial "ausencia sin justificar" a revisar
     

    -->
